<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f0f1a">
    <title>GTD - Shreyas</title>
    <link rel="manifest" href="manifest.json">
    <script src="data.js"></script>
    <style>
:root {
  --bg: #0f0f1a; --card: #1a1a2e; --card2: #252540;
  --text: #fff; --text2: #a0a0b0; --text3: #666;
  --accent: #4ecdc4; --accent2: #45b7aa;
  --critical: #ff6b6b; --high: #ffa94d; --medium: #ffd93d; --low: #6bcb77;
  --pro: #4a90a4; --personal: #9b59b6;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; line-height: 1.4; }
.app { max-width: 900px; margin: 0 auto; padding-bottom: 70px; }

/* Header */
.header { background: linear-gradient(135deg, var(--card) 0%, var(--card2) 100%); padding: 16px; position: sticky; top: 0; z-index: 100; }
.header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
.logo { font-size: 1.4rem; font-weight: 700; }
.logo span { color: var(--accent); }
.header-actions { display: flex; gap: 8px; }
.icon-btn { width: 36px; height: 36px; border-radius: 50%; border: none; background: var(--card2); color: var(--text); font-size: 1.1rem; cursor: pointer; }

/* Stats Row */
.stats { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; }
.stat { background: var(--card2); border-radius: 8px; padding: 10px 6px; text-align: center; }
.stat-val { font-size: 1.3rem; font-weight: 700; }
.stat-val.critical { color: var(--critical); }
.stat-val.high { color: var(--high); }
.stat-val.accent { color: var(--accent); }
.stat-lbl { font-size: 0.65rem; color: var(--text2); text-transform: uppercase; letter-spacing: 0.5px; }

/* Filters */
.filters { padding: 12px 16px; background: var(--card); border-bottom: 1px solid var(--card2); }
.filter-row { display: flex; gap: 8px; margin-bottom: 10px; overflow-x: auto; -webkit-overflow-scrolling: touch; padding-bottom: 4px; }
.filter-row::-webkit-scrollbar { display: none; }
.chip { padding: 6px 12px; border-radius: 16px; border: 1px solid var(--card2); background: transparent; color: var(--text2); font-size: 0.8rem; white-space: nowrap; cursor: pointer; transition: all 0.2s; }
.chip:hover, .chip.active { background: var(--accent); color: #000; border-color: var(--accent); }
.chip.critical { border-color: var(--critical); }
.chip.critical.active { background: var(--critical); }
.chip.high { border-color: var(--high); }
.chip.high.active { background: var(--high); }

/* Search & Sort */
.search-sort { display: flex; gap: 8px; }
.search-box { flex: 1; position: relative; }
.search-box input { width: 100%; padding: 10px 10px 10px 36px; border: 1px solid var(--card2); border-radius: 8px; background: var(--bg); color: var(--text); font-size: 0.95rem; }
.search-box::before { content: 'üîç'; position: absolute; left: 10px; top: 50%; transform: translateY(-50%); font-size: 0.9rem; }
.sort-btn { padding: 10px 12px; border: 1px solid var(--card2); border-radius: 8px; background: var(--bg); color: var(--text2); font-size: 0.85rem; cursor: pointer; }

/* Item Cards */
.items { padding: 8px; }
.item-group { margin-bottom: 16px; }
.group-header { display: flex; align-items: center; gap: 8px; padding: 8px 12px; color: var(--text2); font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
.group-header::after { content: ''; flex: 1; height: 1px; background: var(--card2); }
.group-count { background: var(--card2); padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; }

.item { background: var(--card); border-radius: 12px; padding: 14px; margin-bottom: 8px; display: flex; gap: 12px; transition: all 0.2s; }
.item:active { transform: scale(0.98); }
.item.completed { opacity: 0.5; }
.item.completed .item-title { text-decoration: line-through; }

.priority-bar { width: 4px; border-radius: 2px; flex-shrink: 0; }
.priority-bar.critical { background: var(--critical); }
.priority-bar.high { background: var(--high); }
.priority-bar.medium { background: var(--medium); }
.priority-bar.low { background: var(--low); }

.item-main { flex: 1; min-width: 0; }
.item-top { display: flex; justify-content: space-between; align-items: flex-start; gap: 8px; margin-bottom: 6px; }
.item-title { font-weight: 500; font-size: 0.95rem; }
.item-badges { display: flex; gap: 4px; flex-shrink: 0; }
.badge { padding: 2px 6px; border-radius: 4px; font-size: 0.65rem; font-weight: 600; }
.badge.pro { background: var(--pro); }
.badge.personal { background: var(--personal); }
.badge.status { background: var(--card2); color: var(--text2); }

.item-meta { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 8px; }
.meta-tag { display: flex; align-items: center; gap: 3px; font-size: 0.75rem; color: var(--text2); background: var(--bg); padding: 3px 8px; border-radius: 4px; }
.meta-tag.project { color: var(--accent); }

.item-details { font-size: 0.8rem; color: var(--text3); }
.item-details span { margin-right: 12px; }

.item-actions { display: flex; flex-direction: column; gap: 6px; }
.act-btn { width: 32px; height: 32px; border-radius: 8px; border: none; font-size: 0.9rem; cursor: pointer; }
.act-btn.done { background: var(--low); }
.act-btn.del { background: var(--critical); }

/* FAB */
.fab { position: fixed; bottom: 80px; right: 20px; width: 56px; height: 56px; border-radius: 50%; background: linear-gradient(135deg, var(--accent), var(--accent2)); border: none; color: #000; font-size: 1.8rem; cursor: pointer; box-shadow: 0 4px 20px rgba(78,205,196,0.4); z-index: 100; }

/* Bottom Nav */
.nav { position: fixed; bottom: 0; left: 0; right: 0; background: var(--card); border-top: 1px solid var(--card2); display: flex; justify-content: space-around; padding: 8px 0; padding-bottom: max(8px, env(safe-area-inset-bottom)); }
.nav-btn { background: none; border: none; color: var(--text3); font-size: 0.7rem; text-align: center; padding: 4px 16px; cursor: pointer; }
.nav-btn.active { color: var(--accent); }
.nav-btn span { display: block; font-size: 1.2rem; margin-bottom: 2px; }

/* Modal */
.modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 200; align-items: flex-end; justify-content: center; }
.modal.open { display: flex; }
.modal-content { background: var(--card); border-radius: 20px 20px 0 0; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto; padding: 20px; animation: slideUp 0.3s ease; }
@keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
.modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
.modal-title { font-size: 1.1rem; font-weight: 600; }
.close-btn { width: 32px; height: 32px; border-radius: 50%; border: none; background: var(--card2); color: var(--text); font-size: 1.2rem; cursor: pointer; }

/* Form */
.form-group { margin-bottom: 14px; }
.form-label { display: block; font-size: 0.8rem; color: var(--text2); margin-bottom: 6px; }
.form-input, .form-select { width: 100%; padding: 12px; border: 1px solid var(--card2); border-radius: 8px; background: var(--bg); color: var(--text); font-size: 1rem; }
.form-select { appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23a0a0b0'%3E%3Cpath d='M6 8L1 3h10z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; }
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.submit-btn { width: 100%; padding: 14px; background: var(--accent); border: none; border-radius: 10px; color: #000; font-size: 1rem; font-weight: 600; cursor: pointer; margin-top: 8px; }

/* Voice */
.voice-section { text-align: center; padding: 20px 0; }
.mic-btn { width: 80px; height: 80px; border-radius: 50%; border: none; background: linear-gradient(145deg, var(--critical), #e55555); color: white; font-size: 2rem; cursor: pointer; box-shadow: 0 8px 25px rgba(255,107,107,0.3); transition: all 0.3s; }
.mic-btn.listening { background: linear-gradient(145deg, var(--accent), var(--accent2)); animation: pulse 1.5s infinite; }
@keyframes pulse { 0%,100% { box-shadow: 0 0 0 0 rgba(78,205,196,0.5); } 50% { box-shadow: 0 0 0 15px rgba(78,205,196,0); } }
.transcript { margin-top: 16px; padding: 14px; background: var(--bg); border-radius: 10px; min-height: 50px; font-size: 1rem; }

/* Views */
.view { display: none; }
.view.active { display: block; }

/* Settings */
.settings-section { background: var(--card); border-radius: 12px; padding: 16px; margin: 8px 16px 16px; }
.settings-title { font-size: 0.9rem; font-weight: 600; margin-bottom: 12px; color: var(--text2); }
.settings-btn { width: 100%; padding: 14px; margin-bottom: 8px; background: var(--card2); border: none; border-radius: 10px; color: var(--text); font-size: 0.95rem; cursor: pointer; text-align: left; display: flex; align-items: center; gap: 12px; }
.settings-btn span { font-size: 1.3rem; }
.settings-btn.danger { background: rgba(255,107,107,0.15); color: var(--critical); border: 1px solid var(--critical); }

/* Toast */
.toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--accent); color: #000; padding: 12px 24px; border-radius: 10px; font-weight: 500; transition: transform 0.3s; z-index: 300; }
.toast.show { transform: translateX(-50%) translateY(0); }

/* Detail Modal */
.detail-section { margin-bottom: 16px; }
.detail-label { font-size: 0.75rem; color: var(--text3); text-transform: uppercase; margin-bottom: 4px; }
.detail-value { font-size: 0.95rem; color: var(--text); }
.detail-tags { display: flex; flex-wrap: wrap; gap: 6px; }
.detail-tag { padding: 6px 12px; border-radius: 6px; font-size: 0.85rem; }
.detail-tag.priority { font-weight: 600; }
.detail-actions { display: flex; gap: 10px; margin-top: 20px; }
.detail-btn { flex: 1; padding: 12px; border: none; border-radius: 10px; font-size: 0.95rem; cursor: pointer; }
.detail-btn.complete { background: var(--low); color: #000; }
.detail-btn.delete { background: var(--critical); color: #fff; }
    </style>
</head>
<body>
<div class="app">
    <!-- Header -->
    <header class="header">
        <div class="header-top">
            <div class="logo">üéØ <span>GTD</span></div>
            <div class="header-actions">
                <button class="icon-btn" onclick="showModal('add')">‚ûï</button>
            </div>
        </div>
        <div class="stats">
            <div class="stat"><div class="stat-val" id="s-total">-</div><div class="stat-lbl">Total</div></div>
            <div class="stat"><div class="stat-val critical" id="s-critical">-</div><div class="stat-lbl">Critical</div></div>
            <div class="stat"><div class="stat-val high" id="s-high">-</div><div class="stat-lbl">High</div></div>
            <div class="stat"><div class="stat-val accent" id="s-actions">-</div><div class="stat-lbl">Actions</div></div>
            <div class="stat"><div class="stat-val" id="s-waiting">-</div><div class="stat-lbl">Waiting</div></div>
        </div>
    </header>

    <!-- List View -->
    <div class="view active" id="v-list">
        <div class="filters">
            <div class="filter-row" id="status-filters">
                <button class="chip active" data-f="all">All</button>
                <button class="chip" data-f="Next Action">Next Actions</button>
                <button class="chip" data-f="Project">Projects</button>
                <button class="chip" data-f="Waiting For">Waiting For</button>
                <button class="chip" data-f="Recurring">Recurring</button>
                <button class="chip" data-f="Someday/Maybe">Someday</button>
            </div>
            <div class="filter-row" id="priority-filters">
                <button class="chip critical" data-p="Critical">üî¥ Critical</button>
                <button class="chip high" data-p="High">üü† High</button>
                <button class="chip" data-p="Medium">üü° Medium</button>
                <button class="chip" data-p="Low">üü¢ Low</button>
            </div>
            <div class="filter-row" id="category-filters">
                <button class="chip" data-c="Professional">üíº Work</button>
                <button class="chip" data-c="Personal">üè† Personal</button>
            </div>
            <div class="search-sort">
                <div class="search-box"><input type="text" id="search" placeholder="Search items, projects..."></div>
                <button class="sort-btn" id="sort-btn">‚ÜïÔ∏è Priority</button>
            </div>
        </div>
        <div class="items" id="items-list"></div>
    </div>

    <!-- Capture View -->
    <div class="view" id="v-capture">
        <div style="padding:16px;">
            <div class="voice-section">
                <button class="mic-btn" id="mic-btn">üé§</button>
                <div class="transcript" id="transcript">Tap microphone and speak...</div>
            </div>
            <div id="parsed-form" style="display:none;">
                <div style="background:var(--card);border-radius:12px;padding:16px;margin-top:16px;">
                    <div class="form-group"><label class="form-label">Item</label><input class="form-input" id="pf-item"></div>
                    <div class="form-row">
                        <div class="form-group"><label class="form-label">Priority</label>
                            <select class="form-select" id="pf-priority"><option value="Critical">üî¥ Critical</option><option value="High">üü† High</option><option value="Medium" selected>üü° Medium</option><option value="Low">üü¢ Low</option></select>
                        </div>
                        <div class="form-group"><label class="form-label">Status</label>
                            <select class="form-select" id="pf-status"><option value="Next Action">Next Action</option><option value="Project">Project</option><option value="Waiting For">Waiting For</option><option value="Someday/Maybe">Someday/Maybe</option></select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label class="form-label">Category</label>
                            <select class="form-select" id="pf-category"><option value="Personal">Personal</option><option value="Professional">Professional</option></select>
                        </div>
                        <div class="form-group"><label class="form-label">Context</label>
                            <select class="form-select" id="pf-context"><option value="@Anywhere">@Anywhere</option><option value="@Computer">@Computer</option><option value="@Phone">@Phone</option><option value="@Office">@Office</option><option value="@Home">@Home</option><option value="@Errands">@Errands</option><option value="@Thinking">@Thinking</option></select>
                        </div>
                    </div>
                    <div class="form-group"><label class="form-label">Project</label><input class="form-input" id="pf-project" placeholder="e.g., World Bank Group"></div>
                    <button class="submit-btn" onclick="saveFromVoice()">‚úì Add Item</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Projects View -->
    <div class="view" id="v-projects">
        <div style="padding:16px;">
            <h2 style="margin-bottom:16px;">üìä Projects Overview</h2>
            <div id="projects-list"></div>
        </div>
    </div>

    <!-- Settings View -->
    <div class="view" id="v-settings">
        <div class="settings-section">
            <div class="settings-title">üì§ Export & Backup</div>
            <button class="settings-btn" onclick="exportJSON()"><span>üíæ</span> Download JSON Backup</button>
            <button class="settings-btn" onclick="exportCSV()"><span>üìä</span> Download CSV (Excel)</button>
            <button class="settings-btn" onclick="document.getElementById('import-file').click()"><span>üì•</span> Import JSON</button>
            <input type="file" id="import-file" accept=".json" style="display:none" onchange="importJSON(this.files[0])">
        </div>
        <div class="settings-section">
            <div class="settings-title">üì± Quick Access</div>
            <button class="settings-btn" onclick="copyLink()"><span>üîó</span> Copy App Link</button>
            <p style="font-size:0.8rem;color:var(--text3);margin-top:8px;">Add to Home Screen for app-like experience</p>
        </div>
        <div class="settings-section">
            <div class="settings-title">‚ö†Ô∏è Danger Zone</div>
            <button class="settings-btn danger" onclick="clearCompleted()">Clear Completed Items</button>
            <button class="settings-btn danger" onclick="resetAll()">Reset All Data</button>
        </div>
        <div style="text-align:center;padding:20px;color:var(--text3);font-size:0.8rem;">
            <p>GTD Voice Capture v2.0</p>
            <p>Shreyas ‚Ä¢ Strategic Innovation Lead</p>
            <p style="margin-top:8px;">101 items captured from GTD trigger list</p>
        </div>
    </div>
</div>

<!-- FAB -->
<button class="fab" onclick="showModal('add')">+</button>

<!-- Bottom Nav -->
<nav class="nav">
    <button class="nav-btn active" data-v="list"><span>üìã</span>Items</button>
    <button class="nav-btn" data-v="capture"><span>üé§</span>Capture</button>
    <button class="nav-btn" data-v="projects"><span>üìä</span>Projects</button>
    <button class="nav-btn" data-v="settings"><span>‚öôÔ∏è</span>Settings</button>
</nav>

<!-- Add Modal -->
<div class="modal" id="modal-add">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">Add New Item</div>
            <button class="close-btn" onclick="closeModal('add')">√ó</button>
        </div>
        <div class="form-group"><label class="form-label">What needs to be done?</label><input class="form-input" id="f-item" placeholder="Enter item..."></div>
        <div class="form-row">
            <div class="form-group"><label class="form-label">Priority</label>
                <select class="form-select" id="f-priority"><option value="Critical">üî¥ Critical</option><option value="High">üü† High</option><option value="Medium" selected>üü° Medium</option><option value="Low">üü¢ Low</option></select>
            </div>
            <div class="form-group"><label class="form-label">Status</label>
                <select class="form-select" id="f-status"><option value="Next Action">Next Action</option><option value="Project">Project</option><option value="Waiting For">Waiting For</option><option value="Someday/Maybe">Someday/Maybe</option><option value="Recurring - Daily">Recurring Daily</option><option value="Recurring - Weekly">Recurring Weekly</option></select>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group"><label class="form-label">Category</label>
                <select class="form-select" id="f-category"><option value="Personal">üè† Personal</option><option value="Professional">üíº Professional</option></select>
            </div>
            <div class="form-group"><label class="form-label">Context</label>
                <select class="form-select" id="f-context"><option value="@Anywhere">@Anywhere</option><option value="@Computer">@Computer</option><option value="@Phone">@Phone</option><option value="@Office">@Office</option><option value="@Home">@Home</option><option value="@Errands">@Errands</option><option value="@Thinking">@Thinking</option><option value="@Reading">@Reading</option></select>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group"><label class="form-label">Project / Area</label><input class="form-input" id="f-project" placeholder="e.g., Riyadh Air"></div>
            <div class="form-group"><label class="form-label">Time Required</label><input class="form-input" id="f-time" placeholder="e.g., 30 min"></div>
        </div>
        <div class="form-row">
            <div class="form-group"><label class="form-label">Energy Level</label>
                <select class="form-select" id="f-energy"><option value="Low">Low</option><option value="Medium" selected>Medium</option><option value="High">High</option></select>
            </div>
            <div class="form-group"><label class="form-label">Waiting For</label><input class="form-input" id="f-waiting" placeholder="Person/thing"></div>
        </div>
        <div class="form-group"><label class="form-label">Notes</label><input class="form-input" id="f-notes" placeholder="Additional details..."></div>
        <button class="submit-btn" onclick="addItem()">‚úì Add Item</button>
    </div>
</div>

<!-- Detail Modal -->
<div class="modal" id="modal-detail">
    <div class="modal-content" id="detail-content"></div>
</div>

<div class="toast" id="toast"></div>

<script>
// State
let items = [];
let filters = { status: 'all', priority: null, category: null, search: '' };
let sortBy = 'priority';

// Init
function init() {
    const stored = localStorage.getItem('gtd_items_v2');
    if (stored) {
        items = JSON.parse(stored);
    } else if (typeof GTD_INITIAL_DATA !== 'undefined') {
        items = GTD_INITIAL_DATA.map((item, i) => ({...item, id: item.id || i + 1}));
        save();
    }
    render();
    updateStats();
    renderProjects();
    setupListeners();
}

function save() { localStorage.setItem('gtd_items_v2', JSON.stringify(items)); }

// Render Items
function render() {
    const container = document.getElementById('items-list');
    let filtered = items.filter(item => {
        if (item.status === 'Completed' && filters.status !== 'Completed') return false;
        if (filters.status !== 'all') {
            if (filters.status === 'Recurring') {
                if (!item.status.includes('Recurring')) return false;
            } else if (item.status !== filters.status) return false;
        }
        if (filters.priority && item.priority !== filters.priority) return false;
        if (filters.category && item.category !== filters.category) return false;
        if (filters.search) {
            const q = filters.search.toLowerCase();
            if (!(item.item||'').toLowerCase().includes(q) && 
                !(item.project||'').toLowerCase().includes(q) &&
                !(item.notes||'').toLowerCase().includes(q)) return false;
        }
        return true;
    });

    const pOrder = {Critical:0, High:1, Medium:2, Low:3};
    if (sortBy === 'priority') {
        filtered.sort((a,b) => (pOrder[a.priority]||4) - (pOrder[b.priority]||4));
    } else if (sortBy === 'project') {
        filtered.sort((a,b) => (a.project||'').localeCompare(b.project||''));
    } else if (sortBy === 'status') {
        filtered.sort((a,b) => (a.status||'').localeCompare(b.status||''));
    }

    if (sortBy === 'project') {
        const groups = {};
        filtered.forEach(item => {
            const key = item.project || 'No Project';
            if (!groups[key]) groups[key] = [];
            groups[key].push(item);
        });
        container.innerHTML = Object.entries(groups).map(([name, items]) => `
            <div class="item-group">
                <div class="group-header">${name} <span class="group-count">${items.length}</span></div>
                ${items.map(renderItem).join('')}
            </div>
        `).join('');
    } else {
        container.innerHTML = filtered.length ? filtered.map(renderItem).join('') : 
            '<p style="text-align:center;color:var(--text3);padding:40px;">No items match filters</p>';
    }
}

function renderItem(item) {
    const statusShort = {
        'Next Action': 'Action', 'Waiting For': 'Waiting', 'Someday/Maybe': 'Someday',
        'Recurring - Daily': 'üîÑ Daily', 'Recurring - Weekly': 'üîÑ Weekly', 
        'Recurring - Monthly': 'üîÑ Monthly', 'Recurring - Quarterly': 'üîÑ Quarterly'
    };
    return `
    <div class="item ${item.status === 'Completed' ? 'completed' : ''}" onclick="showDetail(${item.id})">
        <div class="priority-bar ${(item.priority||'medium').toLowerCase()}"></div>
        <div class="item-main">
            <div class="item-top">
                <div class="item-title">${item.item || 'Untitled'}</div>
                <div class="item-badges">
                    <span class="badge ${item.category === 'Professional' ? 'pro' : 'personal'}">${item.category === 'Professional' ? 'üíº' : 'üè†'}</span>
                </div>
            </div>
            <div class="item-meta">
                ${item.project ? `<span class="meta-tag project">üìÅ ${item.project}</span>` : ''}
                <span class="meta-tag">${item.context || '@Anywhere'}</span>
                <span class="meta-tag">${statusShort[item.status] || item.status}</span>
                ${item.time ? `<span class="meta-tag">‚è± ${item.time}</span>` : ''}
            </div>
            ${item.notes ? `<div class="item-details">${item.notes}</div>` : ''}
        </div>
        <div class="item-actions">
            <button class="act-btn done" onclick="event.stopPropagation();complete(${item.id})">‚úì</button>
        </div>
    </div>`;
}

function updateStats() {
    const active = items.filter(i => i.status !== 'Completed');
    document.getElementById('s-total').textContent = active.length;
    document.getElementById('s-critical').textContent = active.filter(i => i.priority === 'Critical').length;
    document.getElementById('s-high').textContent = active.filter(i => i.priority === 'High').length;
    document.getElementById('s-actions').textContent = active.filter(i => i.status === 'Next Action').length;
    document.getElementById('s-waiting').textContent = active.filter(i => i.status === 'Waiting For').length;
}

function renderProjects() {
    const projects = {};
    items.filter(i => i.status !== 'Completed').forEach(item => {
        const p = item.project || 'No Project';
        if (!projects[p]) projects[p] = { total: 0, critical: 0, high: 0 };
        projects[p].total++;
        if (item.priority === 'Critical') projects[p].critical++;
        if (item.priority === 'High') projects[p].high++;
    });
    
    const sorted = Object.entries(projects).sort((a,b) => b[1].total - a[1].total);
    document.getElementById('projects-list').innerHTML = sorted.map(([name, data]) => `
        <div style="background:var(--card);border-radius:12px;padding:14px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;cursor:pointer;" onclick="filterByProject('${name}')">
            <div>
                <div style="font-weight:500;">${name}</div>
                <div style="font-size:0.8rem;color:var(--text2);">${data.total} items</div>
            </div>
            <div style="display:flex;gap:8px;">
                ${data.critical ? `<span style="background:var(--critical);padding:4px 10px;border-radius:12px;font-size:0.75rem;">${data.critical}</span>` : ''}
                ${data.high ? `<span style="background:var(--high);color:#000;padding:4px 10px;border-radius:12px;font-size:0.75rem;">${data.high}</span>` : ''}
            </div>
        </div>
    `).join('');
}

function filterByProject(name) {
    filters.search = name === 'No Project' ? '' : name;
    document.getElementById('search').value = filters.search;
    switchView('list');
    render();
}

function complete(id) {
    const item = items.find(i => i.id === id);
    if (item) { item.status = 'Completed'; save(); render(); updateStats(); toast('‚úì Completed!'); }
}

function deleteItem(id) {
    if (confirm('Delete this item?')) {
        items = items.filter(i => i.id !== id);
        save(); render(); updateStats(); renderProjects(); closeModal('detail'); toast('Deleted');
    }
}

function addItem() {
    const item = {
        id: Date.now(),
        item: document.getElementById('f-item').value,
        priority: document.getElementById('f-priority').value,
        status: document.getElementById('f-status').value,
        category: document.getElementById('f-category').value,
        context: document.getElementById('f-context').value,
        project: document.getElementById('f-project').value,
        time: document.getElementById('f-time').value,
        energy: document.getElementById('f-energy').value,
        waiting_for: document.getElementById('f-waiting').value,
        notes: document.getElementById('f-notes').value
    };
    if (!item.item.trim()) { toast('Enter item text'); return; }
    items.unshift(item);
    save(); render(); updateStats(); renderProjects(); closeModal('add');
    document.getElementById('f-item').value = '';
    toast('‚úì Added!');
}

function showDetail(id) {
    const item = items.find(i => i.id === id);
    if (!item) return;
    const pColors = {Critical:'var(--critical)',High:'var(--high)',Medium:'var(--medium)',Low:'var(--low)'};
    document.getElementById('detail-content').innerHTML = `
        <div class="modal-header">
            <div class="modal-title">Item Details</div>
            <button class="close-btn" onclick="closeModal('detail')">√ó</button>
        </div>
        <div class="detail-section">
            <div class="detail-label">Item</div>
            <div class="detail-value" style="font-size:1.1rem;font-weight:500;">${item.item}</div>
        </div>
        <div class="detail-tags">
            <span class="detail-tag priority" style="background:${pColors[item.priority]};color:${item.priority==='Medium'||item.priority==='Low'?'#000':'#fff'}">${item.priority}</span>
            <span class="detail-tag" style="background:var(--card2)">${item.status}</span>
            <span class="detail-tag" style="background:${item.category==='Professional'?'var(--pro)':'var(--personal)'}">${item.category}</span>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px;">
            <div class="detail-section"><div class="detail-label">Project</div><div class="detail-value">${item.project || '-'}</div></div>
            <div class="detail-section"><div class="detail-label">Context</div><div class="detail-value">${item.context || '@Anywhere'}</div></div>
            <div class="detail-section"><div class="detail-label">Time</div><div class="detail-value">${item.time || '-'}</div></div>
            <div class="detail-section"><div class="detail-label">Energy</div><div class="detail-value">${item.energy || '-'}</div></div>
            ${item.waiting_for ? `<div class="detail-section" style="grid-column:span 2;"><div class="detail-label">Waiting For</div><div class="detail-value">${item.waiting_for}</div></div>` : ''}
        </div>
        ${item.notes ? `<div class="detail-section" style="margin-top:16px;"><div class="detail-label">Notes</div><div class="detail-value">${item.notes}</div></div>` : ''}
        <div class="detail-actions">
            <button class="detail-btn complete" onclick="complete(${item.id});closeModal('detail')">‚úì Complete</button>
            <button class="detail-btn delete" onclick="deleteItem(${item.id})">üóë Delete</button>
        </div>
    `;
    showModal('detail');
}

function showModal(name) { document.getElementById('modal-' + name).classList.add('open'); }
function closeModal(name) { document.getElementById('modal-' + name).classList.remove('open'); }

function switchView(name) {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('v-' + name).classList.add('active');
    document.querySelector(`[data-v="${name}"]`).classList.add('active');
}

function exportJSON() {
    download(JSON.stringify(items, null, 2), 'gtd-backup-' + new Date().toISOString().split('T')[0] + '.json', 'application/json');
}
function exportCSV() {
    const headers = ['Item','Category','Project','Context','Priority','Status','Energy','Time','Waiting For','Notes'];
    const rows = items.map(i => headers.map(h => `"${(i[h.toLowerCase().replace(/ /g,'_')]||'').toString().replace(/"/g,'""')}"`).join(','));
    download([headers.join(','), ...rows].join('\n'), 'gtd-export.csv', 'text/csv');
}
function download(content, filename, type) {
    const blob = new Blob([content], {type});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    toast('Downloaded!');
}
function importJSON(file) {
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
        try {
            const imported = JSON.parse(e.target.result);
            if (Array.isArray(imported)) {
                items = imported;
                save(); render(); updateStats(); renderProjects();
                toast(`Imported ${imported.length} items!`);
            }
        } catch(e) { toast('Invalid file'); }
    };
    reader.readAsText(file);
}
function clearCompleted() {
    if (confirm('Remove all completed items?')) {
        items = items.filter(i => i.status !== 'Completed');
        save(); render(); updateStats(); toast('Cleared');
    }
}
function resetAll() {
    if (confirm('DELETE ALL DATA? This cannot be undone!')) {
        localStorage.removeItem('gtd_items_v2');
        items = typeof GTD_INITIAL_DATA !== 'undefined' ? [...GTD_INITIAL_DATA] : [];
        save(); render(); updateStats(); renderProjects(); toast('Reset to initial data');
    }
}
function copyLink() {
    navigator.clipboard.writeText(window.location.href);
    toast('Link copied!');
}

const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
let recognition = SR ? new SR() : null;
if (recognition) {
    recognition.continuous = false;
    recognition.interimResults = true;
    recognition.onresult = e => {
        const text = Array.from(e.results).map(r => r[0].transcript).join('');
        document.getElementById('transcript').textContent = text;
        if (e.results[0].isFinal) parseVoice(text);
    };
    recognition.onend = () => {
        document.getElementById('mic-btn').classList.remove('listening');
    };
}
document.getElementById('mic-btn').onclick = () => {
    if (!recognition) { toast('Speech not supported'); return; }
    const btn = document.getElementById('mic-btn');
    if (btn.classList.contains('listening')) { recognition.stop(); }
    else { btn.classList.add('listening'); document.getElementById('transcript').textContent = 'Listening...'; recognition.start(); }
};
function parseVoice(text) {
    const t = text.toLowerCase();
    const parsed = {item: text, priority: 'Medium', status: 'Next Action', category: 'Personal', context: '@Anywhere', project: ''};
    if (/work|professional|office|client|upside/.test(t)) parsed.category = 'Professional';
    if (/critical|urgent|asap/.test(t)) parsed.priority = 'Critical';
    else if (/high|important/.test(t)) parsed.priority = 'High';
    else if (/low|someday/.test(t)) parsed.priority = 'Low';
    if (/waiting|wait for/.test(t)) parsed.status = 'Waiting For';
    else if (/someday|maybe/.test(t)) parsed.status = 'Someday/Maybe';
    const projects = {'world bank':/world bank/,'hpe':/hpe|clearbook/,'caa':/caa|axiom/,'riyadh air':/riyadh/,'astrazeneca':/astra/,'bat':/bat\b/,'business planning':/business plan/,'health':/health|doctor|gym/,'ai':/\bai\b|artificial/};
    for (const [p, rx] of Object.entries(projects)) { if (rx.test(t)) { parsed.project = p.charAt(0).toUpperCase() + p.slice(1); break; } }
    document.getElementById('pf-item').value = parsed.item;
    document.getElementById('pf-priority').value = parsed.priority;
    document.getElementById('pf-status').value = parsed.status;
    document.getElementById('pf-category').value = parsed.category;
    document.getElementById('pf-context').value = parsed.context;
    document.getElementById('pf-project').value = parsed.project;
    document.getElementById('parsed-form').style.display = 'block';
}
function saveFromVoice() {
    const item = {
        id: Date.now(),
        item: document.getElementById('pf-item').value,
        priority: document.getElementById('pf-priority').value,
        status: document.getElementById('pf-status').value,
        category: document.getElementById('pf-category').value,
        context: document.getElementById('pf-context').value,
        project: document.getElementById('pf-project').value,
        notes: 'Added via voice ' + new Date().toLocaleDateString()
    };
    if (!item.item.trim()) { toast('Enter item'); return; }
    items.unshift(item);
    save(); render(); updateStats(); renderProjects();
    document.getElementById('parsed-form').style.display = 'none';
    document.getElementById('transcript').textContent = 'Tap microphone and speak...';
    toast('‚úì Added!');
}

function toast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2500);
}

function setupListeners() {
    document.querySelectorAll('#status-filters .chip').forEach(chip => {
        chip.onclick = () => {
            document.querySelectorAll('#status-filters .chip').forEach(c => c.classList.remove('active'));
            chip.classList.add('active');
            filters.status = chip.dataset.f;
            render();
        };
    });
    document.querySelectorAll('#priority-filters .chip').forEach(chip => {
        chip.onclick = () => {
            const wasActive = chip.classList.contains('active');
            document.querySelectorAll('#priority-filters .chip').forEach(c => c.classList.remove('active'));
            if (!wasActive) { chip.classList.add('active'); filters.priority = chip.dataset.p; }
            else { filters.priority = null; }
            render();
        };
    });
    document.querySelectorAll('#category-filters .chip').forEach(chip => {
        chip.onclick = () => {
            const wasActive = chip.classList.contains('active');
            document.querySelectorAll('#category-filters .chip').forEach(c => c.classList.remove('active'));
            if (!wasActive) { chip.classList.add('active'); filters.category = chip.dataset.c; }
            else { filters.category = null; }
            render();
        };
    });
    document.getElementById('search').oninput = e => { filters.search = e.target.value; render(); };
    const sortOptions = ['priority', 'project', 'status'];
    let sortIdx = 0;
    document.getElementById('sort-btn').onclick = () => {
        sortIdx = (sortIdx + 1) % sortOptions.length;
        sortBy = sortOptions[sortIdx];
        document.getElementById('sort-btn').textContent = '‚ÜïÔ∏è ' + sortBy.charAt(0).toUpperCase() + sortBy.slice(1);
        render();
    };
    document.querySelectorAll('.nav-btn').forEach(btn => { btn.onclick = () => switchView(btn.dataset.v); });
    document.querySelectorAll('.modal').forEach(modal => {
        modal.onclick = e => { if (e.target === modal) closeModal(modal.id.replace('modal-', '')); };
    });
}

init();
</script>
</body>
</html>
