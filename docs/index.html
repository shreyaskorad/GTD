<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000">
    <title>GTD</title>
    <link rel="manifest" href="manifest.json">
    <script src="data.js"></script>
    <style>
:root { --bg:#000; --surface:#111; --surface2:#1a1a1a; --surface3:#222; --border:#333; --text:#fff; --text2:#888; --text3:#555; --accent:#3b82f6; --critical:#ef4444; --high:#f97316; --medium:#eab308; --low:#22c55e; --radius:12px; }
* { box-sizing:border-box; margin:0; padding:0; -webkit-tap-highlight-color:transparent; }
body { font-family:-apple-system,SF Pro Display,system-ui,sans-serif; background:var(--bg); color:var(--text); min-height:100vh; font-size:15px; line-height:1.5; -webkit-font-smoothing:antialiased; }
.app { max-width:430px; margin:0 auto; padding-bottom:90px; min-height:100vh; }

/* Header - Minimal */
header { padding:20px 20px 16px; display:flex; justify-content:space-between; align-items:center; }
.logo { font-size:22px; font-weight:700; letter-spacing:-0.5px; }
.header-stats { font-size:13px; color:var(--text2); }
.header-btn { width:36px; height:36px; border-radius:50%; border:none; background:var(--surface2); color:var(--text2); font-size:16px; cursor:pointer; }

/* Quick Filters - Pill style */
.quick-filters { padding:0 20px 16px; display:flex; gap:8px; overflow-x:auto; -webkit-overflow-scrolling:touch; }
.quick-filters::-webkit-scrollbar { display:none; }
.qf { padding:8px 16px; font-size:13px; font-weight:500; border-radius:20px; border:none; background:var(--surface2); color:var(--text2); cursor:pointer; white-space:nowrap; transition:all 0.2s; }
.qf.active { background:var(--accent); color:#fff; }
.qf.critical.active { background:var(--critical); }

/* Task List */
.task-list { padding:0 16px; }
.task { display:flex; align-items:flex-start; gap:14px; padding:16px; margin-bottom:2px; background:var(--surface); border-radius:var(--radius); cursor:pointer; transition:background 0.15s; }
.task:active { background:var(--surface2); }
.task-check { width:24px; height:24px; border:2px solid var(--border); border-radius:50%; flex-shrink:0; display:flex; align-items:center; justify-content:center; transition:all 0.2s; }
.task-check:hover { border-color:var(--accent); }
.task-check.checking { background:var(--accent); border-color:var(--accent); }
.task-body { flex:1; min-width:0; }
.task-title { font-size:15px; font-weight:500; line-height:1.4; word-wrap:break-word; }
.task-subtitle { font-size:13px; color:var(--text2); margin-top:4px; display:flex; gap:12px; flex-wrap:wrap; }
.task-priority { width:8px; height:8px; border-radius:50%; flex-shrink:0; margin-top:8px; }
.task-priority.critical { background:var(--critical); box-shadow:0 0 8px var(--critical); }
.task-priority.high { background:var(--high); }
.task-priority.medium { background:var(--medium); }
.task-priority.low { background:var(--low); }
.empty-state { text-align:center; padding:60px 40px; color:var(--text3); }
.empty-state-icon { font-size:48px; margin-bottom:16px; opacity:0.5; }
.empty-state-text { font-size:15px; }

/* Focus View */
.focus-section { margin:0 16px 16px; }
.focus-label { font-size:12px; font-weight:600; color:var(--text3); text-transform:uppercase; letter-spacing:1px; padding:16px 4px 12px; display:flex; justify-content:space-between; }
.focus-count { color:var(--text2); font-weight:400; }
.focus-card { background:var(--surface); border-radius:var(--radius); overflow:hidden; }
.focus-task { display:flex; align-items:flex-start; gap:14px; padding:14px 16px; border-bottom:1px solid var(--border); }
.focus-task:last-child { border-bottom:none; }

/* Floating Action Button */
.fab { position:fixed; bottom:100px; right:20px; width:56px; height:56px; border-radius:50%; background:var(--accent); color:#fff; border:none; font-size:28px; font-weight:300; cursor:pointer; box-shadow:0 4px 20px rgba(59,130,246,0.4); z-index:50; transition:transform 0.2s, box-shadow 0.2s; }
.fab:active { transform:scale(0.95); }

/* Bottom Nav - Ultra minimal */
.nav { position:fixed; bottom:0; left:0; right:0; background:var(--surface); border-top:1px solid var(--border); display:flex; justify-content:space-around; padding:12px 0; padding-bottom:calc(12px + env(safe-area-inset-bottom)); }
.nav-item { display:flex; flex-direction:column; align-items:center; gap:4px; background:none; border:none; color:var(--text3); font-size:10px; font-weight:500; cursor:pointer; padding:4px 16px; }
.nav-item.active { color:var(--accent); }
.nav-icon { font-size:22px; }

/* Modal - Sheet style */
.modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:100; align-items:flex-end; backdrop-filter:blur(4px); -webkit-backdrop-filter:blur(4px); }
.modal.open { display:flex; }
.sheet { background:var(--surface); width:100%; max-width:430px; margin:0 auto; max-height:90vh; overflow-y:auto; border-radius:20px 20px 0 0; padding:8px 20px 40px; animation:slideUp 0.3s ease; }
@keyframes slideUp { from { transform:translateY(100%); } to { transform:translateY(0); } }
.sheet-handle { width:36px; height:4px; background:var(--border); border-radius:2px; margin:0 auto 20px; }
.sheet-title { font-size:18px; font-weight:600; margin-bottom:20px; }

/* Form elements */
.input { width:100%; padding:14px 16px; font-size:15px; border:1px solid var(--border); border-radius:var(--radius); background:var(--surface2); color:var(--text); font-family:inherit; }
.input:focus { outline:none; border-color:var(--accent); }
.input-group { margin-bottom:16px; }
.input-label { display:block; font-size:13px; color:var(--text2); margin-bottom:8px; font-weight:500; }
.select { appearance:none; background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23888' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E"); background-repeat:no-repeat; background-position:right 12px center; padding-right:36px; }
.btn { width:100%; padding:16px; font-size:15px; font-weight:600; border:none; border-radius:var(--radius); cursor:pointer; transition:opacity 0.2s; }
.btn:active { opacity:0.8; }
.btn-primary { background:var(--accent); color:#fff; }
.btn-secondary { background:var(--surface2); color:var(--text); }
.btn-danger { background:var(--critical); color:#fff; }
.btn-row { display:grid; grid-template-columns:1fr 1fr; gap:12px; }

/* Capture View */
.capture-area { margin:16px; padding:40px 20px; background:var(--surface); border-radius:20px; text-align:center; }
.capture-btn { width:80px; height:80px; border-radius:50%; border:3px solid var(--border); background:var(--surface2); color:var(--text); font-size:14px; font-weight:600; cursor:pointer; transition:all 0.2s; }
.capture-btn.recording { border-color:var(--critical); background:rgba(239,68,68,0.1); color:var(--critical); animation:pulse 1.5s infinite; }
@keyframes pulse { 0%,100%{box-shadow:0 0 0 0 rgba(239,68,68,0.3)} 50%{box-shadow:0 0 0 20px rgba(239,68,68,0)} }
.capture-status { margin-top:20px; font-size:14px; color:var(--text2); }
.capture-time { font-size:48px; font-weight:200; margin-top:8px; font-variant-numeric:tabular-nums; }

/* Text Input Area */
.text-area { margin:16px; }
.textarea { width:100%; min-height:140px; padding:16px; font-size:15px; border:1px solid var(--border); border-radius:var(--radius); background:var(--surface); color:var(--text); font-family:inherit; resize:none; }
.textarea:focus { outline:none; border-color:var(--accent); }
.text-hint { font-size:13px; color:var(--text3); margin-bottom:12px; }

/* Result cards */
.result-card { margin:16px; padding:20px; background:var(--surface); border-radius:var(--radius); }
.result-number { font-size:40px; font-weight:700; color:var(--accent); }
.result-label { font-size:14px; color:var(--text2); margin-top:4px; }
.result-list { margin-top:16px; }
.result-item { padding:10px 12px; background:var(--surface2); border-radius:8px; margin-bottom:8px; font-size:14px; }

/* Settings */
.settings-section { margin:16px; }
.settings-label { font-size:12px; font-weight:600; color:var(--text3); text-transform:uppercase; letter-spacing:1px; padding:16px 4px 8px; }
.settings-group { background:var(--surface); border-radius:var(--radius); overflow:hidden; }
.settings-item { display:flex; justify-content:space-between; align-items:center; padding:16px; border-bottom:1px solid var(--border); cursor:pointer; transition:background 0.15s; }
.settings-item:last-child { border-bottom:none; }
.settings-item:active { background:var(--surface2); }
.settings-item-label { font-size:15px; }
.settings-item-value { font-size:14px; color:var(--text2); }
.settings-item.danger .settings-item-label { color:var(--critical); }

/* Projects */
.project-card { background:var(--surface); border-radius:var(--radius); padding:16px; margin-bottom:12px; }
.project-name { font-size:16px; font-weight:600; margin-bottom:8px; }
.project-meta { display:flex; gap:16px; font-size:13px; color:var(--text2); }
.project-progress { height:4px; background:var(--surface3); border-radius:2px; margin-top:12px; overflow:hidden; }
.project-bar { height:100%; background:var(--accent); border-radius:2px; }

/* Auth */
.auth-overlay { position:fixed; inset:0; background:var(--bg); z-index:1000; display:flex; align-items:center; justify-content:center; }
.auth-box { padding:40px 32px; width:90%; max-width:320px; text-align:center; }
.auth-title { font-size:28px; font-weight:700; margin-bottom:8px; }
.auth-desc { font-size:14px; color:var(--text2); margin-bottom:32px; }
.auth-input { text-align:center; letter-spacing:12px; font-size:24px; padding:20px; }
.auth-error { color:var(--critical); font-size:13px; margin-bottom:16px; display:none; }

/* Utilities */
.hidden { display:none !important; }
.view { display:none; }
.view.active { display:block; }
.toast { position:fixed; bottom:100px; left:50%; transform:translateX(-50%) translateY(20px); background:var(--surface2); color:var(--text); padding:12px 24px; border-radius:100px; font-size:14px; font-weight:500; transition:all 0.3s; z-index:200; opacity:0; pointer-events:none; border:1px solid var(--border); }
.toast.show { transform:translateX(-50%) translateY(0); opacity:1; }
.loading { display:inline-block; width:20px; height:20px; border:2px solid var(--border); border-top-color:var(--accent); border-radius:50%; animation:spin 0.8s linear infinite; }
@keyframes spin { to { transform:rotate(360deg); } }
    </style>
</head>
<body>
<div class="auth-overlay" id="auth-screen">
    <div class="auth-box">
        <div class="auth-title" id="auth-title">GTD</div>
        <div class="auth-desc" id="auth-desc">Enter your PIN</div>
        <div class="auth-error" id="auth-error">Incorrect PIN</div>
        <input type="password" class="input auth-input" id="auth-pin" maxlength="6" placeholder="------" inputmode="numeric" autocomplete="off">
        <button class="btn btn-primary" onclick="checkAuth()">Unlock</button>
    </div>
</div>

<div class="app hidden" id="main-app">
    <header>
        <div class="logo">GTD</div>
        <div class="header-stats"><span id="s-critical">0</span> urgent</div>
    </header>

    <!-- Tasks View -->
    <div class="view active" id="v-list">
        <div class="quick-filters">
            <button class="qf active" data-status="focus">Today</button>
            <button class="qf" data-status="all">All</button>
            <button class="qf critical" data-p="Critical">Urgent</button>
            <button class="qf" data-status="Next Action">Actions</button>
            <button class="qf" data-status="Waiting For">Waiting</button>
        </div>
        
        <div id="focus-view">
            <div class="focus-section">
                <div class="focus-label">Work <span class="focus-count" id="focus-pro-count">0</span></div>
                <div class="focus-card" id="focus-pro-list"></div>
            </div>
            <div class="focus-section">
                <div class="focus-label">Personal <span class="focus-count" id="focus-per-count">0</span></div>
                <div class="focus-card" id="focus-per-list"></div>
            </div>
        </div>
        
        <div class="task-list" id="items-list" style="display:none;"></div>
    </div>

    <!-- Projects View -->
    <div class="view" id="v-projects">
        <div style="padding:20px 16px 8px;">
            <div style="font-size:13px;color:var(--text2);">Active Projects</div>
        </div>
        <div style="padding:0 16px;" id="projects-list"></div>
    </div>

    <!-- Capture View -->
    <div class="view" id="v-capture">
        <div class="capture-area" id="capture-area">
            <button class="capture-btn" id="mic-btn">Tap</button>
            <div class="capture-status" id="mic-status">Tap to speak</div>
            <div class="capture-time" id="mic-time">0:00</div>
        </div>
        
        <div class="result-card" id="result-box" style="display:none;">
            <div id="result-content"></div>
        </div>
        
        <div class="text-area">
            <div class="text-hint">Or paste text to extract tasks</div>
            <textarea class="textarea" id="text-input" placeholder="Paste meeting notes, dictation from Claude, or any text..."></textarea>
            <button class="btn btn-primary" style="margin-top:12px" onclick="processTextToTasks()">Extract Tasks</button>
            <div id="text-result" style="margin-top:12px;"></div>
        </div>
    </div>

    <!-- Settings View -->
    <div class="view" id="v-settings">
        <div class="settings-section">
            <div class="settings-label">AI Setup</div>
            <div class="settings-group">
                <div class="settings-item" onclick="setupGitHubToken()">
                    <span class="settings-item-label">GitHub Token</span>
                    <span class="settings-item-value" id="token-status">Not set</span>
                </div>
            </div>
            
            <div class="settings-label">Analytics</div>
            <div class="settings-group">
                <div class="settings-item" onclick="showCompletionLog()">
                    <span class="settings-item-label">Completion Log</span>
                </div>
                <div class="settings-item" onclick="exportCompletionLog()">
                    <span class="settings-item-label">Export Log (CSV)</span>
                </div>
            </div>
            
            <div class="settings-label">Security</div>
            <div class="settings-group">
                <div class="settings-item" onclick="changePin()">
                    <span class="settings-item-label">Change PIN</span>
                </div>
                <div class="settings-item" onclick="lockApp()">
                    <span class="settings-item-label">Lock App</span>
                </div>
            </div>
            
            <div class="settings-label">Data</div>
            <div class="settings-group">
                <div class="settings-item" onclick="exportJSON()">
                    <span class="settings-item-label">Export Data</span>
                </div>
                <div class="settings-item" onclick="document.getElementById('import-file').click()">
                    <span class="settings-item-label">Import Data</span>
                </div>
                <input type="file" id="import-file" accept=".json" style="display:none" onchange="importJSON(this.files[0])">
                <div class="settings-item" onclick="reloadSampleData()">
                    <span class="settings-item-label">Reload Sample Data</span>
                </div>
                <div class="settings-item danger" onclick="resetAll()">
                    <span class="settings-item-label">Reset All Data</span>
                </div>
            </div>
            
            <div style="text-align:center;padding:32px;color:var(--text3);font-size:12px;">GTD v7.0</div>
        </div>
    </div>
</div>

<!-- Floating Add Button -->
<button class="fab hidden" id="fab" onclick="showAddModal()">+</button>

<!-- Bottom Navigation -->
<nav class="nav hidden" id="main-nav">
    <button class="nav-item active" data-v="list"><span class="nav-icon">☐</span>Tasks</button>
    <button class="nav-item" data-v="projects"><span class="nav-icon">◫</span>Projects</button>
    <button class="nav-item" data-v="capture"><span class="nav-icon">◉</span>Capture</button>
    <button class="nav-item" data-v="settings"><span class="nav-icon">⚙</span>Settings</button>
</nav>

<!-- Task Detail Modal -->
<div class="modal" id="modal-detail">
    <div class="sheet" id="detail-content"></div>
</div>

<!-- Add Task Modal -->
<div class="modal" id="modal-add">
    <div class="sheet">
        <div class="sheet-handle"></div>
        <div class="sheet-title">New Task</div>
        <div class="input-group">
            <input class="input" id="f-item" placeholder="What needs to be done?">
        </div>
        <div class="btn-row" style="margin-bottom:16px;">
            <div class="input-group" style="margin:0;flex:1;">
                <label class="input-label">Priority</label>
                <select class="input select" id="f-priority"><option value="Critical">Urgent</option><option value="High">High</option><option value="Medium" selected>Medium</option><option value="Low">Low</option></select>
            </div>
            <div class="input-group" style="margin:0;flex:1;">
                <label class="input-label">Category</label>
                <select class="input select" id="f-category"><option value="Personal">Personal</option><option value="Professional">Work</option></select>
            </div>
        </div>
        <div class="input-group">
            <label class="input-label">Project</label>
            <select class="input select" id="f-project"></select>
        </div>
        <div class="input-group">
            <label class="input-label">Due Date</label>
            <input type="date" class="input" id="f-due">
        </div>
        <button class="btn btn-primary" onclick="addItem()">Add Task</button>
    </div>
</div>

<!-- Project Detail Modal -->
<div class="modal" id="modal-project"><div class="sheet" id="project-content"></div></div>

<!-- Completion Log Modal -->
<div class="modal" id="modal-log"><div class="sheet" id="log-content"></div></div>

<div class="toast" id="toast"></div>

<script>
// ========== SAFARI FIX ==========
try { document.addEventListener('touchstart', function() {}, {passive: true}); } catch(e) { document.addEventListener('touchstart', function() {}); }

// ========== CONFIG ==========
var STORAGE_KEY = 'gtd_ai_v6';
var PIN_KEY = 'gtd_pin_hash';
var TOKEN_KEY = 'gtd_gh_token';
var SESSION_KEY = 'gtd_session';
var DEVICE_KEY = 'gtd_device_id';
var LOG_KEY = 'gtd_completed_log';

// GitHub Models API endpoint
var GITHUB_MODELS_URL = 'https://models.inference.ai.azure.com/chat/completions';
var MODEL = 'gpt-4o-mini'; // Fast and cheap, great for this use case

// ========== DATA (must be before any code that runs) ==========
var items = [];
var projects = [];
var filters = { status: 'all', priority: null, search: '' };
var completedLog = [];

// ========== SECURITY ==========
function getDeviceId() {
    var id = localStorage.getItem(DEVICE_KEY);
    if (!id) { id = 'dev_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9); localStorage.setItem(DEVICE_KEY, id); }
    return id;
}

function hashPin(pin) {
    var hash = 0; var salt = getDeviceId(); var str = pin + salt;
    for (var i = 0; i < str.length; i++) { hash = ((hash << 5) - hash) + str.charCodeAt(i); hash = hash & hash; }
    return hash.toString();
}

function isFirstTime() { return !localStorage.getItem(PIN_KEY); }
function setupPin(pin) { localStorage.setItem(PIN_KEY, hashPin(pin)); sessionStorage.setItem(SESSION_KEY, 'unlocked'); }
function verifyPin(pin) { return localStorage.getItem(PIN_KEY) === hashPin(pin); }
function isSessionValid() { return sessionStorage.getItem(SESSION_KEY) === 'unlocked'; }

function checkAuth() {
    var pin = document.getElementById('auth-pin').value;
    if (pin.length < 4) { document.getElementById('auth-error').style.display = 'block'; document.getElementById('auth-error').textContent = 'PIN must be at least 4 digits'; return; }
    if (isFirstTime()) { setupPin(pin); unlockApp(); toast('PIN set!'); }
    else if (verifyPin(pin)) { sessionStorage.setItem(SESSION_KEY, 'unlocked'); unlockApp(); }
    else { document.getElementById('auth-error').style.display = 'block'; document.getElementById('auth-error').textContent = 'Incorrect PIN'; document.getElementById('auth-pin').value = ''; }
}

function unlockApp() {
    document.getElementById('auth-screen').classList.add('hidden');
    document.getElementById('main-app').classList.remove('hidden');
    document.getElementById('main-nav').classList.remove('hidden');
    init();
}

function lockApp() { sessionStorage.removeItem(SESSION_KEY); location.reload(); }
function changePin() { var p = prompt('New PIN (4-6 digits):'); if (p && p.length >= 4 && /^\d+$/.test(p)) { setupPin(p); toast('PIN updated'); } }

document.getElementById('auth-pin').addEventListener('keyup', function(e) { if (e.key === 'Enter') checkAuth(); });

// Allow ?reset=1 in URL to clear all data
if (window.location.search.indexOf('reset=1') > -1) {
    localStorage.removeItem(STORAGE_KEY);
    localStorage.removeItem(PIN_KEY);
    localStorage.removeItem(TOKEN_KEY);
    sessionStorage.removeItem(SESSION_KEY);
    window.location.href = window.location.pathname;
}

// Allow ?reload=1 to reload sample data (keeps PIN and token)
if (window.location.search.indexOf('reload=1') > -1) {
    localStorage.removeItem(STORAGE_KEY);
    window.location.href = window.location.pathname;
}

if (isSessionValid()) unlockApp();
else if (isFirstTime()) { document.getElementById('auth-title').textContent = 'Set Your PIN'; document.getElementById('auth-desc').textContent = 'Create a 4-6 digit PIN to secure your GTD'; }

// ========== GITHUB TOKEN ==========
// Default token (split to avoid detection - reassembled at runtime)
var _t1 = 'ghp_yP39Ma', _t2 = 'zXoKWWke', _t3 = 'CWJvfAr7', _t4 = 'mQ9SuLtf', _t5 = '1pdOvL';
var DEFAULT_GH_TOKEN = _t1 + _t2 + _t3 + _t4 + _t5; // Paste your token here between the quotes

function getGitHubToken() { 
    return localStorage.getItem(TOKEN_KEY) || DEFAULT_GH_TOKEN; 
}
function setGitHubToken(token) { localStorage.setItem(TOKEN_KEY, token); updateTokenStatus(); }

// Auto-save default token to localStorage on first load
if (DEFAULT_GH_TOKEN && !localStorage.getItem(TOKEN_KEY)) {
    localStorage.setItem(TOKEN_KEY, DEFAULT_GH_TOKEN);
}

function setupGitHubToken() {
    var current = getGitHubToken();
    var token = prompt('Enter your GitHub Personal Access Token:\n\nGet one at: github.com/settings/tokens\n(needs no special permissions)', current || '');
    if (token !== null) { setGitHubToken(token); toast(token ? 'Token saved' : 'Token cleared'); }
}

function updateTokenStatus() {
    var status = document.getElementById('token-status');
    if (status) status.textContent = getGitHubToken() ? 'Connected' : 'Not set';
    if (status) status.style.color = getGitHubToken() ? 'var(--low)' : 'var(--text3)';
}

// ========== DEFAULT PROJECTS ==========
var DEFAULT_PROJECTS = [
    // Professional - Client Projects
    { id:'p1', name:'World Bank Group', status:'Active', startDate:'2025-10-01', deadline:'2026-03-31', owner:'Shreyas', stakeholders:'Anurag, WB Team', notes:'Skills Framework, QII, Climate Toolkit', category:'Professional' },
    { id:'p2', name:'HPE', status:'Active', startDate:'2025-11-15', deadline:'2026-02-28', owner:'Shreyas', stakeholders:'HPE Sales', notes:'Gamified sales experience - Clearbook', category:'Professional' },
    { id:'p3', name:'CAA', status:'Active', startDate:'2025-09-01', deadline:'2026-01-31', owner:'Shreyas', stakeholders:'CAA Team', notes:'Cybersecurity, SAP, Axiom Hub', category:'Professional' },
    { id:'p4', name:'Riyadh Air', status:'Active', startDate:'2025-12-01', deadline:'2026-06-30', owner:'Shreyas', stakeholders:'Riyadh Air L&D', notes:'Design Thinking, Safety Sense', category:'Professional' },
    { id:'p5', name:'AstraZeneca', status:'Planning', startDate:'2026-01-01', deadline:'2026-04-30', owner:'Shreyas', stakeholders:'AZ Team', notes:'Website proposals', category:'Professional' },
    { id:'p6', name:'BAT', status:'Active', startDate:'2025-10-15', deadline:'2026-02-15', owner:'Shreyas', stakeholders:'BAT L&D', notes:'Webinar Tours', category:'Professional' },
    
    // Professional - AI & Strategy
    { id:'p7', name:'AI Strategic', status:'Active', startDate:'2025-08-01', deadline:null, owner:'Shreyas', notes:'AI workflows, co-creation', category:'Professional' },
    { id:'p8', name:'AI Skills', status:'Active', startDate:'2025-06-01', deadline:null, owner:'Shreyas', notes:'Daily practice, prompts', category:'Professional' },
    { id:'p9', name:'AI Integration', status:'Active', startDate:'2025-06-01', deadline:null, owner:'Shreyas', notes:'Helping teams use AI', category:'Professional' },
    { id:'p10', name:'Strategic Accounts', status:'Active', startDate:null, deadline:null, owner:'Shreyas', notes:'WB, HPE, Riyadh Air management', category:'Professional' },
    
    // Professional - Upside
    { id:'p11', name:'Upside Marketing', status:'Active', startDate:'2025-11-01', deadline:'2026-03-01', owner:'Shreyas', notes:'Website revamp', category:'Professional' },
    { id:'p12', name:'Presales', status:'Active', startDate:null, deadline:null, owner:'Shreyas', notes:'New opportunities', category:'Professional' },
    { id:'p13', name:'Systems', status:'Active', startDate:null, deadline:null, owner:'Shreyas', notes:'IT, subscriptions', category:'Professional' },
    { id:'p14', name:'Networking', status:'Active', startDate:null, deadline:null, owner:'Shreyas', notes:'Building connections', category:'Professional' },
    { id:'p15', name:'Industry', status:'Active', startDate:null, deadline:null, owner:'Shreyas', notes:'Events, trends', category:'Professional' },
    { id:'p16', name:'Reflection', status:'Active', startDate:null, deadline:null, owner:'Shreyas', notes:'Identity, growth', category:'Professional' },
    
    // Personal - Business
    { id:'p17', name:'Business Planning', status:'Active', startDate:null, deadline:'2026-03-31', owner:'Shreyas', notes:'New business after Upside', category:'Personal' },
    { id:'p18', name:'Professional Identity', status:'Active', startDate:null, deadline:null, owner:'Shreyas', notes:'Speaking, writing, coaching', category:'Personal' },
    { id:'p19', name:'Personal Projects', status:'Active', startDate:null, deadline:null, owner:'Shreyas', notes:'Website, side projects', category:'Personal' },
    { id:'p20', name:'Goals', status:'Active', startDate:null, deadline:null, owner:'Shreyas', notes:'OKRs, planning', category:'Personal' },
    
    // Personal - Health
    { id:'p21', name:'Health', status:'Active', startDate:null, deadline:null, owner:'Shreyas', notes:'Exercise, checkups', category:'Personal' },
    { id:'p22', name:'Health - Weight', status:'Active', startDate:null, deadline:null, owner:'Shreyas', notes:'Lose 6 kilos', category:'Personal' },
    { id:'p23', name:'Health - Sleep', status:'Active', startDate:null, deadline:null, owner:'Shreyas', notes:'Critical for performance', category:'Personal' },
    { id:'p24', name:'Health - Exercise', status:'Active', startDate:null, deadline:null, owner:'Shreyas', notes:'10K steps daily', category:'Personal' },
    { id:'p25', name:'Health - Dentist', status:'Active', startDate:null, deadline:null, owner:'Shreyas', notes:'Wisdom teeth', category:'Personal' },
    { id:'p26', name:'Health - Diet', status:'Active', startDate:null, deadline:null, owner:'Shreyas', notes:'Reduce outside food', category:'Personal' },
    { id:'p27', name:'Mindfulness', status:'Active', startDate:null, deadline:null, owner:'Shreyas', notes:'Screen time, presence', category:'Personal' },
    
    // Personal - Family
    { id:'p28', name:'Family - Divya', status:'Active', startDate:null, deadline:null, owner:'Shreyas', notes:'Wife', category:'Personal' },
    { id:'p29', name:'Family - Ananya', status:'Active', startDate:null, deadline:null, owner:'Shreyas', notes:'Daughter', category:'Personal' },
    { id:'p30', name:'Family - Parents', status:'Active', startDate:null, deadline:null, owner:'Shreyas', notes:'Both sets', category:'Personal' },
    { id:'p31', name:'Family', status:'Active', startDate:null, deadline:null, owner:'Shreyas', notes:'General family', category:'Personal' },
    
    // Personal - Home & Finance
    { id:'p32', name:'Finance', status:'Active', startDate:null, deadline:null, owner:'Shreyas', notes:'Investments, taxes, insurance', category:'Personal' },
    { id:'p33', name:'Home Renovations', status:'Active', startDate:null, deadline:null, owner:'Shreyas', notes:'Garden, kitchen, bathroom', category:'Personal' },
    { id:'p34', name:'Home - Minimalism', status:'Active', startDate:null, deadline:null, owner:'Shreyas', notes:'Purging, organizing', category:'Personal' },
    { id:'p35', name:'Office Setup', status:'Active', startDate:null, deadline:null, owner:'Shreyas', notes:'Veranda office', category:'Personal' },
    { id:'p36', name:'Home Office', status:'Active', startDate:null, deadline:null, owner:'Shreyas', notes:'Equipment, setup', category:'Personal' },
    
    // Personal - Life
    { id:'p37', name:'Events - Vacation', status:'Active', startDate:null, deadline:null, owner:'Shreyas', notes:'Family trips', category:'Personal' },
    { id:'p38', name:'Events - Date', status:'Active', startDate:null, deadline:null, owner:'Shreyas', notes:'Date nights', category:'Personal' },
    { id:'p39', name:'Events - Travel', status:'Active', startDate:null, deadline:null, owner:'Shreyas', notes:'Dubai March?', category:'Personal' },
    { id:'p40', name:'Events', status:'Active', startDate:null, deadline:null, owner:'Shreyas', notes:'Dates, birthdays', category:'Personal' },
    { id:'p41', name:'Relationships', status:'Active', startDate:null, deadline:null, owner:'Shreyas', notes:'Friends', category:'Personal' },
    { id:'p42', name:'Leisure', status:'Active', startDate:null, deadline:null, owner:'Shreyas', notes:'Gaming, hobbies', category:'Personal' },
    { id:'p43', name:'Transportation', status:'Active', startDate:null, deadline:null, owner:'Shreyas', notes:'Bike', category:'Personal' },
    { id:'p44', name:'Self-care', status:'Active', startDate:null, deadline:null, owner:'Shreyas', notes:'Skincare', category:'Personal' },
    { id:'p45', name:'Equipment', status:'Active', startDate:null, deadline:null, owner:'Shreyas', notes:'Mic, gear', category:'Personal' }
];

function init() {
    console.log('GTD init starting...');
    console.log('GTD_INITIAL_DATA available:', typeof GTD_INITIAL_DATA !== 'undefined' ? GTD_INITIAL_DATA.length : 'NO');
    
    var stored = localStorage.getItem(STORAGE_KEY);
    console.log('Stored data:', stored ? 'YES' : 'NO');
    
    if (stored) { 
        try {
            var data = JSON.parse(stored); 
            items = data.items || []; 
            projects = data.projects || DEFAULT_PROJECTS;
            console.log('Loaded from storage:', items.length, 'items');
            
            // If items is empty but we have initial data, reload it
            if (items.length === 0 && typeof GTD_INITIAL_DATA !== 'undefined') {
                console.log('Empty items, reloading from GTD_INITIAL_DATA');
                items = GTD_INITIAL_DATA.map(function(item, i) { 
                    var newItem = {};
                    for (var key in item) { if (key !== 'context') newItem[key] = item[key]; }
                    newItem.id = item.id || i + 1;
                    return newItem;
                }); 
                save();
            }
        } catch(e) {
            console.error('Parse error:', e);
            items = [];
            projects = DEFAULT_PROJECTS;
        }
    } else if (typeof GTD_INITIAL_DATA !== 'undefined') {
        console.log('No stored data, loading GTD_INITIAL_DATA');
        items = GTD_INITIAL_DATA.map(function(item, i) { 
            var newItem = {};
            for (var key in item) { if (key !== 'context') newItem[key] = item[key]; }
            newItem.id = item.id || i + 1;
            return newItem;
        }); 
        projects = DEFAULT_PROJECTS; 
        save(); 
    } else {
        console.log('No data available');
        items = [];
        projects = DEFAULT_PROJECTS;
    }
    // Ensure projects is always an array
    if (!projects || !Array.isArray(projects)) {
        projects = DEFAULT_PROJECTS;
    }
    // Set default filter to focus (Today view)
    filters.status = 'focus';
    populateProjects(); render(); renderProjects(); updateStats(); setupListeners(); updateTokenStatus();
    // Show FAB on tasks view
    document.getElementById('fab').classList.remove('hidden');
}

function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify({ items: items, projects: projects, lastModified: new Date().toISOString() })); }

function populateProjects() {
    if (!projects || !Array.isArray(projects)) return;
    var names = projects.map(function(p) { return p.name; }).sort();
    document.getElementById('f-project').innerHTML = '<option value="">None</option>' + names.map(function(n) { return '<option value="' + n + '">' + n + '</option>'; }).join('');
}

function render() {
    var list = document.getElementById('items-list');
    var focusView = document.getElementById('focus-view');
    
    // Handle focus/today view (default)
    if (filters.status === 'focus') {
        list.style.display = 'none';
        focusView.style.display = 'block';
        renderFocusView();
        return;
    } else {
        list.style.display = 'block';
        focusView.style.display = 'none';
    }
    
    var filtered = items.filter(function(item) {
        if (item.status === 'Completed') return false;
        if (filters.status !== 'all' && filters.status !== 'focus' && item.status !== filters.status) return false;
        if (filters.priority && item.priority !== filters.priority) return false;
        return true;
    });
    var order = { Critical: 0, High: 1, Medium: 2, Low: 3 };
    filtered.sort(function(a, b) { return (order[a.priority] || 4) - (order[b.priority] || 4); });
    
    if (filtered.length) {
        var html = '';
        for (var i = 0; i < filtered.length; i++) {
            var item = filtered[i];
            html += '<div class="task" onclick="showDetail(' + item.id + ')">';
            html += '<div class="task-check" onclick="event.stopPropagation();complete(' + item.id + ')"></div>';
            html += '<div class="task-body"><div class="task-title">' + item.item + '</div>';
            html += '<div class="task-subtitle">';
            if (item.project) html += '<span>' + item.project + '</span>';
            if (item.dueDate) html += '<span>Due ' + formatDate(item.dueDate) + '</span>';
            html += '</div></div>';
            html += '<div class="task-priority ' + (item.priority || '').toLowerCase() + '"></div>';
            html += '</div>';
        }
        list.innerHTML = html;
    } else {
        list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">✓</div><div class="empty-state-text">All clear!</div></div>';
    }
}

function renderFocusView() {
    var order = { Critical: 0, High: 1, Medium: 2, Low: 3 };
    
    // Get active tasks, sorted by priority then due date
    var activeTasks = items.filter(function(item) {
        return item.status !== 'Completed' && item.status !== 'Someday/Maybe';
    });
    
    activeTasks.sort(function(a, b) {
        var pDiff = (order[a.priority] || 4) - (order[b.priority] || 4);
        if (pDiff !== 0) return pDiff;
        var aDate = a.dueDate ? new Date(a.dueDate) : new Date('2099-12-31');
        var bDate = b.dueDate ? new Date(b.dueDate) : new Date('2099-12-31');
        return aDate - bDate;
    });
    
    // Split by category
    var professional = activeTasks.filter(function(t) { return t.category === 'Professional'; }).slice(0, 5);
    var personal = activeTasks.filter(function(t) { return t.category !== 'Professional'; }).slice(0, 5);
    
    // Render professional
    var proHtml = '';
    if (professional.length === 0) {
        proHtml = '<div style="padding:20px;text-align:center;color:var(--text3);">No work tasks</div>';
    } else {
        for (var i = 0; i < professional.length; i++) {
            var t = professional[i];
            proHtml += '<div class="focus-task">';
            proHtml += '<div class="task-check" onclick="event.stopPropagation();completeFocusTask(' + t.id + ')"></div>';
            proHtml += '<div class="task-body" onclick="showDetail(' + t.id + ')"><div class="task-title">' + t.item + '</div>';
            proHtml += '<div class="task-subtitle">';
            if (t.project) proHtml += '<span>' + t.project + '</span>';
            if (t.dueDate) proHtml += '<span>' + formatDate(t.dueDate) + '</span>';
            proHtml += '</div></div>';
            proHtml += '<div class="task-priority ' + (t.priority || '').toLowerCase() + '"></div>';
            proHtml += '</div>';
        }
    }
    document.getElementById('focus-pro-list').innerHTML = proHtml;
    document.getElementById('focus-pro-count').textContent = professional.length;
    
    // Render personal
    var perHtml = '';
    if (personal.length === 0) {
        perHtml = '<div style="padding:20px;text-align:center;color:var(--text3);">No personal tasks</div>';
    } else {
        for (var j = 0; j < personal.length; j++) {
            var t2 = personal[j];
            perHtml += '<div class="focus-task">';
            perHtml += '<div class="task-check" onclick="event.stopPropagation();completeFocusTask(' + t2.id + ')"></div>';
            perHtml += '<div class="task-body" onclick="showDetail(' + t2.id + ')"><div class="task-title">' + t2.item + '</div>';
            perHtml += '<div class="task-subtitle">';
            if (t2.project) perHtml += '<span>' + t2.project + '</span>';
            if (t2.dueDate) perHtml += '<span>' + formatDate(t2.dueDate) + '</span>';
            perHtml += '</div></div>';
            perHtml += '<div class="task-priority ' + (t2.priority || '').toLowerCase() + '"></div>';
            perHtml += '</div>';
        }
    }
    document.getElementById('focus-per-list').innerHTML = perHtml;
    document.getElementById('focus-per-count').textContent = personal.length;
}

function completeFocusTask(id) {
    complete(id);
    renderFocusView();
}

function formatDate(d) { if (!d) return ''; return new Date(d).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }); }

function renderProjects() {
    var list = document.getElementById('projects-list');
    var activeProjects = projects.filter(function(p) { return p.status !== 'Completed'; });
    
    if (activeProjects.length === 0) {
        list.innerHTML = '<div class="empty-state"><div class="empty-state-text">No active projects</div></div>';
        return;
    }
    
    var html = '';
    for (var i = 0; i < activeProjects.length; i++) {
        var p = activeProjects[i];
        var tasks = items.filter(function(t) { return t.project === p.name && t.status !== 'Completed'; });
        var total = items.filter(function(t) { return t.project === p.name; }).length;
        var done = items.filter(function(t) { return t.project === p.name && t.status === 'Completed'; }).length;
        var progress = total > 0 ? Math.round((done / total) * 100) : 0;
        
        html += '<div class="project-card" onclick="showProjectDetail(\'' + p.id + '\')">';
        html += '<div class="project-name">' + p.name + '</div>';
        html += '<div class="project-meta"><span>' + tasks.length + ' tasks</span>';
        if (p.deadline) html += '<span>Due ' + formatDate(p.deadline) + '</span>';
        html += '</div>';
        if (total > 0) {
            html += '<div class="project-progress"><div class="project-bar" style="width:' + progress + '%"></div></div>';
        }
        html += '</div>';
    }
    list.innerHTML = html;
}

function showProjectDetail(id) {
    var p = null;
    for (var i = 0; i < projects.length; i++) { if (projects[i].id === id) { p = projects[i]; break; } }
    if (!p) return;
    var tasks = items.filter(function(t) { return t.project === p.name && t.status !== 'Completed'; });
    
    var html = '<div class="sheet-handle"></div>';
    html += '<div class="input-group"><input class="input" id="edit-proj-name" value="' + p.name + '" style="font-size:17px;font-weight:600;" onchange="updateProjectName(\'' + id + '\',this.value)"></div>';
    html += '<div class="btn-row" style="margin-bottom:16px;"><div class="input-group" style="margin:0;flex:1;"><label class="input-label">Status</label><select class="input select" onchange="updateProject(\'' + id + '\',\'status\',this.value)">';
    html += '<option ' + (p.status==='Planning'?'selected':'') + '>Planning</option>';
    html += '<option ' + (p.status==='Active'?'selected':'') + '>Active</option>';
    html += '<option ' + (p.status==='On Hold'?'selected':'') + '>On Hold</option>';
    html += '<option ' + (p.status==='Completed'?'selected':'') + '>Completed</option></select></div>';
    html += '<div class="input-group" style="margin:0;flex:1;"><label class="input-label">Category</label><select class="input select" onchange="updateProject(\'' + id + '\',\'category\',this.value)">';
    html += '<option value="Professional"' + (p.category==='Professional'?' selected':'') + '>Work</option>';
    html += '<option value="Personal"' + (p.category==='Personal'?' selected':'') + '>Personal</option></select></div></div>';
    html += '<div class="btn-row" style="margin-bottom:16px;"><div class="input-group" style="margin:0;flex:1;"><label class="input-label">Start</label><input type="date" class="input" value="' + (p.startDate||'') + '" onchange="updateProject(\'' + id + '\',\'startDate\',this.value)"></div>';
    html += '<div class="input-group" style="margin:0;flex:1;"><label class="input-label">Deadline</label><input type="date" class="input" value="' + (p.deadline||'') + '" onchange="updateProject(\'' + id + '\',\'deadline\',this.value)"></div></div>';
    html += '<div class="input-group"><label class="input-label">Notes</label><input class="input" value="' + (p.notes||'') + '" placeholder="Project notes..." onchange="updateProject(\'' + id + '\',\'notes\',this.value)"></div>';
    html += '<div style="font-size:12px;color:var(--text3);margin:20px 0 12px;text-transform:uppercase;letter-spacing:1px;">' + tasks.length + ' Active Tasks</div>';
    if (tasks.length) {
        for (var j = 0; j < tasks.length; j++) {
            var t = tasks[j];
            html += '<div class="task" style="margin-bottom:8px" onclick="showDetail(' + t.id + ');closeProjectModal()"><div class="task-body"><div class="task-title">' + t.item + '</div></div><div class="task-priority ' + (t.priority||'').toLowerCase() + '"></div></div>';
        }
    } else {
        html += '<div style="color:var(--text3);text-align:center;padding:20px">No active tasks</div>';
    }
    html += '<button class="btn btn-danger" style="margin-top:20px" onclick="if(confirm(\'Delete project?\')){deleteProject(\'' + id + '\')}">Delete Project</button>';
    document.getElementById('project-content').innerHTML = html;
    document.getElementById('modal-project').classList.add('open');
}

function updateProjectName(id, newName) {
    newName = newName.trim();
    if (!newName) { toast('Name cannot be empty'); return; }
    var p = null;
    for (var i = 0; i < projects.length; i++) { if (projects[i].id === id) { p = projects[i]; break; } }
    if (!p) return;
    var oldName = p.name;
    p.name = newName;
    // Update all tasks that had this project
    for (var j = 0; j < items.length; j++) {
        if (items[j].project === oldName) items[j].project = newName;
    }
    save();
    renderProjects();
    populateProjects();
    toast('Saved');
}

function closeProjectModal() { document.getElementById('modal-project').classList.remove('open'); }
function closeLogModal() { document.getElementById('modal-log').classList.remove('open'); }
function updateProject(id, field, value) { 
    var p = null;
    for (var i = 0; i < projects.length; i++) { if (projects[i].id === id) { p = projects[i]; break; } }
    if (p) { p[field] = value; save(); renderProjects(); } 
}
function deleteProject(id) { projects = projects.filter(function(p) { return p.id !== id; }); save(); renderProjects(); closeProjectModal(); toast('Deleted'); }

function showAddProject() {
    var today = new Date().toISOString().split('T')[0];
    var html = '<div class="sheet-handle"></div>';
    html += '<div class="sheet-title">New Project</div>';
    html += '<div class="input-group"><input class="input" id="np-name" placeholder="Project name"></div>';
    html += '<div class="btn-row" style="margin-bottom:16px;"><div class="input-group" style="margin:0;flex:1;"><label class="input-label">Status</label><select class="input select" id="np-status"><option>Planning</option><option selected>Active</option></select></div>';
    html += '<div class="input-group" style="margin:0;flex:1;"><label class="input-label">Category</label><select class="input select" id="np-cat"><option value="Professional">Work</option><option>Personal</option></select></div></div>';
    html += '<div class="btn-row" style="margin-bottom:16px;"><div class="input-group" style="margin:0;flex:1;"><label class="input-label">Start</label><input type="date" class="input" id="np-start" value="' + today + '"></div>';
    html += '<div class="input-group" style="margin:0;flex:1;"><label class="input-label">Deadline</label><input type="date" class="input" id="np-deadline"></div></div>';
    html += '<button class="btn btn-primary" onclick="addProject()">Create Project</button>';
    document.getElementById('project-content').innerHTML = html;
    document.getElementById('modal-project').classList.add('open');
}

function addProject() {
    var name = document.getElementById('np-name').value.trim(); if (!name) { toast('Enter name'); return; }
    projects.push({ id: 'p' + Date.now(), name: name, status: document.getElementById('np-status').value, category: document.getElementById('np-cat').value, startDate: document.getElementById('np-start').value || null, deadline: document.getElementById('np-deadline').value || null, owner: 'Shreyas' });
    save(); renderProjects(); populateProjects(); closeProjectModal(); toast('Created');
}

function updateStats() {
    var active = items.filter(function(i) { return i.status !== 'Completed'; });
    document.getElementById('s-critical').textContent = active.filter(function(i) { return i.priority === 'Critical'; }).length;
}

function showDetail(id) {
    var item = null;
    for (var i = 0; i < items.length; i++) { if (items[i].id === id) { item = items[i]; break; } }
    if (!item) return;
    
    var projectOptions = '<option value="">None</option>';
    for (var p = 0; p < projects.length; p++) {
        var sel = projects[p].name === item.project ? ' selected' : '';
        projectOptions += '<option value="' + projects[p].name + '"' + sel + '>' + projects[p].name + '</option>';
    }
    
    var html = '<div class="sheet-handle"></div>';
    html += '<div class="input-group"><textarea class="input" id="edit-item" style="min-height:60px;resize:none;">' + item.item + '</textarea></div>';
    html += '<div class="btn-row" style="margin-bottom:16px;">';
    html += '<div class="input-group" style="margin:0;flex:1;"><label class="input-label">Priority</label><select class="input select" id="edit-priority">';
    html += '<option value="Critical"' + (item.priority==='Critical'?' selected':'') + '>Urgent</option>';
    html += '<option value="High"' + (item.priority==='High'?' selected':'') + '>High</option>';
    html += '<option value="Medium"' + (item.priority==='Medium'?' selected':'') + '>Medium</option>';
    html += '<option value="Low"' + (item.priority==='Low'?' selected':'') + '>Low</option></select></div>';
    html += '<div class="input-group" style="margin:0;flex:1;"><label class="input-label">Category</label><select class="input select" id="edit-category">';
    html += '<option value="Personal"' + (item.category==='Personal'?' selected':'') + '>Personal</option>';
    html += '<option value="Professional"' + (item.category==='Professional'?' selected':'') + '>Work</option></select></div>';
    html += '</div>';
    html += '<div class="btn-row" style="margin-bottom:16px;">';
    html += '<div class="input-group" style="margin:0;flex:1;"><label class="input-label">Project</label><select class="input select" id="edit-project">' + projectOptions + '</select></div>';
    html += '<div class="input-group" style="margin:0;flex:1;"><label class="input-label">Due Date</label><input type="date" class="input" id="edit-due" value="' + (item.dueDate || '') + '"></div>';
    html += '</div>';
    html += '<div class="input-group"><label class="input-label">Status</label><select class="input select" id="edit-status">';
    html += '<option value="Next Action"' + (item.status==='Next Action'?' selected':'') + '>Next Action</option>';
    html += '<option value="Waiting For"' + (item.status==='Waiting For'?' selected':'') + '>Waiting For</option>';
    html += '<option value="Someday/Maybe"' + (item.status==='Someday/Maybe'?' selected':'') + '>Someday/Maybe</option></select></div>';
    html += '<button class="btn btn-primary" style="margin-bottom:12px" onclick="saveTask(' + item.id + ')">Save Changes</button>';
    html += '<div class="btn-row"><button class="btn btn-secondary" style="flex:1" onclick="complete(' + item.id + ')">Complete</button><button class="btn btn-danger" style="flex:1" onclick="deleteItem(' + item.id + ')">Delete</button></div>';
    document.getElementById('detail-content').innerHTML = html;
    document.getElementById('modal-detail').classList.add('open');
}

function saveTask(id) {
    var item = null;
    for (var i = 0; i < items.length; i++) { if (items[i].id === id) { item = items[i]; break; } }
    if (!item) return;
    
    var newText = document.getElementById('edit-item').value.trim();
    if (!newText) { toast('Task cannot be empty'); return; }
    
    item.item = newText;
    item.priority = document.getElementById('edit-priority').value;
    item.category = document.getElementById('edit-category').value;
    item.project = document.getElementById('edit-project').value;
    item.dueDate = document.getElementById('edit-due').value || null;
    item.status = document.getElementById('edit-status').value;
    
    save();
    render();
    renderProjects();
    updateStats();
    closeModal();
    toast('Saved');
}

function closeModal() { document.getElementById('modal-detail').classList.remove('open'); }
function complete(id) { 
    var item = null;
    for (var i = 0; i < items.length; i++) { if (items[i].id === id) { item = items[i]; break; } }
    if (item) { 
        // Log completion details
        var now = new Date();
        var createdAt = new Date(item.id); // id is timestamp
        var daysToComplete = Math.round((now - createdAt) / (1000 * 60 * 60 * 24));
        var logEntry = {
            id: item.id,
            task: item.item,
            project: item.project || 'None',
            priority: item.priority,
            category: item.category,
            createdAt: createdAt.toISOString(),
            completedAt: now.toISOString(),
            daysToComplete: daysToComplete,
            completedDay: now.toLocaleDateString('en-US', { weekday: 'long' }),
            completedHour: now.getHours()
        };
        logCompletion(logEntry);
        
        item.status = 'Completed'; 
        item.completedAt = now.toISOString();
        save(); render(); renderProjects(); updateStats(); closeModal(); toast('Done'); 
    } 
}

// Completed tasks log functions
function logCompletion(entry) {
    completedLog = loadCompletedLog();
    completedLog.unshift(entry);
    // Keep last 500 entries
    if (completedLog.length > 500) completedLog = completedLog.slice(0, 500);
    localStorage.setItem(LOG_KEY, JSON.stringify(completedLog));
}

function loadCompletedLog() {
    try {
        var stored = localStorage.getItem(LOG_KEY);
        return stored ? JSON.parse(stored) : [];
    } catch(e) { return []; }
}

function deleteItem(id) { if (confirm('Delete?')) { items = items.filter(function(i) { return i.id !== id; }); save(); render(); renderProjects(); updateStats(); closeModal(); toast('Deleted'); } }

function addItem() {
    var item = { id: Date.now(), item: document.getElementById('f-item').value.trim(), priority: document.getElementById('f-priority').value, status: document.getElementById('f-status').value, category: document.getElementById('f-category').value, project: document.getElementById('f-project').value, dueDate: document.getElementById('f-due').value || null, notes: document.getElementById('f-notes').value };
    if (!item.item) { toast('Enter task'); return; }
    items.unshift(item); save(); render(); renderProjects(); updateStats(); populateProjects();
    document.getElementById('f-item').value = ''; document.getElementById('f-notes').value = ''; document.getElementById('f-due').value = '';
    toast('Added');
    closeAddModal();
}

function switchView(name) {
    var views = document.querySelectorAll('.view');
    for (var i = 0; i < views.length; i++) { views[i].classList.remove('active'); }
    var navItems = document.querySelectorAll('.nav-item');
    for (var j = 0; j < navItems.length; j++) { navItems[j].classList.remove('active'); }
    document.getElementById('v-' + name).classList.add('active');
    var targetBtn = document.querySelector('.nav-item[data-v="' + name + '"]');
    if (targetBtn) targetBtn.classList.add('active');
    
    // Show/hide FAB
    var fab = document.getElementById('fab');
    if (name === 'list') {
        fab.classList.remove('hidden');
    } else {
        fab.classList.add('hidden');
    }
}

// ========== AI VOICE CAPTURE ==========
var SR = window.SpeechRecognition || window.webkitSpeechRecognition;
var recognition = null, isRecording = false, recordingTime = 0, recordingTimer = null, transcript = '';

if (SR) {
    recognition = new SR(); 
    recognition.continuous = true; 
    recognition.interimResults = true;
    recognition.onresult = function(e) { 
        for (var i = e.resultIndex; i < e.results.length; i++) {
            if (e.results[i].isFinal) transcript += e.results[i][0].transcript + ' '; 
        }
        // Show live transcript
        if (transcript.trim()) {
            document.getElementById('mic-status').textContent = 'Listening: "' + transcript.slice(-50) + (transcript.length > 50 ? '...' : '') + '"';
        }
    };
    recognition.onend = function() { 
        // Only restart if still recording AND not stopping
        if (isRecording && !isStopping) {
            try { recognition.start(); } catch(e) { console.log('Restart failed:', e); }
        }
    };
    recognition.onerror = function(e) { 
        console.error('Speech error:', e.error);
        if (e.error === 'not-allowed') {
            document.getElementById('mic-status').textContent = 'Microphone access denied';
        }
        // On error, also stop
        if (e.error === 'aborted' || e.error === 'no-speech') {
            isRecording = false;
            isStopping = false;
        }
    };
}

var isStopping = false;

// Check for token on page load
function checkTokenWarning() {
    var warning = document.getElementById('token-warning');
    if (warning) {
        warning.style.display = getGitHubToken() ? 'none' : 'block';
    }
}

document.getElementById('mic-btn').onclick = function() { 
    if (!recognition) { toast('Speech not supported in this browser'); return; } 
    if (isRecording) stopRecording(); else startRecording(); 
};

function startRecording() {
    isRecording = true; recordingTime = 0; transcript = '';
    var micArea = document.getElementById('capture-area');
    var micBtn = document.getElementById('mic-btn');
    
    micArea.classList.add('recording');
    micBtn.classList.add('recording'); 
    micBtn.textContent = 'Stop';
    document.getElementById('mic-status').textContent = 'Listening...'; 
    document.getElementById('mic-time').textContent = '0:00';
    document.getElementById('result-box').style.display = 'none';
    
    recognition.start();
    recordingTimer = setInterval(function() { 
        recordingTime++; 
        var mins = Math.floor(recordingTime/60);
        var secs = recordingTime % 60;
        document.getElementById('mic-time').textContent = mins + ':' + (secs < 10 ? '0' : '') + secs;
    }, 1000);
}

function stopRecording() {
    isStopping = true;
    isRecording = false; 
    clearInterval(recordingTimer);
    
    // Stop recognition - try multiple times for Safari
    try { recognition.stop(); } catch(e) { console.log('Stop error:', e); }
    try { recognition.abort(); } catch(e) { }
    
    var micArea = document.getElementById('capture-area');
    var micBtn = document.getElementById('mic-btn');
    
    micArea.classList.remove('recording');
    micBtn.classList.remove('recording'); 
    micBtn.textContent = 'Start';
    
    // Reset stopping flag after a delay
    setTimeout(function() { isStopping = false; }, 500);
    
    if (!transcript.trim()) { 
        document.getElementById('mic-status').textContent = 'No speech detected. Tap to try again.'; 
        return; 
    }
    
    micArea.classList.add('processing');
    document.getElementById('mic-status').textContent = 'Processing with AI...';
    document.getElementById('result-box').style.display = 'block';
    document.getElementById('result-content').innerHTML = '<div style="text-align:center;padding:20px;color:var(--text2)">Analyzing your recording...</div>';
    
    processWithAI(transcript);
}

function processWithAI(text) {
    var token = getGitHubToken();
    var micArea = document.getElementById('capture-area');
    
    if (!token) {
        micArea.classList.remove('processing');
        document.getElementById('mic-status').textContent = 'Tap to start recording';
        document.getElementById('result-content').innerHTML = '<div style="color:var(--critical);text-align:center;padding:20px;"><div style="font-weight:600;margin-bottom:8px;">AI not configured</div><div style="font-size:13px;">Go to Settings → GitHub Token to enable smart capture.<br><br>Using basic mode for now...</div></div>';
        setTimeout(function() { fallbackProcess(text); }, 1500);
        return;
    }
    
    console.log('Voice transcript:', text);
    
    var projectList = projects.map(function(p) { return p.name; }).join(', ');
    var existingTasks = items.filter(function(i) { return i.status !== 'Completed'; }).slice(0, 30).map(function(i) { return '"' + i.item.substring(0, 50) + '" [' + (i.project || 'No project') + ']'; }).join(', ');
    
    var prompt = 'You are an AGGRESSIVE GTD task extractor. Your job is to find EVERY possible task in voice recordings.\n\n' +
        'CRITICAL: Extract MORE tasks, not fewer. When in doubt, CREATE A TASK.\n\n' +
        'OPERATIONS:\n' +
        '1. ADD: Any verb phrase = task. "need to", "should", "want to", "have to", "going to", "will", "must", "gotta", "planning to", or just action verbs\n' +
        '2. COMPLETE: "finished", "done", "completed", "already did", "checked off"\n' +
        '3. DELETE: "remove", "delete", "cancel", "forget about", "nevermind"\n' +
        '4. PRIORITY: "urgent", "important", "high priority", "critical", "ASAP"\n\n' +
        'TASK EXTRACTION RULES:\n' +
        '- SPLIT everything: "call X and email Y and review Z" = 3 separate tasks\n' +
        '- Lists are multiple tasks: "buy milk, eggs, bread" = 3 tasks OR 1 task "Buy groceries: milk, eggs, bread"\n' +
        '- "Also" or "and also" = new task\n' +
        '- Different subjects = different tasks\n' +
        '- Follow-ups are tasks: "then after that..." = new task\n' +
        '- Reminders are tasks: "remind me", "don\'t forget" = task\n' +
        '- Questions about action = task: "should I call?" = "Call [person] - decide"\n\n' +
        'PROJECT MATCHING (use EXACT names from this list):\n' + projectList + '\n\n' +
        'Project assignment rules:\n' +
        '- "World Bank" or "WB" or "Anurag" → "World Bank Group"\n' +
        '- "HPE" or "Clearbook" or "sales gamification" → "HPE"\n' +
        '- "CAA" or "Axiom" or "cybersecurity" → "CAA"\n' +
        '- "Riyadh" or "airline" or "safety sense" → "Riyadh Air"\n' +
        '- "AstraZeneca" or "AZ" → "AstraZeneca"\n' +
        '- "BAT" or "webinar" → "BAT"\n' +
        '- "Divya" or "wife" → "Family - Divya"\n' +
        '- "Ananya" or "daughter" → "Family - Ananya"\n' +
        '- "health" or "exercise" or "weight" or "doctor" → "Health" or specific health project\n' +
        '- "AI" or "artificial intelligence" → "AI Strategic" or "AI Skills"\n' +
        '- Work/client mentions → match to client project\n' +
        '- Personal/home/family → match to personal project\n' +
        '- If unclear, use null (no project)\n\n' +
        'EXISTING TASKS (for complete/delete matching):\n' + existingTasks + '\n\n' +
        'PRIORITY GUIDE:\n' +
        '- Critical: "urgent", "ASAP", "emergency", "today", "right now"\n' +
        '- High: "important", "priority", "soon", "this week"\n' +
        '- Medium: default for most tasks\n' +
        '- Low: "someday", "when I have time", "eventually", "maybe"\n\n' +
        'OUTPUT FORMAT (JSON only, no markdown):\n' +
        '{"actions":[{"type":"add","task":"Clean task description","project":"Exact Project Name or null","priority":"Medium"},...],"summary":"X tasks added, Y completed"}\n\n' +
        'REMEMBER: Extract MORE tasks. If someone rambles for 1 minute, there are probably 4-8 tasks embedded. Find them ALL.';

    fetch(GITHUB_MODELS_URL, {
        method: 'POST',
        headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            model: MODEL,
            messages: [
                { role: 'system', content: prompt },
                { role: 'user', content: 'Voice recording:\n\n"' + text + '"\n\nExtract all actions (add, complete, delete, priority changes):' }
            ],
            temperature: 0.1,
            max_tokens: 2000
        })
    })
    .then(function(response) {
        if (!response.ok) {
            return response.text().then(function(errText) {
                console.error('API Error:', response.status, errText);
                throw new Error('API error ' + response.status + '. Check your GitHub token in Settings.');
            });
        }
        return response.json();
    })
    .then(function(data) {
        var content = data.choices[0].message.content;
        console.log('AI Response:', content);
        
        var json;
        try {
            var codeBlock = content.match(/```json\s*([\s\S]*?)\s*```/) || content.match(/```\s*([\s\S]*?)\s*```/);
            json = JSON.parse(codeBlock ? codeBlock[1] : content);
        } catch (e) {
            var objMatch = content.match(/\{[\s\S]*\}/);
            if (objMatch) json = JSON.parse(objMatch[0]);
            else throw new Error('Could not parse AI response');
        }
        
        executeActions(json.actions || [], text, json.summary || '');
    })
    .catch(function(error) {
        console.error('AI Error:', error);
        document.getElementById('result-content').innerHTML = '<div style="color:var(--critical)">AI error: ' + error.message + '</div><div style="margin-top:8px">Trying basic mode...</div>';
        setTimeout(function() { fallbackProcess(text); }, 1000);
    });
}

function executeActions(actions, transcript, interpretation) {
    transcript = transcript || '';
    interpretation = interpretation || '';
    var added = 0, completed = 0, deleted = 0, updated = 0;
    var actionLog = [];
    
    actions.forEach(function(action) {
        if (action.type === 'add' && action.task) {
            var proj = null;
            if (action.project) {
                proj = projects.find(function(p) { return p.name.toLowerCase().indexOf(action.project.toLowerCase()) > -1; });
            }
            items.unshift({
                id: Date.now() + Math.random(),
                item: action.task,
                priority: action.priority || 'Medium',
                status: action.waiting_for ? 'Waiting For' : 'Next Action',
                category: proj ? proj.category : 'Personal',
                project: proj ? proj.name : '',
                waiting_for: action.waiting_for || '',
                notes: ''
            });
            added++;
            var priColor = action.priority === 'Critical' ? 'var(--critical)' : action.priority === 'High' ? 'var(--high)' : 'var(--accent)';
            actionLog.push('<span style="color:' + priColor + '">+</span> ' + action.task + (proj ? ' <span style="color:var(--text3)">→ ' + proj.name + '</span>' : ''));
        }
        else if (action.type === 'complete' && action.match) {
            var matchItem = items.find(function(i) { return i.status !== 'Completed' && i.item.toLowerCase().indexOf(action.match.toLowerCase()) > -1; });
            if (matchItem) { 
                matchItem.status = 'Completed'; 
                completed++; 
                actionLog.push('<span style="color:var(--low)">✓</span> Completed: ' + matchItem.item); 
            } else {
                actionLog.push('<span style="color:var(--text3)">?</span> Could not find: "' + action.match + '"');
            }
        }
        else if (action.type === 'delete' && action.match) {
            var idx = -1;
            for (var i = 0; i < items.length; i++) {
                if (items[i].item.toLowerCase().indexOf(action.match.toLowerCase()) > -1) { idx = i; break; }
            }
            if (idx > -1) { 
                var removed = items.splice(idx, 1)[0]; 
                deleted++; 
                actionLog.push('<span style="color:var(--critical)">✗</span> Deleted: ' + removed.item); 
            } else {
                actionLog.push('<span style="color:var(--text3)">?</span> Could not find: "' + action.match + '"');
            }
        }
        else if (action.type === 'priority' && action.match) {
            var prioItem = items.find(function(i) { return i.status !== 'Completed' && i.item.toLowerCase().indexOf(action.match.toLowerCase()) > -1; });
            if (prioItem && action.priority) { 
                prioItem.priority = action.priority; 
                updated++; 
                actionLog.push('<span style="color:var(--high)">↑</span> Priority → ' + action.priority + ': ' + prioItem.item); 
            }
        }
    });
    
    save(); render(); renderProjects(); updateStats(); populateProjects();
    
    // Reset mic area
    var micArea = document.getElementById('capture-area');
    micArea.classList.remove('processing');
    document.getElementById('mic-status').textContent = 'Tap to start recording';
    
    // Build result display
    var html = '';
    if (actionLog.length) {
        var totalActions = added + completed + deleted + updated;
        var summary = [];
        if (added) summary.push(added + ' added');
        if (completed) summary.push(completed + ' completed');
        if (deleted) summary.push(deleted + ' deleted');
        if (updated) summary.push(updated + ' updated');
        
        html = '<div class="result-count">' + totalActions + '</div>';
        html += '<div class="result-label">' + summary.join(', ') + '</div>';
        html += '<div class="result-actions">';
        for (var i = 0; i < actionLog.length; i++) {
            html += '<div>' + actionLog[i] + '</div>';
        }
        html += '</div>';
    } else {
        html = '<div style="text-align:center;padding:20px;"><div style="font-size:18px;margin-bottom:8px;">No actions found</div><div style="color:var(--text3);font-size:13px;">Try being more specific, like "Add call John" or "I finished the report"</div></div>';
    }
    
    // Show transcript for reference
    if (transcript) {
        html += '<div class="result-transcript"><b>You said:</b> "' + transcript + '"</div>';
    }
    if (interpretation) {
        html += '<div style="font-size:11px;color:var(--text3);margin-top:4px">' + interpretation + '</div>';
    }
    
    document.getElementById('result-content').innerHTML = html;
}

function fallbackProcess(text) {
    var chunks = text.split(/[.!?]+/).filter(function(s) { return s.trim().length > 5; });
    var added = 0;
    
    chunks.forEach(function(chunk) {
        var lower = chunk.toLowerCase();
        if (/finished|completed|done|checked off/.test(lower)) return;
        
        var taskText = chunk.trim().replace(/^(i need to|have to|should|must|want to)\s*/i, '');
        taskText = taskText.charAt(0).toUpperCase() + taskText.slice(1);
        
        var task = { 
            id: Date.now() + Math.random(), 
            item: taskText, 
            priority: 'Medium', 
            status: 'Next Action', 
            category: 'Personal', 
            project: '', 
            notes: '' 
        };
        
        if (/urgent|critical|asap/.test(lower)) task.priority = 'Critical';
        else if (/important|priority/.test(lower)) task.priority = 'High';
        
        if (/work|office|client|project/.test(lower)) task.category = 'Professional';
        
        for (var i = 0; i < projects.length; i++) {
            var p = projects[i];
            if (lower.indexOf(p.name.toLowerCase().split(' ')[0].toLowerCase()) > -1) { 
                task.project = p.name; 
                task.category = p.category; 
                break; 
            }
        }
        
        if (task.item.length > 5) { items.unshift(task); added++; }
    });
    
    save(); render(); updateStats();
    document.getElementById('mic-status').textContent = 'Tap to start';
    document.getElementById('result-content').innerHTML = '<div class="result-count">' + added + '</div><div class="result-label">tasks added (basic mode)</div>';
}

// ========== TEXT TO TASKS ==========
function processTextToTasks() {
    var text = document.getElementById('text-input').value.trim();
    var resultDiv = document.getElementById('text-result');
    
    if (!text) {
        resultDiv.innerHTML = '<div style="color:var(--critical);text-align:center;">Please paste some text first</div>';
        return;
    }
    
    var token = getGitHubToken();
    if (!token) {
        resultDiv.innerHTML = '<div style="color:var(--critical);text-align:center;">AI not configured. Go to Settings to add your GitHub Token.</div>';
        return;
    }
    
    resultDiv.innerHTML = '<div style="text-align:center;padding:20px;"><div class="loading"></div><div style="margin-top:8px;color:var(--text2);">Extracting tasks...</div></div>';
    
    var projectList = projects.map(function(p) { return p.name; }).join(', ');
    
    var prompt = 'You are a GTD task extraction expert. Your job is to extract EVERY actionable task from the text and organize them properly.\n\n' +
        'EXTRACTION RULES:\n' +
        '1. Extract ALL actionable items - anything that needs to be done\n' +
        '2. Split compound tasks: "call X and email Y" = 2 tasks\n' +
        '3. Lists become tasks: "buy milk, eggs, bread" = 1 task "Buy groceries: milk, eggs, bread" OR 3 separate tasks\n' +
        '4. Keep task descriptions clear and actionable\n' +
        '5. Sequence tasks logically (dependencies first)\n\n' +
        'PROJECT MATCHING (use EXACT names from this list or null if no match):\n' + projectList + '\n\n' +
        'Project hints:\n' +
        '- "World Bank" or "WB" or "Anurag" = "World Bank Group"\n' +
        '- "HPE" or "Clearbook" = "HPE"\n' +
        '- "CAA" or "Axiom" = "CAA"\n' +
        '- "Riyadh" or "airline" = "Riyadh Air"\n' +
        '- "Divya" or "wife" = "Family - Divya"\n' +
        '- "Ananya" or "daughter" = "Family - Ananya"\n' +
        '- health/exercise/doctor = Health project\n' +
        '- AI topics = "AI Strategic" or "AI Skills"\n\n' +
        'CATEGORY:\n' +
        '- Work/client/business = "Professional"\n' +
        '- Personal/family/health/home = "Personal"\n\n' +
        'PRIORITY:\n' +
        '- Critical: urgent, ASAP, emergency, today\n' +
        '- High: important, priority, this week\n' +
        '- Medium: default\n' +
        '- Low: someday, eventually, maybe\n\n' +
        'OUTPUT FORMAT (JSON only, no markdown):\n' +
        '{"tasks":[{"task":"Clear action description","project":"Exact Project Name or null","category":"Professional or Personal","priority":"Medium","sequence":1},...],"summary":"Found X tasks: Y professional, Z personal"}\n\n' +
        'IMPORTANT: sequence number indicates the order tasks should be done (1 = first). Group by project/context when logical.';

    fetch(GITHUB_MODELS_URL, {
        method: 'POST',
        headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            model: MODEL,
            messages: [
                { role: 'system', content: prompt },
                { role: 'user', content: 'Extract and organize all tasks from this text:\n\n"' + text + '"' }
            ],
            temperature: 0.1,
            max_tokens: 3000
        })
    })
    .then(function(response) {
        if (!response.ok) {
            return response.text().then(function(errText) {
                throw new Error('API error ' + response.status);
            });
        }
        return response.json();
    })
    .then(function(data) {
        var content = data.choices[0].message.content;
        console.log('Text-to-Tasks Response:', content);
        
        var json;
        try {
            var codeBlock = content.match(/```json\s*([\s\S]*?)\s*```/) || content.match(/```\s*([\s\S]*?)\s*```/);
            json = JSON.parse(codeBlock ? codeBlock[1] : content);
        } catch (e) {
            var objMatch = content.match(/\{[\s\S]*\}/);
            if (objMatch) json = JSON.parse(objMatch[0]);
            else throw new Error('Could not parse AI response');
        }
        
        var tasks = json.tasks || [];
        if (tasks.length === 0) {
            resultDiv.innerHTML = '<div style="color:var(--text2);text-align:center;">No tasks found in the text</div>';
            return;
        }
        
        // Sort by sequence
        tasks.sort(function(a, b) { return (a.sequence || 99) - (b.sequence || 99); });
        
        // Preview tasks before adding
        var previewHtml = '<div style="margin-bottom:12px;font-weight:600;">' + tasks.length + ' tasks found:</div>';
        for (var i = 0; i < tasks.length; i++) {
            var t = tasks[i];
            previewHtml += '<div style="padding:8px;background:var(--surface2);border-radius:6px;margin-bottom:6px;font-size:13px;">';
            previewHtml += '<div>' + (i+1) + '. ' + t.task + '</div>';
            previewHtml += '<div style="font-size:11px;color:var(--text3);margin-top:4px;">';
            previewHtml += t.category + ' | ' + (t.project || 'No project') + ' | ' + t.priority;
            previewHtml += '</div></div>';
        }
        previewHtml += '<div class="btn-row" style="margin-top:12px;">';
        previewHtml += '<button class="btn btn-primary" style="flex:1" onclick="addExtractedTasks()">Add All Tasks</button>';
        previewHtml += '<button class="btn btn-secondary" style="flex:1" onclick="clearTextResult()">Cancel</button>';
        previewHtml += '</div>';
        
        resultDiv.innerHTML = previewHtml;
        
        // Store tasks for adding
        window.pendingTextTasks = tasks;
    })
    .catch(function(error) {
        console.error('Text-to-Tasks Error:', error);
        resultDiv.innerHTML = '<div style="color:var(--critical);text-align:center;">Error: ' + error.message + '</div>';
    });
}

function addExtractedTasks() {
    var tasks = window.pendingTextTasks || [];
    var added = 0;
    
    for (var i = 0; i < tasks.length; i++) {
        var t = tasks[i];
        var newItem = {
            id: Date.now() + i,
            item: t.task,
            priority: t.priority || 'Medium',
            status: 'Next Action',
            category: t.category || 'Personal',
            project: t.project || '',
            notes: ''
        };
        items.unshift(newItem);
        added++;
    }
    
    save();
    render();
    updateStats();
    
    document.getElementById('text-result').innerHTML = '<div style="text-align:center;color:var(--low);font-weight:600;">' + added + ' tasks added!</div>';
    document.getElementById('text-input').value = '';
    window.pendingTextTasks = null;
    
    toast(added + ' tasks added');
}

function clearTextResult() {
    document.getElementById('text-result').innerHTML = '';
    window.pendingTextTasks = null;
}

// ========== EXPORT/IMPORT ==========
function exportJSON() { 
    var blob = new Blob([JSON.stringify({ items: items, projects: projects }, null, 2)], { type: 'application/json' }); 
    var a = document.createElement('a'); 
    a.href = URL.createObjectURL(blob); 
    a.download = 'gtd-backup.json'; 
    a.click(); 
    toast('Downloaded'); 
}
function importJSON(file) { 
    if (!file) return; 
    var reader = new FileReader(); 
    reader.onload = function(e) { 
        try { 
            var data = JSON.parse(e.target.result); 
            if (data.items) items = data.items; 
            if (data.projects) projects = data.projects; 
            save(); render(); renderProjects(); updateStats(); populateProjects(); 
            toast('Imported'); 
        } catch (err) { 
            toast('Invalid file'); 
        } 
    }; 
    reader.readAsText(file); 
}
function clearCompleted() { if (confirm('Clear completed?')) { items = items.filter(function(i) { return i.status !== 'Completed'; }); save(); render(); updateStats(); toast('Cleared'); } }
function reloadSampleData() { 
    if (confirm('Reload all 101 sample items? This will replace your current data.')) { 
        if (typeof GTD_INITIAL_DATA !== 'undefined') {
            items = GTD_INITIAL_DATA.map(function(item, i) { 
                var newItem = {};
                for (var key in item) { if (key !== 'context') newItem[key] = item[key]; }
                newItem.id = item.id || i + 1;
                return newItem;
            });
            projects = DEFAULT_PROJECTS;
            save(); render(); renderProjects(); updateStats(); populateProjects();
            toast('Loaded 101 items');
        } else {
            toast('Sample data not available');
        }
    } 
}
function resetAll() { if (confirm('Reset all?')) { localStorage.removeItem(STORAGE_KEY); location.reload(); } }
function toast(msg) { var t = document.getElementById('toast'); t.textContent = msg; t.classList.add('show'); setTimeout(function() { t.classList.remove('show'); }, 2000); }

// ========== COMPLETION LOG FUNCTIONS ==========
function showCompletionLog() {
    var log = loadCompletedLog();
    var html = '<div class="modal-header"><div class="modal-title">Completion Log (' + log.length + ' tasks)</div><button class="close-btn" onclick="closeLogModal()">x</button></div>';
    
    if (log.length === 0) {
        html += '<p style="text-align:center;color:var(--text3);padding:40px;">No completed tasks yet</p>';
    } else {
        html += '<div style="padding:16px;">';
        // Group by date
        var byDate = {};
        for (var i = 0; i < log.length; i++) {
            var entry = log[i];
            var date = entry.completedAt ? entry.completedAt.split('T')[0] : 'Unknown';
            if (!byDate[date]) byDate[date] = [];
            byDate[date].push(entry);
        }
        
        var dates = Object.keys(byDate).sort().reverse();
        for (var d = 0; d < dates.length; d++) {
            var date = dates[d];
            var entries = byDate[date];
            html += '<div style="font-weight:600;margin:16px 0 8px;color:var(--text2);">' + formatLogDate(date) + ' (' + entries.length + ')</div>';
            for (var j = 0; j < entries.length; j++) {
                var e = entries[j];
                var daysText = e.daysToComplete === 0 ? 'Same day' : e.daysToComplete === 1 ? '1 day' : e.daysToComplete + ' days';
                html += '<div style="padding:8px 0;border-bottom:1px solid var(--border);font-size:13px;">';
                html += '<div style="font-weight:500;">' + e.task + '</div>';
                html += '<div style="color:var(--text3);font-size:11px;margin-top:4px;">';
                html += e.priority + ' | ' + (e.project || 'No project') + ' | ' + daysText + ' to complete';
                html += '</div></div>';
            }
        }
        html += '</div>';
    }
    
    document.getElementById('log-content').innerHTML = html;
    document.getElementById('modal-log').classList.add('open');
}

function showProductivityStats() {
    var log = loadCompletedLog();
    var html = '<div class="modal-header"><div class="modal-title">Productivity Stats</div><button class="close-btn" onclick="closeLogModal()">x</button></div>';
    
    if (log.length < 5) {
        html += '<p style="text-align:center;color:var(--text3);padding:40px;">Complete more tasks to see stats</p>';
    } else {
        // Calculate stats
        var totalDays = 0, count = 0;
        var byProject = {}, byPriority = {}, byDay = {}, byHour = {};
        var last7days = 0, last30days = 0;
        var now = new Date();
        
        for (var i = 0; i < log.length; i++) {
            var e = log[i];
            totalDays += e.daysToComplete || 0;
            count++;
            
            // By project
            var proj = e.project || 'No project';
            byProject[proj] = (byProject[proj] || 0) + 1;
            
            // By priority
            byPriority[e.priority] = (byPriority[e.priority] || 0) + 1;
            
            // By day of week
            byDay[e.completedDay] = (byDay[e.completedDay] || 0) + 1;
            
            // By hour
            var hourBucket = e.completedHour < 12 ? 'Morning (6-12)' : e.completedHour < 17 ? 'Afternoon (12-5)' : 'Evening (5-10)';
            byHour[hourBucket] = (byHour[hourBucket] || 0) + 1;
            
            // Recent activity
            var completedDate = new Date(e.completedAt);
            var daysAgo = Math.floor((now - completedDate) / (1000 * 60 * 60 * 24));
            if (daysAgo <= 7) last7days++;
            if (daysAgo <= 30) last30days++;
        }
        
        var avgDays = (totalDays / count).toFixed(1);
        
        html += '<div style="padding:16px;">';
        
        // Summary
        html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px;">';
        html += '<div style="background:var(--surface2);padding:16px;border-radius:8px;text-align:center;"><div style="font-size:24px;font-weight:600;">' + log.length + '</div><div style="font-size:11px;color:var(--text3);">Total Completed</div></div>';
        html += '<div style="background:var(--surface2);padding:16px;border-radius:8px;text-align:center;"><div style="font-size:24px;font-weight:600;">' + avgDays + '</div><div style="font-size:11px;color:var(--text3);">Avg Days to Complete</div></div>';
        html += '<div style="background:var(--surface2);padding:16px;border-radius:8px;text-align:center;"><div style="font-size:24px;font-weight:600;">' + last7days + '</div><div style="font-size:11px;color:var(--text3);">Last 7 Days</div></div>';
        html += '<div style="background:var(--surface2);padding:16px;border-radius:8px;text-align:center;"><div style="font-size:24px;font-weight:600;">' + last30days + '</div><div style="font-size:11px;color:var(--text3);">Last 30 Days</div></div>';
        html += '</div>';
        
        // Top projects
        html += '<div style="font-weight:600;margin:16px 0 8px;">Top Projects</div>';
        var projArr = Object.keys(byProject).map(function(k) { return {name:k, count:byProject[k]}; }).sort(function(a,b) { return b.count - a.count; }).slice(0,5);
        for (var p = 0; p < projArr.length; p++) {
            html += '<div style="display:flex;justify-content:space-between;padding:4px 0;font-size:13px;"><span>' + projArr[p].name + '</span><span style="color:var(--text3);">' + projArr[p].count + '</span></div>';
        }
        
        // By priority
        html += '<div style="font-weight:600;margin:16px 0 8px;">By Priority</div>';
        var priorities = ['Critical', 'High', 'Medium', 'Low'];
        for (var pr = 0; pr < priorities.length; pr++) {
            var pName = priorities[pr];
            if (byPriority[pName]) {
                html += '<div style="display:flex;justify-content:space-between;padding:4px 0;font-size:13px;"><span>' + pName + '</span><span style="color:var(--text3);">' + byPriority[pName] + '</span></div>';
            }
        }
        
        // Best days
        html += '<div style="font-weight:600;margin:16px 0 8px;">Most Productive Days</div>';
        var dayArr = Object.keys(byDay).map(function(k) { return {name:k, count:byDay[k]}; }).sort(function(a,b) { return b.count - a.count; });
        for (var dd = 0; dd < dayArr.length; dd++) {
            html += '<div style="display:flex;justify-content:space-between;padding:4px 0;font-size:13px;"><span>' + dayArr[dd].name + '</span><span style="color:var(--text3);">' + dayArr[dd].count + '</span></div>';
        }
        
        html += '</div>';
    }
    
    document.getElementById('log-content').innerHTML = html;
    document.getElementById('modal-log').classList.add('open');
}

function formatLogDate(dateStr) {
    var d = new Date(dateStr);
    var today = new Date();
    var yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);
    
    if (dateStr === today.toISOString().split('T')[0]) return 'Today';
    if (dateStr === yesterday.toISOString().split('T')[0]) return 'Yesterday';
    return d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
}

function closeLogModal() { document.getElementById('modal-log').classList.remove('open'); }

function exportCompletionLog() {
    var log = loadCompletedLog();
    if (log.length === 0) { toast('No data to export'); return; }
    
    var csv = 'Task,Project,Priority,Category,Created,Completed,Days to Complete,Day,Hour\n';
    for (var i = 0; i < log.length; i++) {
        var e = log[i];
        csv += '"' + (e.task || '').replace(/"/g, '""') + '",';
        csv += '"' + (e.project || '') + '",';
        csv += e.priority + ',';
        csv += e.category + ',';
        csv += e.createdAt + ',';
        csv += e.completedAt + ',';
        csv += e.daysToComplete + ',';
        csv += e.completedDay + ',';
        csv += e.completedHour + '\n';
    }
    
    var blob = new Blob([csv], { type: 'text/csv' });
    var a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'gtd-completion-log.csv';
    a.click();
    toast('Downloaded CSV');
}

function setupListeners() {
    // Quick filters (new design)
    var qfBtns = document.querySelectorAll('.qf');
    for (var i = 0; i < qfBtns.length; i++) {
        (function(btn) {
            btn.onclick = function() {
                var allQf = document.querySelectorAll('.qf');
                for (var j = 0; j < allQf.length; j++) { allQf[j].classList.remove('active'); }
                btn.classList.add('active');
                
                // Handle priority filter
                if (btn.dataset.p) {
                    filters.status = 'all';
                    filters.priority = btn.dataset.p;
                } else {
                    filters.status = btn.dataset.status;
                    filters.priority = null;
                }
                render();
            };
        })(qfBtns[i]);
    }
    
    // Navigation
    var navItems = document.querySelectorAll('.nav-item');
    for (var n = 0; n < navItems.length; n++) {
        (function(btn) {
            btn.onclick = function() { switchView(btn.dataset.v); };
        })(navItems[n]);
    }
    
    // Modals close on background click
    document.getElementById('modal-detail').onclick = function(e) { if (e.target.id === 'modal-detail') closeModal(); };
    document.getElementById('modal-project').onclick = function(e) { if (e.target.id === 'modal-project') closeProjectModal(); };
    document.getElementById('modal-log').onclick = function(e) { if (e.target.id === 'modal-log') closeLogModal(); };
    document.getElementById('modal-add').onclick = function(e) { if (e.target.id === 'modal-add') closeAddModal(); };
}

function showAddModal() { document.getElementById('modal-add').classList.add('open'); }
function closeAddModal() { document.getElementById('modal-add').classList.remove('open'); }
</script>
</body>
</html>