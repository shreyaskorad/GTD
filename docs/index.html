<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#fff">
    <title>GTD</title>
    <link rel="manifest" href="manifest.json">
    <script src="data.js"></script>
    <style>
:root { --bg:#fafafa; --surface:#fff; --surface2:#f5f5f5; --border:#e0e0e0; --text:#222; --text2:#666; --text3:#999; --accent:#0066cc; --critical:#d32f2f; --high:#f57c00; --medium:#fbc02d; --low:#388e3c; }
* { box-sizing:border-box; margin:0; padding:0; -webkit-tap-highlight-color:rgba(0,0,0,0.1); }
body { font-family:-apple-system,system-ui,sans-serif; background:var(--bg); color:var(--text); min-height:100vh; font-size:14px; touch-action:manipulation; }
.app { max-width:600px; margin:0 auto; padding-bottom:56px; }
header { padding:16px; background:var(--surface); border-bottom:1px solid var(--border); }
header h1 { font-size:18px; font-weight:600; }
.stats { display:flex; gap:20px; margin-top:8px; font-size:12px; color:var(--text2); }
.tabs { display:flex; background:var(--surface); border-bottom:1px solid var(--border); }
.tab { flex:1; padding:12px; text-align:center; font-size:13px; color:var(--text2); background:none; border:none; cursor:pointer; }
.tab.active { color:var(--accent); font-weight:500; border-bottom:2px solid var(--accent); }
.filters { padding:12px 16px; background:var(--surface); border-bottom:1px solid var(--border); display:flex; gap:8px; flex-wrap:wrap; }
.filter { padding:6px 12px; font-size:12px; border-radius:16px; border:1px solid var(--border); background:var(--surface); color:var(--text2); cursor:pointer; }
.filter.active { background:var(--accent); color:#fff; border-color:var(--accent); }
.search { flex:1; min-width:140px; padding:8px 12px; font-size:13px; border:1px solid var(--border); border-radius:6px; background:var(--surface); color:var(--text); }
.list { padding:8px 16px; }
.item { padding:14px; margin-bottom:8px; background:var(--surface); border:1px solid var(--border); border-radius:8px; cursor:pointer; }
.item-row { display:flex; justify-content:space-between; align-items:flex-start; gap:12px; }
.item-title { font-size:14px; flex:1; line-height:1.4; }
.item-priority { width:8px; height:8px; border-radius:50%; flex-shrink:0; margin-top:5px; }
.item-priority.critical { background:var(--critical); }
.item-priority.high { background:var(--high); }
.item-priority.medium { background:var(--medium); }
.item-priority.low { background:var(--low); }
.item-meta { font-size:12px; color:var(--text2); margin-top:8px; }
.item-meta span { margin-right:16px; }
.capture { padding:16px; }
.section-title { font-size:15px; font-weight:600; margin-bottom:16px; }
.mic-area { text-align:center; padding:40px 32px; background:var(--surface); border:1px solid var(--border); border-radius:12px; margin-bottom:16px; }
.mic-btn { width:80px; height:80px; border-radius:50%; border:2px solid var(--border); background:var(--surface); color:var(--text); font-size:14px; font-weight:500; cursor:pointer; }
.mic-btn.recording { border-color:var(--critical); color:var(--critical); }
.mic-status { margin-top:16px; font-size:13px; color:var(--text2); }
.mic-time { font-size:32px; font-weight:300; margin-top:8px; font-variant-numeric:tabular-nums; }
.mic-hint { margin-top:16px; font-size:12px; color:var(--text3); line-height:1.5; }
.result-box { background:var(--surface); border:1px solid var(--border); border-radius:8px; padding:16px; margin-bottom:16px; }
.result-count { font-size:24px; font-weight:600; color:var(--accent); }
.result-label { font-size:13px; color:var(--text2); margin-top:4px; }
.result-actions { margin-top:12px; font-size:13px; color:var(--text2); text-align:left; line-height:1.6; }
.result-actions div { padding:4px 0; border-bottom:1px solid var(--border); }
.result-actions div:last-child { border-bottom:none; }
.btn { padding:12px 20px; font-size:14px; border:none; border-radius:8px; cursor:pointer; font-weight:500; }
.btn-primary { background:var(--accent); color:#fff; }
.btn-secondary { background:var(--surface2); color:var(--text); }
.btn-row { display:flex; gap:10px; }
.form { padding:16px; }
.form-group { margin-bottom:16px; }
.form-label { display:block; font-size:12px; color:var(--text2); margin-bottom:6px; font-weight:500; }
.form-input, .form-select, .form-textarea { width:100%; padding:12px; font-size:14px; border:1px solid var(--border); border-radius:8px; background:var(--surface); color:var(--text); }
.form-textarea { min-height:80px; resize:vertical; font-family:inherit; }
.form-row { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
.modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); z-index:100; align-items:flex-end; }
.modal.open { display:flex; }
.modal-content { background:var(--surface); width:100%; max-width:500px; margin:0 auto; max-height:80vh; overflow-y:auto; border-radius:16px 16px 0 0; padding:20px; }
.modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
.modal-title { font-size:16px; font-weight:600; }
.close-btn { width:32px; height:32px; border-radius:50%; border:1px solid var(--border); background:var(--surface); color:var(--text2); font-size:18px; cursor:pointer; }
.nav { position:fixed; bottom:0; left:0; right:0; background:var(--surface); border-top:1px solid var(--border); display:flex; padding-bottom:env(safe-area-inset-bottom); }
.nav-btn { flex:1; padding:10px; text-align:center; font-size:11px; color:var(--text3); background:none; border:none; cursor:pointer; font-weight:500; }
.nav-btn.active { color:var(--accent); }
.settings { padding:16px; }
.settings-group { background:var(--surface); border:1px solid var(--border); border-radius:12px; margin-bottom:16px; overflow:hidden; }
.settings-item { display:block; width:100%; text-align:left; padding:14px 16px; border:none; border-bottom:1px solid var(--border); font-size:14px; cursor:pointer; background:var(--surface); color:var(--text); font-family:inherit; }
.settings-item:last-child { border-bottom:none; }
.settings-item:active { background:var(--surface2); }
.settings-label { font-size:12px; color:var(--text2); padding:16px 16px 8px; font-weight:500; text-transform:uppercase; }
.danger { color:var(--critical); }
.view { display:none; }
.view.active { display:block; }
.toast { position:fixed; bottom:70px; left:50%; transform:translateX(-50%) translateY(50px); background:var(--text); color:var(--surface); padding:12px 24px; border-radius:8px; font-size:13px; transition:transform 0.2s; z-index:200; }
.toast.show { transform:translateX(-50%) translateY(0); }
.proj-card { background:var(--surface); border:1px solid var(--border); border-radius:12px; margin-bottom:12px; overflow:hidden; }
.proj-header { padding:14px 16px; border-bottom:1px solid var(--border); }
.proj-name { font-size:15px; font-weight:600; margin-bottom:4px; }
.proj-status { display:inline-block; font-size:11px; padding:2px 8px; border-radius:10px; background:var(--surface2); color:var(--text2); }
.proj-status.active { background:#e3f2fd; color:#1976d2; }
.proj-status.on-hold { background:#fff3e0; color:#f57c00; }
.proj-status.completed { background:#e8f5e9; color:#388e3c; }
.proj-body { padding:14px 16px; }
.proj-meta { display:grid; grid-template-columns:1fr 1fr; gap:8px 16px; font-size:12px; margin-bottom:12px; }
.proj-meta-label { color:var(--text3); }
.proj-meta-value { color:var(--text); font-weight:500; }
.proj-progress { height:4px; background:var(--surface2); border-radius:2px; margin-top:8px; }
.proj-progress-bar { height:100%; background:var(--accent); border-radius:2px; }
.proj-tasks { font-size:12px; color:var(--text2); margin-top:8px; }
.auth-overlay { position:fixed; inset:0; background:var(--bg); z-index:1000; display:flex; align-items:center; justify-content:center; }
.auth-box { background:var(--surface); border:1px solid var(--border); border-radius:16px; padding:32px; width:90%; max-width:320px; text-align:center; }
.auth-title { font-size:18px; font-weight:600; margin-bottom:8px; }
.auth-desc { font-size:13px; color:var(--text2); margin-bottom:24px; }
.auth-input { width:100%; padding:14px; font-size:16px; border:1px solid var(--border); border-radius:8px; text-align:center; letter-spacing:8px; margin-bottom:16px; }
.auth-error { color:var(--critical); font-size:12px; margin-bottom:12px; display:none; }
.hidden { display:none !important; }
.ai-badge { display:inline-block; font-size:10px; padding:2px 6px; border-radius:4px; background:#e8f5e9; color:#388e3c; margin-left:8px; }
.loading { display:inline-block; width:16px; height:16px; border:2px solid var(--border); border-top-color:var(--accent); border-radius:50%; animation:spin 1s linear infinite; }
@keyframes spin { to { transform:rotate(360deg); } }
    </style>
</head>
<body>
<div class="auth-overlay" id="auth-screen">
    <div class="auth-box">
        <div class="auth-title" id="auth-title">GTD Access</div>
        <div class="auth-desc" id="auth-desc">Enter your PIN to continue</div>
        <div class="auth-error" id="auth-error">Incorrect PIN</div>
        <input type="password" class="auth-input" id="auth-pin" maxlength="6" placeholder="------" inputmode="numeric" autocomplete="off">
        <button class="btn btn-primary" style="width:100%" onclick="checkAuth()">Unlock</button>
    </div>
</div>

<div class="app hidden" id="main-app">
    <header>
        <h1>GTD <span class="ai-badge">AI</span></h1>
        <div class="stats">
            <span><span id="s-critical">0</span> critical</span>
            <span><span id="s-high">0</span> high</span>
            <span><span id="s-total">0</span> total</span>
        </div>
    </header>

    <div class="view active" id="v-list">
        <div class="tabs">
            <button class="tab active" data-status="all">All</button>
            <button class="tab" data-status="Next Action">Actions</button>
            <button class="tab" data-status="Waiting For">Waiting</button>
        </div>
        <div class="filters">
            <input type="text" class="search" id="search" placeholder="Search...">
            <button class="filter" data-p="Critical">Critical</button>
            <button class="filter" data-p="High">High</button>
        </div>
        <div class="list" id="items-list"></div>
    </div>

    <div class="view" id="v-projects">
        <div class="capture">
            <div class="section-title">Projects</div>
            <div id="projects-list"></div>
            <button class="btn btn-primary" style="width:100%;margin-top:16px" onclick="showAddProject()">New Project</button>
        </div>
    </div>

    <div class="view" id="v-capture">
        <div class="capture">
            <div class="section-title">AI Voice Capture</div>
            <div class="mic-area">
                <button class="mic-btn" id="mic-btn">Start</button>
                <div class="mic-status" id="mic-status">Tap to start</div>
                <div class="mic-time" id="mic-time">0:00</div>
                <div class="mic-hint">Speak naturally. Say things like "I finished the World Bank task" or "Add follow up with Anurag to CAA project"</div>
            </div>
            <div class="result-box" id="result-box" style="display:none;">
                <div id="result-content"></div>
            </div>
        </div>
    </div>

    <div class="view" id="v-add">
        <div class="form">
            <div class="section-title">Quick Add</div>
            <div class="form-group">
                <label class="form-label">Task</label>
                <input class="form-input" id="f-item" placeholder="What needs to be done?">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Priority</label>
                    <select class="form-select" id="f-priority"><option value="Critical">Critical</option><option value="High">High</option><option value="Medium" selected>Medium</option><option value="Low">Low</option></select>
                </div>
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select class="form-select" id="f-status"><option value="Next Action">Next Action</option><option value="Waiting For">Waiting For</option><option value="Someday/Maybe">Someday/Maybe</option></select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select class="form-select" id="f-category"><option value="Personal">Personal</option><option value="Professional">Professional</option></select>
                </div>
                <div class="form-group">
                    <label class="form-label">Project</label>
                    <select class="form-select" id="f-project"></select>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Due Date</label>
                <input type="date" class="form-input" id="f-due">
            </div>
            <div class="form-group">
                <label class="form-label">Notes</label>
                <input class="form-input" id="f-notes" placeholder="Additional details">
            </div>
            <button class="btn btn-primary" style="width:100%" onclick="addItem()">Add</button>
        </div>
    </div>

    <div class="view" id="v-settings">
        <div class="settings">
            <div class="settings-label">AI Setup</div>
            <div class="settings-group">
                <button class="settings-item" type="button" onclick="setupGitHubToken()">GitHub Token <span id="token-status" style="float:right;color:var(--text3)">Not set</span></button>
            </div>
            <div class="settings-label">Security</div>
            <div class="settings-group">
                <button class="settings-item" type="button" onclick="changePin()">Change PIN</button>
                <button class="settings-item" type="button" onclick="lockApp()">Lock App</button>
            </div>
            <div class="settings-label">Data</div>
            <div class="settings-group">
                <button class="settings-item" type="button" onclick="exportJSON()">Export JSON</button>
                <button class="settings-item" type="button" onclick="document.getElementById('import-file').click()">Import JSON</button>
                <input type="file" id="import-file" accept=".json" style="display:none" onchange="importJSON(this.files[0])">
            </div>
            <div class="settings-label">Manage</div>
            <div class="settings-group">
                <button class="settings-item" type="button" onclick="clearCompleted()">Clear completed</button>
                <button class="settings-item" type="button" onclick="reloadSampleData()">Reload sample data (101 items)</button>
                <button class="settings-item danger" type="button" onclick="resetAll()">Reset all data</button>
            </div>
            <div style="text-align:center;padding:24px;color:var(--text3);font-size:12px;">GTD v6.2 - AI Powered</div>
        </div>
    </div>
</div>

<nav class="nav hidden" id="main-nav">
    <button class="nav-btn active" data-v="list">Tasks</button>
    <button class="nav-btn" data-v="projects">Projects</button>
    <button class="nav-btn" data-v="capture">Capture</button>
    <button class="nav-btn" data-v="add">Add</button>
    <button class="nav-btn" data-v="settings">Settings</button>
</nav>

<div class="modal" id="modal-detail"><div class="modal-content" id="detail-content"></div></div>
<div class="modal" id="modal-project"><div class="modal-content" id="project-content"></div></div>
<div class="toast" id="toast"></div>

<script>
// ========== SAFARI FIX ==========
// Enable touch events for Safari iOS - required for onclick to work on non-native elements
try { document.addEventListener('touchstart', function() {}, {passive: true}); } catch(e) { document.addEventListener('touchstart', function() {}); }

// Debug: Log errors to help diagnose Safari issues
window.onerror = function(msg, url, line, col, error) {
    alert('Error: ' + msg + '\nLine: ' + line);
    return false;
};

// ========== CONFIG ==========
const STORAGE_KEY = 'gtd_ai_v6';
const PIN_KEY = 'gtd_pin_hash';
const TOKEN_KEY = 'gtd_gh_token';
const SESSION_KEY = 'gtd_session';
const DEVICE_KEY = 'gtd_device_id';

// GitHub Models API endpoint
const GITHUB_MODELS_URL = 'https://models.inference.ai.azure.com/chat/completions';
const MODEL = 'gpt-4o-mini'; // Fast and cheap, great for this use case

// ========== SECURITY ==========
function getDeviceId() {
    let id = localStorage.getItem(DEVICE_KEY);
    if (!id) { id = 'dev_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9); localStorage.setItem(DEVICE_KEY, id); }
    return id;
}

function hashPin(pin) {
    let hash = 0; const salt = getDeviceId(); const str = pin + salt;
    for (let i = 0; i < str.length; i++) { hash = ((hash << 5) - hash) + str.charCodeAt(i); hash = hash & hash; }
    return hash.toString();
}

function isFirstTime() { return !localStorage.getItem(PIN_KEY); }
function setupPin(pin) { localStorage.setItem(PIN_KEY, hashPin(pin)); sessionStorage.setItem(SESSION_KEY, 'unlocked'); }
function verifyPin(pin) { return localStorage.getItem(PIN_KEY) === hashPin(pin); }
function isSessionValid() { return sessionStorage.getItem(SESSION_KEY) === 'unlocked'; }

function checkAuth() {
    const pin = document.getElementById('auth-pin').value;
    if (pin.length < 4) { document.getElementById('auth-error').style.display = 'block'; document.getElementById('auth-error').textContent = 'PIN must be at least 4 digits'; return; }
    if (isFirstTime()) { setupPin(pin); unlockApp(); toast('PIN set!'); }
    else if (verifyPin(pin)) { sessionStorage.setItem(SESSION_KEY, 'unlocked'); unlockApp(); }
    else { document.getElementById('auth-error').style.display = 'block'; document.getElementById('auth-error').textContent = 'Incorrect PIN'; document.getElementById('auth-pin').value = ''; }
}

function unlockApp() {
    document.getElementById('auth-screen').classList.add('hidden');
    document.getElementById('main-app').classList.remove('hidden');
    document.getElementById('main-nav').classList.remove('hidden');
    init();
}

function lockApp() { sessionStorage.removeItem(SESSION_KEY); location.reload(); }
function changePin() { const p = prompt('New PIN (4-6 digits):'); if (p && p.length >= 4 && /^\d+$/.test(p)) { setupPin(p); toast('PIN updated'); } }

document.getElementById('auth-pin').addEventListener('keyup', e => { if (e.key === 'Enter') checkAuth(); });
if (isSessionValid()) unlockApp();
else if (isFirstTime()) { document.getElementById('auth-title').textContent = 'Set Your PIN'; document.getElementById('auth-desc').textContent = 'Create a 4-6 digit PIN to secure your GTD'; }

// ========== GITHUB TOKEN ==========
function getGitHubToken() { return localStorage.getItem(TOKEN_KEY); }
function setGitHubToken(token) { localStorage.setItem(TOKEN_KEY, token); updateTokenStatus(); }

function setupGitHubToken() {
    const current = getGitHubToken();
    const token = prompt('Enter your GitHub Personal Access Token:\n\nGet one at: github.com/settings/tokens\n(needs no special permissions)', current || '');
    if (token !== null) { setGitHubToken(token); toast(token ? 'Token saved' : 'Token cleared'); }
}

function updateTokenStatus() {
    const status = document.getElementById('token-status');
    if (status) status.textContent = getGitHubToken() ? 'Connected' : 'Not set';
    if (status) status.style.color = getGitHubToken() ? 'var(--low)' : 'var(--text3)';
}

// ========== DATA ==========
let items = [];
let projects = [];
let filters = { status: 'all', priority: null, search: '' };

const DEFAULT_PROJECTS = [
    { id:'p1', name:'World Bank Group', status:'Active', startDate:'2025-10-01', deadline:'2026-03-31', owner:'Shreyas', stakeholders:'Anurag, WB Team', notes:'Skills Framework, QII, Climate Toolkit', category:'Professional' },
    { id:'p2', name:'HPE ClearBook', status:'Active', startDate:'2025-11-15', deadline:'2026-02-28', owner:'Shreyas', stakeholders:'HPE Sales', notes:'Gamified sales experience', category:'Professional' },
    { id:'p3', name:'CAA Axiom', status:'Active', startDate:'2025-09-01', deadline:'2026-01-31', owner:'Shreyas', stakeholders:'CAA Team', notes:'Cybersecurity, SAP, Axiom Hub', category:'Professional' },
    { id:'p4', name:'Riyadh Air', status:'Active', startDate:'2025-12-01', deadline:'2026-06-30', owner:'Shreyas', stakeholders:'Riyadh Air L&D', notes:'Design Thinking, Safety Sense', category:'Professional' },
    { id:'p5', name:'AstraZeneca', status:'Planning', startDate:'2026-01-01', deadline:'2026-04-30', owner:'Shreyas', stakeholders:'AZ Team', notes:'Website proposals', category:'Professional' },
    { id:'p6', name:'BAT', status:'Active', startDate:'2025-10-15', deadline:'2026-02-15', owner:'Shreyas', stakeholders:'BAT L&D', notes:'Webinar Tours', category:'Professional' },
    { id:'p7', name:'AI Strategic', status:'Active', startDate:'2025-08-01', deadline:null, owner:'Shreyas', notes:'AI workflows, co-creation', category:'Professional' },
    { id:'p8', name:'AI Skills', status:'Active', startDate:'2025-06-01', deadline:null, owner:'Shreyas', notes:'Daily practice, prompts', category:'Professional' },
    { id:'p9', name:'Health', status:'Active', startDate:null, deadline:null, owner:'Shreyas', notes:'Exercise, checkups', category:'Personal' },
    { id:'p10', name:'Family - Divya', status:'Active', startDate:null, deadline:null, owner:'Shreyas', category:'Personal' },
    { id:'p11', name:'Family - Ananya', status:'Active', startDate:null, deadline:null, owner:'Shreyas', category:'Personal' },
    { id:'p12', name:'Finance', status:'Active', startDate:null, deadline:null, owner:'Shreyas', notes:'Investments, taxes', category:'Personal' },
    { id:'p13', name:'Upside Marketing', status:'Active', startDate:'2025-11-01', deadline:'2026-03-01', owner:'Shreyas', notes:'Website revamp', category:'Professional' }
];

function init() {
    const stored = localStorage.getItem(STORAGE_KEY);
    if (stored) { const data = JSON.parse(stored); items = data.items || []; projects = data.projects || DEFAULT_PROJECTS; }
    else if (typeof GTD_INITIAL_DATA !== 'undefined') { 
        items = GTD_INITIAL_DATA.map(function(item, i) { 
            var newItem = {};
            for (var key in item) { if (key !== 'context') newItem[key] = item[key]; }
            newItem.id = item.id || i + 1;
            return newItem;
        }); 
        projects = DEFAULT_PROJECTS; 
        save(); 
    }
    populateProjects(); render(); renderProjects(); updateStats(); setupListeners(); updateTokenStatus();
}

function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify({ items, projects, lastModified: new Date().toISOString() })); }

function populateProjects() {
    const names = projects.map(p => p.name).sort();
    document.getElementById('f-project').innerHTML = '<option value="">None</option>' + names.map(n => `<option value="${n}">${n}</option>`).join('');
}

function render() {
    const list = document.getElementById('items-list');
    let filtered = items.filter(item => {
        if (item.status === 'Completed') return false;
        if (filters.status !== 'all' && item.status !== filters.status) return false;
        if (filters.priority && item.priority !== filters.priority) return false;
        if (filters.search && !`${item.item} ${item.project} ${item.notes}`.toLowerCase().includes(filters.search.toLowerCase())) return false;
        return true;
    });
    const order = { Critical: 0, High: 1, Medium: 2, Low: 3 };
    filtered.sort((a, b) => (order[a.priority] || 4) - (order[b.priority] || 4));
    list.innerHTML = filtered.length ? filtered.map(item => `
        <div class="item" onclick="showDetail(${item.id})">
            <div class="item-row"><div class="item-title">${item.item}</div><div class="item-priority ${(item.priority || '').toLowerCase()}"></div></div>
            <div class="item-meta">${item.project ? `<span>${item.project}</span>` : ''}${item.dueDate ? `<span>Due: ${formatDate(item.dueDate)}</span>` : ''}${item.waiting_for ? `<span>Waiting: ${item.waiting_for}</span>` : ''}</div>
        </div>
    `).join('') : '<p style="text-align:center;color:var(--text3);padding:40px;">No items</p>';
}

function formatDate(d) { if (!d) return ''; return new Date(d).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }); }

function renderProjects() {
    const list = document.getElementById('projects-list');
    list.innerHTML = projects.filter(p => p.status !== 'Completed').map(p => {
        const tasks = items.filter(i => i.project === p.name && i.status !== 'Completed');
        const total = items.filter(i => i.project === p.name).length;
        const done = items.filter(i => i.project === p.name && i.status === 'Completed').length;
        const progress = total > 0 ? Math.round((done / total) * 100) : 0;
        const daysLeft = p.deadline ? Math.ceil((new Date(p.deadline) - new Date()) / 86400000) : null;
        return `<div class="proj-card" onclick="showProjectDetail('${p.id}')">
            <div class="proj-header"><div class="proj-name">${p.name}</div><span class="proj-status ${p.status.toLowerCase().replace(' ','-')}">${p.status}</span></div>
            <div class="proj-body"><div class="proj-meta">${p.deadline ? `<div><span class="proj-meta-label">Deadline</span><br><span class="proj-meta-value${daysLeft < 14 ? ' danger' : ''}">${formatDate(p.deadline)} (${daysLeft}d)</span></div>` : ''}<div><span class="proj-meta-label">Tasks</span><br><span class="proj-meta-value">${tasks.length} active</span></div></div>${total > 0 ? `<div class="proj-progress"><div class="proj-progress-bar" style="width:${progress}%"></div></div><div class="proj-tasks">${progress}% (${done}/${total})</div>` : ''}</div>
        </div>`;
    }).join('') || '<p style="text-align:center;color:var(--text3);padding:40px;">No projects</p>';
}

function showProjectDetail(id) {
    const p = projects.find(x => x.id === id); if (!p) return;
    const tasks = items.filter(i => i.project === p.name && i.status !== 'Completed');
    document.getElementById('project-content').innerHTML = `
        <div class="modal-header"><div class="modal-title">${p.name}</div><button class="close-btn" onclick="closeProjectModal()">x</button></div>
        <div class="form">
            <div class="form-row"><div class="form-group"><label class="form-label">Status</label><select class="form-select" onchange="updateProject('${id}','status',this.value)"><option ${p.status==='Planning'?'selected':''}>Planning</option><option ${p.status==='Active'?'selected':''}>Active</option><option ${p.status==='On Hold'?'selected':''}>On Hold</option><option ${p.status==='Completed'?'selected':''}>Completed</option></select></div><div class="form-group"><label class="form-label">Category</label><select class="form-select" onchange="updateProject('${id}','category',this.value)"><option ${p.category==='Professional'?'selected':''}>Professional</option><option ${p.category==='Personal'?'selected':''}>Personal</option></select></div></div>
            <div class="form-row"><div class="form-group"><label class="form-label">Start</label><input type="date" class="form-input" value="${p.startDate||''}" onchange="updateProject('${id}','startDate',this.value)"></div><div class="form-group"><label class="form-label">Deadline</label><input type="date" class="form-input" value="${p.deadline||''}" onchange="updateProject('${id}','deadline',this.value)"></div></div>
            <div class="form-group"><label class="form-label">Owner</label><input class="form-input" value="${p.owner||''}" onchange="updateProject('${id}','owner',this.value)"></div>
            <div class="form-group"><label class="form-label">Stakeholders</label><input class="form-input" value="${p.stakeholders||''}" onchange="updateProject('${id}','stakeholders',this.value)"></div>
            <div class="form-group"><label class="form-label">Notes</label><input class="form-input" value="${p.notes||''}" onchange="updateProject('${id}','notes',this.value)"></div>
            <div class="section-title" style="margin-top:16px">Tasks (${tasks.length})</div>
            ${tasks.map(t=>`<div class="item" onclick="showDetail(${t.id});closeProjectModal()"><div class="item-row"><div class="item-title">${t.item}</div><div class="item-priority ${(t.priority||'').toLowerCase()}"></div></div></div>`).join('')||'<p style="color:var(--text3)">No tasks</p>'}
            <button class="btn btn-secondary danger" style="margin-top:20px" onclick="if(confirm('Delete?')){deleteProject('${id}')}">Delete Project</button>
        </div>`;
    document.getElementById('modal-project').classList.add('open');
}

function closeProjectModal() { document.getElementById('modal-project').classList.remove('open'); }
function updateProject(id, field, value) { const p = projects.find(x => x.id === id); if (p) { p[field] = value; save(); renderProjects(); } }
function deleteProject(id) { projects = projects.filter(p => p.id !== id); save(); renderProjects(); closeProjectModal(); toast('Deleted'); }

function showAddProject() {
    document.getElementById('project-content').innerHTML = `
        <div class="modal-header"><div class="modal-title">New Project</div><button class="close-btn" onclick="closeProjectModal()">x</button></div>
        <div class="form">
            <div class="form-group"><label class="form-label">Name</label><input class="form-input" id="np-name"></div>
            <div class="form-row"><div class="form-group"><label class="form-label">Status</label><select class="form-select" id="np-status"><option>Planning</option><option selected>Active</option></select></div><div class="form-group"><label class="form-label">Category</label><select class="form-select" id="np-cat"><option>Professional</option><option>Personal</option></select></div></div>
            <div class="form-row"><div class="form-group"><label class="form-label">Start</label><input type="date" class="form-input" id="np-start" value="${new Date().toISOString().split('T')[0]}"></div><div class="form-group"><label class="form-label">Deadline</label><input type="date" class="form-input" id="np-deadline"></div></div>
            <div class="form-group"><label class="form-label">Owner</label><input class="form-input" id="np-owner" value="Shreyas"></div>
            <button class="btn btn-primary" style="width:100%" onclick="addProject()">Create</button>
        </div>`;
    document.getElementById('modal-project').classList.add('open');
}

function addProject() {
    const name = document.getElementById('np-name').value.trim(); if (!name) { toast('Enter name'); return; }
    projects.push({ id: 'p' + Date.now(), name, status: document.getElementById('np-status').value, category: document.getElementById('np-cat').value, startDate: document.getElementById('np-start').value || null, deadline: document.getElementById('np-deadline').value || null, owner: document.getElementById('np-owner').value });
    save(); renderProjects(); populateProjects(); closeProjectModal(); toast('Created');
}

function updateStats() {
    const active = items.filter(i => i.status !== 'Completed');
    document.getElementById('s-total').textContent = active.length;
    document.getElementById('s-critical').textContent = active.filter(i => i.priority === 'Critical').length;
    document.getElementById('s-high').textContent = active.filter(i => i.priority === 'High').length;
}

function showDetail(id) {
    const item = items.find(i => i.id === id); if (!item) return;
    document.getElementById('detail-content').innerHTML = `
        <div class="modal-header"><div class="modal-title">Details</div><button class="close-btn" onclick="closeModal()">x</button></div>
        <div style="margin-bottom:20px"><div style="font-size:15px;line-height:1.5;margin-bottom:12px">${item.item}</div><div style="font-size:13px;color:var(--text2)">${item.priority} / ${item.status} / ${item.category}</div></div>
        <div style="font-size:13px;color:var(--text2);line-height:1.8;margin-bottom:24px">${item.project?`<div>Project: ${item.project}</div>`:''}${item.dueDate?`<div>Due: ${formatDate(item.dueDate)}</div>`:''}${item.waiting_for?`<div>Waiting: ${item.waiting_for}</div>`:''}${item.notes?`<div>Notes: ${item.notes}</div>`:''}</div>
        <div class="btn-row"><button class="btn btn-primary" style="flex:1" onclick="complete(${item.id})">Complete</button><button class="btn btn-secondary danger" onclick="deleteItem(${item.id})">Delete</button></div>`;
    document.getElementById('modal-detail').classList.add('open');
}

function closeModal() { document.getElementById('modal-detail').classList.remove('open'); }
function complete(id) { const item = items.find(i => i.id === id); if (item) { item.status = 'Completed'; save(); render(); renderProjects(); updateStats(); closeModal(); toast('Done'); } }
function deleteItem(id) { if (confirm('Delete?')) { items = items.filter(i => i.id !== id); save(); render(); renderProjects(); updateStats(); closeModal(); toast('Deleted'); } }

function addItem() {
    const item = { id: Date.now(), item: document.getElementById('f-item').value.trim(), priority: document.getElementById('f-priority').value, status: document.getElementById('f-status').value, category: document.getElementById('f-category').value, project: document.getElementById('f-project').value, dueDate: document.getElementById('f-due').value || null, notes: document.getElementById('f-notes').value };
    if (!item.item) { toast('Enter task'); return; }
    items.unshift(item); save(); render(); renderProjects(); updateStats(); populateProjects();
    document.getElementById('f-item').value = ''; document.getElementById('f-notes').value = ''; document.getElementById('f-due').value = '';
    toast('Added');
}

function switchView(name) {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('v-' + name).classList.add('active');
    document.querySelector(`[data-v="${name}"]`).classList.add('active');
}

// ========== AI VOICE CAPTURE ==========
const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
let recognition = null, isRecording = false, recordingTime = 0, recordingTimer = null, transcript = '';

if (SR) {
    recognition = new SR(); recognition.continuous = true; recognition.interimResults = true;
    recognition.onresult = e => { for (let i = e.resultIndex; i < e.results.length; i++) if (e.results[i].isFinal) transcript += e.results[i][0].transcript + ' '; };
    recognition.onend = () => { if (isRecording) recognition.start(); };
}

document.getElementById('mic-btn').onclick = () => { if (!recognition) { toast('Speech not supported'); return; } if (isRecording) stopRecording(); else startRecording(); };

function startRecording() {
    isRecording = true; recordingTime = 0; transcript = '';
    document.getElementById('mic-btn').classList.add('recording'); document.getElementById('mic-btn').textContent = 'Stop';
    document.getElementById('mic-status').textContent = 'Recording...'; document.getElementById('result-box').style.display = 'none';
    recognition.start();
    recordingTimer = setInterval(() => { recordingTime++; document.getElementById('mic-time').textContent = `${Math.floor(recordingTime/60)}:${(recordingTime%60).toString().padStart(2,'0')}`; }, 1000);
}

function stopRecording() {
    isRecording = false; recognition.stop(); clearInterval(recordingTimer);
    document.getElementById('mic-btn').classList.remove('recording'); document.getElementById('mic-btn').textContent = 'Start';
    
    if (!transcript.trim()) { document.getElementById('mic-status').textContent = 'Nothing captured'; return; }
    
    document.getElementById('mic-status').textContent = 'AI analyzing...';
    document.getElementById('result-box').style.display = 'block';
    document.getElementById('result-content').innerHTML = '<div class="loading"></div> Processing with AI...';
    
    processWithAI(transcript);
}

async function processWithAI(text) {
    const token = getGitHubToken();
    
    if (!token) {
        document.getElementById('result-content').innerHTML = '<div style="color:var(--critical)">No GitHub token set. Using basic mode.</div>';
        setTimeout(() => fallbackProcess(text), 500);
        return;
    }
    
    // Show what was captured for debugging
    console.log('Voice transcript:', text);
    
    const projectNames = projects.map(p => p.name).join(', ');
    const taskSummary = items.filter(i => i.status !== 'Completed').slice(0, 20).map(i => `- "${i.item}" (${i.project || 'no project'})`).join('\n');
    
    const systemPrompt = `You extract MULTIPLE tasks from messy voice recordings. The user rambles with filler words - your job is to find EVERY SINGLE actionable item.

CRITICAL RULES:
1. Extract ALL tasks mentioned - users often embed 3-7 tasks in one recording
2. Each separate thing to do = separate task in the actions array
3. "and", "also", "plus", "another thing", "oh and" often introduce new tasks
4. Be AGGRESSIVE - if something sounds like it might be a task, ADD IT
5. Clean up filler words (um, uh, like, so, basically, you know) but keep the action
6. Short task descriptions are better - just the core action

TASK INDICATORS (any of these = a task):
- "need to", "have to", "should", "gotta", "want to", "going to", "will", "must"
- "remind me", "don't forget", "make sure", "remember to"
- "follow up", "check on", "look into", "figure out", "think about"
- "call", "email", "text", "message", "talk to", "meet with"
- "buy", "get", "pick up", "order"
- "schedule", "book", "plan", "organize"
- "review", "read", "check", "update", "finish", "complete", "do"
- ANY action verb followed by something

EXAMPLE INPUT: "so um I need to call John about the project and also like I should probably email Sarah about the deadline oh and don't forget to pick up groceries and maybe think about that health checkup thing"
EXAMPLE OUTPUT: 4 tasks - "Call John about project", "Email Sarah about deadline", "Pick up groceries", "Schedule health checkup"

PROJECTS: ${projectNames}
CURRENT TASKS (for matching completions): ${taskSummary}

Return ONLY valid JSON:
{
  "actions": [
    {"type": "add", "task": "short clean task", "project": "matched project or null", "priority": "Medium", "waiting_for": null}
  ],
  "raw_interpretation": "Found X tasks: brief list"
}

For completions use: {"type": "complete", "match": "keywords"}
For deletions use: {"type": "delete", "match": "keywords"}

IMPORTANT: Return MULTIPLE actions if the user mentioned multiple things to do!`;

    try {
        const response = await fetch(GITHUB_MODELS_URL, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                model: MODEL,
                messages: [
                    { role: 'system', content: systemPrompt },
                    { role: 'user', content: `Voice recording transcript: "${text}"` }
                ],
                temperature: 0.5,
                max_tokens: 1500
            })
        });

        if (!response.ok) {
            const err = await response.text();
            console.error('API Response:', err);
            throw new Error(`API ${response.status}`);
        }

        const data = await response.json();
        const content = data.choices[0].message.content;
        console.log('AI Response:', content);
        
        // Parse JSON from response (handle markdown code blocks)
        let json;
        try {
            const jsonMatch = content.match(/```json\s*([\s\S]*?)\s*```/) || content.match(/```\s*([\s\S]*?)\s*```/);
            json = JSON.parse(jsonMatch ? jsonMatch[1] : content);
        } catch (e) {
            // Try to extract JSON object from text
            const objMatch = content.match(/\{[\s\S]*\}/);
            if (objMatch) json = JSON.parse(objMatch[0]);
            else throw new Error('Could not parse AI response');
        }
        
        executeActions(json.actions || [], text, json.raw_interpretation);
        
    } catch (error) {
        console.error('AI Error:', error);
        document.getElementById('result-content').innerHTML = `<div style="color:var(--critical)">AI error: ${error.message}</div><div style="margin-top:8px">Using fallback mode...</div>`;
        setTimeout(() => fallbackProcess(text), 1000);
    }
}

function executeActions(actions, transcript = '', interpretation = '') {
    let added = 0, completed = 0, deleted = 0, updated = 0;
    const actionLog = [];
    
    actions.forEach(action => {
        if (action.type === 'add' && action.task) {
            const proj = projects.find(p => p.name.toLowerCase().includes((action.project || '').toLowerCase()));
            items.unshift({
                id: Date.now() + Math.random(),
                item: action.task,
                priority: action.priority || 'Medium',
                status: action.waiting_for ? 'Waiting For' : 'Next Action',
                category: proj ? proj.category : 'Personal',
                project: proj ? proj.name : '',
                waiting_for: action.waiting_for || '',
                notes: ''
            });
            added++;
            actionLog.push(`+ "${action.task}"${proj ? ` → ${proj.name}` : ''}`);
        }
        else if (action.type === 'complete' && action.match) {
            const match = items.find(i => i.status !== 'Completed' && i.item.toLowerCase().includes(action.match.toLowerCase()));
            if (match) { match.status = 'Completed'; completed++; actionLog.push(`✓ "${match.item}"`); }
        }
        else if (action.type === 'delete' && action.match) {
            const idx = items.findIndex(i => i.item.toLowerCase().includes(action.match.toLowerCase()));
            if (idx > -1) { const removed = items.splice(idx, 1)[0]; deleted++; actionLog.push(`✗ "${removed.item}"`); }
        }
        else if (action.type === 'update_project' && action.project) {
            const proj = projects.find(p => p.name.toLowerCase().includes(action.project.toLowerCase()));
            if (proj && action.field) { proj[action.field] = action.value; updated++; actionLog.push(`↻ ${proj.name}: ${action.field}`); }
        }
    });
    
    save(); render(); renderProjects(); updateStats(); populateProjects();
    document.getElementById('mic-status').textContent = 'Tap to start';
    
    // Show results with transcript for debugging
    let html = '';
    if (actionLog.length) {
        html = `<div class="result-count">${actionLog.length}</div><div class="result-label">actions</div><div class="result-actions">${actionLog.map(a => `<div>${a}</div>`).join('')}</div>`;
    } else {
        html = `<div style="color:var(--text2)">No actions detected</div>`;
    }
    
    // Show what was heard (helps debug)
    if (transcript) {
        html += `<div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border);font-size:11px;color:var(--text3)"><b>Heard:</b> "${transcript}"</div>`;
    }
    if (interpretation) {
        html += `<div style="font-size:11px;color:var(--text3);margin-top:4px"><b>Understood:</b> ${interpretation}</div>`;
    }
    
    document.getElementById('result-content').innerHTML = html;
}

function fallbackProcess(text) {
    // Simple pattern matching fallback
    const chunks = text.split(/[.!?]+/).filter(s => s.trim().length > 5);
    let added = 0;
    
    chunks.forEach(chunk => {
        const lower = chunk.toLowerCase();
        if (/finished|completed|done|checked off/.test(lower)) return; // Skip completions in fallback
        
        const task = { id: Date.now() + Math.random(), item: chunk.trim().replace(/^(i need to|have to|should|must|want to)\s*/i, '').replace(/^\w/, c => c.toUpperCase()), priority: 'Medium', status: 'Next Action', category: 'Personal', project: '', notes: '' };
        
        if (/urgent|critical|asap/.test(lower)) task.priority = 'Critical';
        else if (/important|priority/.test(lower)) task.priority = 'High';
        
        if (/work|office|client|project/.test(lower)) task.category = 'Professional';
        
        for (const p of projects) {
            if (lower.includes(p.name.toLowerCase().split(' ')[0].toLowerCase())) { task.project = p.name; task.category = p.category; break; }
        }
        
        if (task.item.length > 5) { items.unshift(task); added++; }
    });
    
    save(); render(); updateStats();
    document.getElementById('mic-status').textContent = 'Tap to start';
    document.getElementById('result-content').innerHTML = `<div class="result-count">${added}</div><div class="result-label">tasks added (basic mode)</div>`;
}

// ========== EXPORT/IMPORT ==========
function exportJSON() { const blob = new Blob([JSON.stringify({ items, projects }, null, 2)], { type: 'application/json' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'gtd-backup.json'; a.click(); toast('Downloaded'); }
function importJSON(file) { if (!file) return; const reader = new FileReader(); reader.onload = e => { try { const data = JSON.parse(e.target.result); if (data.items) items = data.items; if (data.projects) projects = data.projects; save(); render(); renderProjects(); updateStats(); populateProjects(); toast('Imported'); } catch (e) { toast('Invalid file'); } }; reader.readAsText(file); }
function clearCompleted() { if (confirm('Clear completed?')) { items = items.filter(i => i.status !== 'Completed'); save(); render(); updateStats(); toast('Cleared'); } }
function reloadSampleData() { 
    if (confirm('Reload all 101 sample items? This will replace your current data.')) { 
        if (typeof GTD_INITIAL_DATA !== 'undefined') {
            items = GTD_INITIAL_DATA.map(function(item, i) { 
                var newItem = {};
                for (var key in item) { if (key !== 'context') newItem[key] = item[key]; }
                newItem.id = item.id || i + 1;
                return newItem;
            });
            projects = DEFAULT_PROJECTS;
            save(); render(); renderProjects(); updateStats(); populateProjects();
            toast('Loaded 101 items');
        } else {
            toast('Sample data not available');
        }
    } 
}
function resetAll() { if (confirm('Reset all?')) { localStorage.removeItem(STORAGE_KEY); location.reload(); } }
function toast(msg) { const t = document.getElementById('toast'); t.textContent = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2000); }

function setupListeners() {
    document.querySelectorAll('.tab').forEach(tab => { tab.onclick = () => { document.querySelectorAll('.tab').forEach(t => t.classList.remove('active')); tab.classList.add('active'); filters.status = tab.dataset.status; render(); }; });
    document.querySelectorAll('.filter[data-p]').forEach(btn => { btn.onclick = () => { const wasActive = btn.classList.contains('active'); document.querySelectorAll('.filter[data-p]').forEach(b => b.classList.remove('active')); filters.priority = wasActive ? null : btn.dataset.p; if (!wasActive) btn.classList.add('active'); render(); }; });
    document.getElementById('search').oninput = e => { filters.search = e.target.value; render(); };
    document.querySelectorAll('.nav-btn').forEach(btn => { btn.onclick = () => switchView(btn.dataset.v); });
    document.getElementById('modal-detail').onclick = e => { if (e.target.id === 'modal-detail') closeModal(); };
    document.getElementById('modal-project').onclick = e => { if (e.target.id === 'modal-project') closeProjectModal(); };
}
</script>
</body>
</html>
