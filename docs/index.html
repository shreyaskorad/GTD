<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#fff">
    <title>GTD</title>
    <link rel="manifest" href="manifest.json">
    <script src="data.js"></script>
    <style>
:root { --bg:#fafafa; --surface:#fff; --surface2:#f5f5f5; --border:#e0e0e0; --text:#222; --text2:#666; --text3:#999; --accent:#0066cc; --critical:#d32f2f; --high:#f57c00; --medium:#fbc02d; --low:#388e3c; }
* { box-sizing:border-box; margin:0; padding:0; -webkit-tap-highlight-color:rgba(0,0,0,0.1); }
body { font-family:-apple-system,system-ui,sans-serif; background:var(--bg); color:var(--text); min-height:100vh; font-size:14px; touch-action:manipulation; }
.app { max-width:600px; margin:0 auto; padding-bottom:56px; }
header { padding:16px; background:var(--surface); border-bottom:1px solid var(--border); }
header h1 { font-size:18px; font-weight:600; }
.stats { display:flex; gap:20px; margin-top:8px; font-size:12px; color:var(--text2); }
.tabs { display:flex; background:var(--surface); border-bottom:1px solid var(--border); }
.tab { flex:1; padding:12px; text-align:center; font-size:13px; color:var(--text2); background:none; border:none; cursor:pointer; }
.tab.active { color:var(--accent); font-weight:500; border-bottom:2px solid var(--accent); }
.filters { padding:12px 16px; background:var(--surface); border-bottom:1px solid var(--border); display:flex; gap:8px; flex-wrap:wrap; }
.filter { padding:6px 12px; font-size:12px; border-radius:16px; border:1px solid var(--border); background:var(--surface); color:var(--text2); cursor:pointer; }
.filter.active { background:var(--accent); color:#fff; border-color:var(--accent); }
.search { flex:1; min-width:140px; padding:8px 12px; font-size:13px; border:1px solid var(--border); border-radius:6px; background:var(--surface); color:var(--text); }
.list { padding:8px 16px; }
.item { padding:14px; margin-bottom:8px; background:var(--surface); border:1px solid var(--border); border-radius:8px; cursor:pointer; }
.item-row { display:flex; justify-content:space-between; align-items:flex-start; gap:12px; }
.item-title { font-size:14px; flex:1; line-height:1.4; }
.item-priority { width:8px; height:8px; border-radius:50%; flex-shrink:0; margin-top:5px; }
.item-priority.critical { background:var(--critical); }
.item-priority.high { background:var(--high); }
.item-priority.medium { background:var(--medium); }
.item-priority.low { background:var(--low); }
.item-meta { font-size:12px; color:var(--text2); margin-top:8px; }
.item-meta span { margin-right:16px; }
.capture { padding:16px; }
.section-title { font-size:15px; font-weight:600; margin-bottom:16px; }
.mic-area { text-align:center; padding:32px; background:var(--surface); border:1px solid var(--border); border-radius:16px; margin-bottom:16px; transition:all 0.3s; }
.mic-area.recording { border-color:var(--critical); background:linear-gradient(135deg, #fff5f5 0%, #fff 100%); }
.mic-area.processing { border-color:var(--accent); background:linear-gradient(135deg, #f0f7ff 0%, #fff 100%); }
.mic-btn { width:100px; height:100px; border-radius:50%; border:3px solid var(--border); background:var(--surface); color:var(--text); font-size:15px; font-weight:600; cursor:pointer; transition:all 0.2s; }
.mic-btn:active { transform:scale(0.95); }
.mic-btn.recording { border-color:var(--critical); color:var(--critical); background:#fff5f5; animation:pulse 1.5s infinite; }
@keyframes pulse { 0%,100%{box-shadow:0 0 0 0 rgba(211,47,47,0.3)} 50%{box-shadow:0 0 0 15px rgba(211,47,47,0)} }
.mic-status { margin-top:16px; font-size:14px; color:var(--text2); font-weight:500; }
.mic-time { font-size:40px; font-weight:300; margin-top:8px; font-variant-numeric:tabular-nums; color:var(--text); }
.capture-hints { background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:16px; margin-bottom:16px; }
.hint-title { font-size:12px; font-weight:600; color:var(--text2); margin-bottom:10px; text-transform:uppercase; letter-spacing:0.5px; }
.hint-item { font-size:13px; color:var(--text3); padding:6px 0; border-bottom:1px solid var(--border); }
.hint-item:last-child { border-bottom:none; }
.result-box { background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:20px; margin-bottom:16px; }
.result-count { font-size:32px; font-weight:700; color:var(--accent); }
.result-label { font-size:14px; color:var(--text2); margin-top:4px; }
.result-actions { margin-top:16px; font-size:13px; color:var(--text); text-align:left; }
.result-actions div { padding:8px 12px; background:var(--surface2); border-radius:6px; margin-bottom:6px; }
.result-actions div:last-child { margin-bottom:0; }
.result-transcript { margin-top:16px; padding-top:16px; border-top:1px solid var(--border); font-size:12px; color:var(--text3); }
.token-warning { background:#fff8e1; border:1px solid #ffe082; border-radius:12px; padding:16px; text-align:center; font-size:13px; color:#f57c00; }
.btn { padding:12px 20px; font-size:14px; border:none; border-radius:8px; cursor:pointer; font-weight:500; }
.btn-primary { background:var(--accent); color:#fff; }
.btn-secondary { background:var(--surface2); color:var(--text); }
.btn-row { display:flex; gap:10px; }
.form { padding:16px; }
.form-group { margin-bottom:16px; }
.form-label { display:block; font-size:12px; color:var(--text2); margin-bottom:6px; font-weight:500; }
.form-input, .form-select, .form-textarea { width:100%; padding:12px; font-size:14px; border:1px solid var(--border); border-radius:8px; background:var(--surface); color:var(--text); }
.form-textarea { min-height:80px; resize:vertical; font-family:inherit; }
.form-row { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
.modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); z-index:100; align-items:flex-end; }
.modal.open { display:flex; }
.modal-content { background:var(--surface); width:100%; max-width:500px; margin:0 auto; max-height:80vh; overflow-y:auto; border-radius:16px 16px 0 0; padding:20px; }
.modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
.modal-title { font-size:16px; font-weight:600; }
.close-btn { width:32px; height:32px; border-radius:50%; border:1px solid var(--border); background:var(--surface); color:var(--text2); font-size:18px; cursor:pointer; }
.nav { position:fixed; bottom:0; left:0; right:0; background:var(--surface); border-top:1px solid var(--border); display:flex; padding-bottom:env(safe-area-inset-bottom); }
.nav-btn { flex:1; padding:10px; text-align:center; font-size:11px; color:var(--text3); background:none; border:none; cursor:pointer; font-weight:500; }
.nav-btn.active { color:var(--accent); }
.settings { padding:16px; }
.settings-group { background:var(--surface); border:1px solid var(--border); border-radius:12px; margin-bottom:16px; overflow:hidden; }
.settings-item { display:block; width:100%; text-align:left; padding:14px 16px; border:none; border-bottom:1px solid var(--border); font-size:14px; cursor:pointer; background:var(--surface); color:var(--text); font-family:inherit; }
.settings-item:last-child { border-bottom:none; }
.settings-item:active { background:var(--surface2); }
.settings-label { font-size:12px; color:var(--text2); padding:16px 16px 8px; font-weight:500; text-transform:uppercase; }
.danger { color:var(--critical); }
.view { display:none; }
.view.active { display:block; }
.toast { position:fixed; bottom:70px; left:50%; transform:translateX(-50%) translateY(50px); background:var(--text); color:var(--surface); padding:12px 24px; border-radius:8px; font-size:13px; transition:transform 0.2s; z-index:200; }
.toast.show { transform:translateX(-50%) translateY(0); }
.proj-card { background:var(--surface); border:1px solid var(--border); border-radius:12px; margin-bottom:12px; overflow:hidden; }
.proj-header { padding:14px 16px; border-bottom:1px solid var(--border); }
.proj-name { font-size:15px; font-weight:600; margin-bottom:4px; }
.proj-status { display:inline-block; font-size:11px; padding:2px 8px; border-radius:10px; background:var(--surface2); color:var(--text2); }
.proj-status.active { background:#e3f2fd; color:#1976d2; }
.proj-status.on-hold { background:#fff3e0; color:#f57c00; }
.proj-status.completed { background:#e8f5e9; color:#388e3c; }
.proj-body { padding:14px 16px; }
.proj-meta { display:grid; grid-template-columns:1fr 1fr; gap:8px 16px; font-size:12px; margin-bottom:12px; }
.proj-meta-label { color:var(--text3); }
.proj-meta-value { color:var(--text); font-weight:500; }
.proj-progress { height:4px; background:var(--surface2); border-radius:2px; margin-top:8px; }
.proj-progress-bar { height:100%; background:var(--accent); border-radius:2px; }
.proj-tasks { font-size:12px; color:var(--text2); margin-top:8px; }
.auth-overlay { position:fixed; inset:0; background:var(--bg); z-index:1000; display:flex; align-items:center; justify-content:center; }
.auth-box { background:var(--surface); border:1px solid var(--border); border-radius:16px; padding:32px; width:90%; max-width:320px; text-align:center; }
.auth-title { font-size:18px; font-weight:600; margin-bottom:8px; }
.auth-desc { font-size:13px; color:var(--text2); margin-bottom:24px; }
.auth-input { width:100%; padding:14px; font-size:16px; border:1px solid var(--border); border-radius:8px; text-align:center; letter-spacing:8px; margin-bottom:16px; }
.auth-error { color:var(--critical); font-size:12px; margin-bottom:12px; display:none; }
.hidden { display:none !important; }
.ai-badge { display:inline-block; font-size:10px; padding:2px 6px; border-radius:4px; background:#e8f5e9; color:#388e3c; margin-left:8px; }
.loading { display:inline-block; width:16px; height:16px; border:2px solid var(--border); border-top-color:var(--accent); border-radius:50%; animation:spin 1s linear infinite; }
@keyframes spin { to { transform:rotate(360deg); } }
    </style>
</head>
<body>
<div class="auth-overlay" id="auth-screen">
    <div class="auth-box">
        <div class="auth-title" id="auth-title">GTD Access</div>
        <div class="auth-desc" id="auth-desc">Enter your PIN to continue</div>
        <div class="auth-error" id="auth-error">Incorrect PIN</div>
        <input type="password" class="auth-input" id="auth-pin" maxlength="6" placeholder="------" inputmode="numeric" autocomplete="off">
        <button class="btn btn-primary" style="width:100%" onclick="checkAuth()">Unlock</button>
    </div>
</div>

<div class="app hidden" id="main-app">
    <header>
        <h1>GTD <span class="ai-badge">AI</span></h1>
        <div class="stats">
            <span><span id="s-critical">0</span> critical</span>
            <span><span id="s-high">0</span> high</span>
            <span><span id="s-total">0</span> total</span>
        </div>
    </header>

    <div class="view active" id="v-list">
        <div class="tabs">
            <button class="tab active" data-status="all">All</button>
            <button class="tab" data-status="Next Action">Actions</button>
            <button class="tab" data-status="Waiting For">Waiting</button>
        </div>
        <div class="filters">
            <input type="text" class="search" id="search" placeholder="Search...">
            <button class="filter" data-p="Critical">Critical</button>
            <button class="filter" data-p="High">High</button>
        </div>
        <div class="list" id="items-list"></div>
    </div>

    <div class="view" id="v-projects">
        <div class="capture">
            <div class="section-title">Projects</div>
            <div id="projects-list"></div>
            <button class="btn btn-primary" style="width:100%;margin-top:16px" onclick="showAddProject()">New Project</button>
        </div>
    </div>

    <div class="view" id="v-capture">
        <div class="capture">
            <div class="section-title">Voice Capture</div>
            
            <div class="mic-area" id="mic-area">
                <button class="mic-btn" id="mic-btn">Start</button>
                <div class="mic-status" id="mic-status">Tap to start recording</div>
                <div class="mic-time" id="mic-time">0:00</div>
            </div>
            
            <div class="capture-hints">
                <div class="hint-title">What you can say:</div>
                <div class="hint-item">Add: "I need to call John about the project"</div>
                <div class="hint-item">Complete: "I finished the World Bank task"</div>
                <div class="hint-item">Delete: "Remove the grocery task"</div>
                <div class="hint-item">Multiple: "Call John, email Sarah, and book flights"</div>
            </div>
            
            <div class="result-box" id="result-box" style="display:none;">
                <div id="result-content"></div>
            </div>
            
            <div class="token-warning" id="token-warning" style="display:none;">
                <div style="font-weight:600;margin-bottom:4px;">AI not configured</div>
                <div>Go to Settings → GitHub Token to enable smart capture</div>
            </div>
        </div>
    </div>

    <div class="view" id="v-add">
        <div class="form">
            <div class="section-title">Quick Add</div>
            <div class="form-group">
                <label class="form-label">Task</label>
                <input class="form-input" id="f-item" placeholder="What needs to be done?">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Priority</label>
                    <select class="form-select" id="f-priority"><option value="Critical">Critical</option><option value="High">High</option><option value="Medium" selected>Medium</option><option value="Low">Low</option></select>
                </div>
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select class="form-select" id="f-status"><option value="Next Action">Next Action</option><option value="Waiting For">Waiting For</option><option value="Someday/Maybe">Someday/Maybe</option></select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select class="form-select" id="f-category"><option value="Personal">Personal</option><option value="Professional">Professional</option></select>
                </div>
                <div class="form-group">
                    <label class="form-label">Project</label>
                    <select class="form-select" id="f-project"></select>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Due Date</label>
                <input type="date" class="form-input" id="f-due">
            </div>
            <div class="form-group">
                <label class="form-label">Notes</label>
                <input class="form-input" id="f-notes" placeholder="Additional details">
            </div>
            <button class="btn btn-primary" style="width:100%" onclick="addItem()">Add</button>
        </div>
    </div>

    <div class="view" id="v-settings">
        <div class="settings">
            <div class="settings-label">AI Setup</div>
            <div class="settings-group">
                <button class="settings-item" type="button" onclick="setupGitHubToken()">GitHub Token <span id="token-status" style="float:right;color:var(--text3)">Not set</span></button>
            </div>
            <div class="settings-label">Security</div>
            <div class="settings-group">
                <button class="settings-item" type="button" onclick="changePin()">Change PIN</button>
                <button class="settings-item" type="button" onclick="lockApp()">Lock App</button>
            </div>
            <div class="settings-label">Data</div>
            <div class="settings-group">
                <button class="settings-item" type="button" onclick="exportJSON()">Export JSON</button>
                <button class="settings-item" type="button" onclick="document.getElementById('import-file').click()">Import JSON</button>
                <input type="file" id="import-file" accept=".json" style="display:none" onchange="importJSON(this.files[0])">
            </div>
            <div class="settings-label">Manage</div>
            <div class="settings-group">
                <button class="settings-item" type="button" onclick="clearCompleted()">Clear completed</button>
                <button class="settings-item" type="button" onclick="reloadSampleData()">Reload sample data (101 items)</button>
                <button class="settings-item danger" type="button" onclick="resetAll()">Reset all data</button>
            </div>
            <div style="text-align:center;padding:24px;color:var(--text3);font-size:12px;">GTD v6.2 - AI Powered</div>
        </div>
    </div>
</div>

<nav class="nav hidden" id="main-nav">
    <button class="nav-btn active" data-v="list">Tasks</button>
    <button class="nav-btn" data-v="projects">Projects</button>
    <button class="nav-btn" data-v="capture">Capture</button>
    <button class="nav-btn" data-v="add">Add</button>
    <button class="nav-btn" data-v="settings">Settings</button>
</nav>

<div class="modal" id="modal-detail"><div class="modal-content" id="detail-content"></div></div>
<div class="modal" id="modal-project"><div class="modal-content" id="project-content"></div></div>
<div class="toast" id="toast"></div>

<script>
// ========== SAFARI FIX ==========
try { document.addEventListener('touchstart', function() {}, {passive: true}); } catch(e) { document.addEventListener('touchstart', function() {}); }

// ========== CONFIG ==========
var STORAGE_KEY = 'gtd_ai_v6';
var PIN_KEY = 'gtd_pin_hash';
var TOKEN_KEY = 'gtd_gh_token';
var SESSION_KEY = 'gtd_session';
var DEVICE_KEY = 'gtd_device_id';

// GitHub Models API endpoint
var GITHUB_MODELS_URL = 'https://models.inference.ai.azure.com/chat/completions';
var MODEL = 'gpt-4o-mini'; // Fast and cheap, great for this use case

// ========== SECURITY ==========
function getDeviceId() {
    var id = localStorage.getItem(DEVICE_KEY);
    if (!id) { id = 'dev_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9); localStorage.setItem(DEVICE_KEY, id); }
    return id;
}

function hashPin(pin) {
    var hash = 0; var salt = getDeviceId(); var str = pin + salt;
    for (var i = 0; i < str.length; i++) { hash = ((hash << 5) - hash) + str.charCodeAt(i); hash = hash & hash; }
    return hash.toString();
}

function isFirstTime() { return !localStorage.getItem(PIN_KEY); }
function setupPin(pin) { localStorage.setItem(PIN_KEY, hashPin(pin)); sessionStorage.setItem(SESSION_KEY, 'unlocked'); }
function verifyPin(pin) { return localStorage.getItem(PIN_KEY) === hashPin(pin); }
function isSessionValid() { return sessionStorage.getItem(SESSION_KEY) === 'unlocked'; }

function checkAuth() {
    var pin = document.getElementById('auth-pin').value;
    if (pin.length < 4) { document.getElementById('auth-error').style.display = 'block'; document.getElementById('auth-error').textContent = 'PIN must be at least 4 digits'; return; }
    if (isFirstTime()) { setupPin(pin); unlockApp(); toast('PIN set!'); }
    else if (verifyPin(pin)) { sessionStorage.setItem(SESSION_KEY, 'unlocked'); unlockApp(); }
    else { document.getElementById('auth-error').style.display = 'block'; document.getElementById('auth-error').textContent = 'Incorrect PIN'; document.getElementById('auth-pin').value = ''; }
}

function unlockApp() {
    document.getElementById('auth-screen').classList.add('hidden');
    document.getElementById('main-app').classList.remove('hidden');
    document.getElementById('main-nav').classList.remove('hidden');
    init();
}

function lockApp() { sessionStorage.removeItem(SESSION_KEY); location.reload(); }
function changePin() { var p = prompt('New PIN (4-6 digits):'); if (p && p.length >= 4 && /^\d+$/.test(p)) { setupPin(p); toast('PIN updated'); } }

document.getElementById('auth-pin').addEventListener('keyup', function(e) { if (e.key === 'Enter') checkAuth(); });

// Allow ?reset=1 in URL to clear all data
if (window.location.search.indexOf('reset=1') > -1) {
    localStorage.removeItem(STORAGE_KEY);
    localStorage.removeItem(PIN_KEY);
    localStorage.removeItem(TOKEN_KEY);
    sessionStorage.removeItem(SESSION_KEY);
    window.location.href = window.location.pathname;
}

// Allow ?reload=1 to reload sample data (keeps PIN and token)
if (window.location.search.indexOf('reload=1') > -1) {
    localStorage.removeItem(STORAGE_KEY);
    window.location.href = window.location.pathname;
}

if (isSessionValid()) unlockApp();
else if (isFirstTime()) { document.getElementById('auth-title').textContent = 'Set Your PIN'; document.getElementById('auth-desc').textContent = 'Create a 4-6 digit PIN to secure your GTD'; }

// ========== GITHUB TOKEN ==========
function getGitHubToken() { return localStorage.getItem(TOKEN_KEY); }
function setGitHubToken(token) { localStorage.setItem(TOKEN_KEY, token); updateTokenStatus(); }

function setupGitHubToken() {
    var current = getGitHubToken();
    var token = prompt('Enter your GitHub Personal Access Token:\n\nGet one at: github.com/settings/tokens\n(needs no special permissions)', current || '');
    if (token !== null) { setGitHubToken(token); toast(token ? 'Token saved' : 'Token cleared'); }
}

function updateTokenStatus() {
    var status = document.getElementById('token-status');
    if (status) status.textContent = getGitHubToken() ? 'Connected' : 'Not set';
    if (status) status.style.color = getGitHubToken() ? 'var(--low)' : 'var(--text3)';
}

// ========== DATA ==========
var items = [];
var projects = [];
var filters = { status: 'all', priority: null, search: '' };

var DEFAULT_PROJECTS = [
    // Professional - Client Projects
    { id:'p1', name:'World Bank Group', status:'Active', startDate:'2025-10-01', deadline:'2026-03-31', owner:'Shreyas', stakeholders:'Anurag, WB Team', notes:'Skills Framework, QII, Climate Toolkit', category:'Professional' },
    { id:'p2', name:'HPE', status:'Active', startDate:'2025-11-15', deadline:'2026-02-28', owner:'Shreyas', stakeholders:'HPE Sales', notes:'Gamified sales experience - Clearbook', category:'Professional' },
    { id:'p3', name:'CAA', status:'Active', startDate:'2025-09-01', deadline:'2026-01-31', owner:'Shreyas', stakeholders:'CAA Team', notes:'Cybersecurity, SAP, Axiom Hub', category:'Professional' },
    { id:'p4', name:'Riyadh Air', status:'Active', startDate:'2025-12-01', deadline:'2026-06-30', owner:'Shreyas', stakeholders:'Riyadh Air L&D', notes:'Design Thinking, Safety Sense', category:'Professional' },
    { id:'p5', name:'AstraZeneca', status:'Planning', startDate:'2026-01-01', deadline:'2026-04-30', owner:'Shreyas', stakeholders:'AZ Team', notes:'Website proposals', category:'Professional' },
    { id:'p6', name:'BAT', status:'Active', startDate:'2025-10-15', deadline:'2026-02-15', owner:'Shreyas', stakeholders:'BAT L&D', notes:'Webinar Tours', category:'Professional' },
    
    // Professional - AI & Strategy
    { id:'p7', name:'AI Strategic', status:'Active', startDate:'2025-08-01', deadline:null, owner:'Shreyas', notes:'AI workflows, co-creation', category:'Professional' },
    { id:'p8', name:'AI Skills', status:'Active', startDate:'2025-06-01', deadline:null, owner:'Shreyas', notes:'Daily practice, prompts', category:'Professional' },
    { id:'p9', name:'AI Integration', status:'Active', startDate:'2025-06-01', deadline:null, owner:'Shreyas', notes:'Helping teams use AI', category:'Professional' },
    { id:'p10', name:'Strategic Accounts', status:'Active', startDate:null, deadline:null, owner:'Shreyas', notes:'WB, HPE, Riyadh Air management', category:'Professional' },
    
    // Professional - Upside
    { id:'p11', name:'Upside Marketing', status:'Active', startDate:'2025-11-01', deadline:'2026-03-01', owner:'Shreyas', notes:'Website revamp', category:'Professional' },
    { id:'p12', name:'Presales', status:'Active', startDate:null, deadline:null, owner:'Shreyas', notes:'New opportunities', category:'Professional' },
    { id:'p13', name:'Systems', status:'Active', startDate:null, deadline:null, owner:'Shreyas', notes:'IT, subscriptions', category:'Professional' },
    { id:'p14', name:'Networking', status:'Active', startDate:null, deadline:null, owner:'Shreyas', notes:'Building connections', category:'Professional' },
    { id:'p15', name:'Industry', status:'Active', startDate:null, deadline:null, owner:'Shreyas', notes:'Events, trends', category:'Professional' },
    { id:'p16', name:'Reflection', status:'Active', startDate:null, deadline:null, owner:'Shreyas', notes:'Identity, growth', category:'Professional' },
    
    // Personal - Business
    { id:'p17', name:'Business Planning', status:'Active', startDate:null, deadline:'2026-03-31', owner:'Shreyas', notes:'New business after Upside', category:'Personal' },
    { id:'p18', name:'Professional Identity', status:'Active', startDate:null, deadline:null, owner:'Shreyas', notes:'Speaking, writing, coaching', category:'Personal' },
    { id:'p19', name:'Personal Projects', status:'Active', startDate:null, deadline:null, owner:'Shreyas', notes:'Website, side projects', category:'Personal' },
    { id:'p20', name:'Goals', status:'Active', startDate:null, deadline:null, owner:'Shreyas', notes:'OKRs, planning', category:'Personal' },
    
    // Personal - Health
    { id:'p21', name:'Health', status:'Active', startDate:null, deadline:null, owner:'Shreyas', notes:'Exercise, checkups', category:'Personal' },
    { id:'p22', name:'Health - Weight', status:'Active', startDate:null, deadline:null, owner:'Shreyas', notes:'Lose 6 kilos', category:'Personal' },
    { id:'p23', name:'Health - Sleep', status:'Active', startDate:null, deadline:null, owner:'Shreyas', notes:'Critical for performance', category:'Personal' },
    { id:'p24', name:'Health - Exercise', status:'Active', startDate:null, deadline:null, owner:'Shreyas', notes:'10K steps daily', category:'Personal' },
    { id:'p25', name:'Health - Dentist', status:'Active', startDate:null, deadline:null, owner:'Shreyas', notes:'Wisdom teeth', category:'Personal' },
    { id:'p26', name:'Health - Diet', status:'Active', startDate:null, deadline:null, owner:'Shreyas', notes:'Reduce outside food', category:'Personal' },
    { id:'p27', name:'Mindfulness', status:'Active', startDate:null, deadline:null, owner:'Shreyas', notes:'Screen time, presence', category:'Personal' },
    
    // Personal - Family
    { id:'p28', name:'Family - Divya', status:'Active', startDate:null, deadline:null, owner:'Shreyas', notes:'Wife', category:'Personal' },
    { id:'p29', name:'Family - Ananya', status:'Active', startDate:null, deadline:null, owner:'Shreyas', notes:'Daughter', category:'Personal' },
    { id:'p30', name:'Family - Parents', status:'Active', startDate:null, deadline:null, owner:'Shreyas', notes:'Both sets', category:'Personal' },
    { id:'p31', name:'Family', status:'Active', startDate:null, deadline:null, owner:'Shreyas', notes:'General family', category:'Personal' },
    
    // Personal - Home & Finance
    { id:'p32', name:'Finance', status:'Active', startDate:null, deadline:null, owner:'Shreyas', notes:'Investments, taxes, insurance', category:'Personal' },
    { id:'p33', name:'Home Renovations', status:'Active', startDate:null, deadline:null, owner:'Shreyas', notes:'Garden, kitchen, bathroom', category:'Personal' },
    { id:'p34', name:'Home - Minimalism', status:'Active', startDate:null, deadline:null, owner:'Shreyas', notes:'Purging, organizing', category:'Personal' },
    { id:'p35', name:'Office Setup', status:'Active', startDate:null, deadline:null, owner:'Shreyas', notes:'Veranda office', category:'Personal' },
    { id:'p36', name:'Home Office', status:'Active', startDate:null, deadline:null, owner:'Shreyas', notes:'Equipment, setup', category:'Personal' },
    
    // Personal - Life
    { id:'p37', name:'Events - Vacation', status:'Active', startDate:null, deadline:null, owner:'Shreyas', notes:'Family trips', category:'Personal' },
    { id:'p38', name:'Events - Date', status:'Active', startDate:null, deadline:null, owner:'Shreyas', notes:'Date nights', category:'Personal' },
    { id:'p39', name:'Events - Travel', status:'Active', startDate:null, deadline:null, owner:'Shreyas', notes:'Dubai March?', category:'Personal' },
    { id:'p40', name:'Events', status:'Active', startDate:null, deadline:null, owner:'Shreyas', notes:'Dates, birthdays', category:'Personal' },
    { id:'p41', name:'Relationships', status:'Active', startDate:null, deadline:null, owner:'Shreyas', notes:'Friends', category:'Personal' },
    { id:'p42', name:'Leisure', status:'Active', startDate:null, deadline:null, owner:'Shreyas', notes:'Gaming, hobbies', category:'Personal' },
    { id:'p43', name:'Transportation', status:'Active', startDate:null, deadline:null, owner:'Shreyas', notes:'Bike', category:'Personal' },
    { id:'p44', name:'Self-care', status:'Active', startDate:null, deadline:null, owner:'Shreyas', notes:'Skincare', category:'Personal' },
    { id:'p45', name:'Equipment', status:'Active', startDate:null, deadline:null, owner:'Shreyas', notes:'Mic, gear', category:'Personal' }
];

function init() {
    var stored = localStorage.getItem(STORAGE_KEY);
    if (stored) { 
        try {
            var data = JSON.parse(stored); 
            items = data.items || []; 
            projects = data.projects || DEFAULT_PROJECTS; 
        } catch(e) {
            items = [];
            projects = DEFAULT_PROJECTS;
        }
    } else if (typeof GTD_INITIAL_DATA !== 'undefined') { 
        items = GTD_INITIAL_DATA.map(function(item, i) { 
            var newItem = {};
            for (var key in item) { if (key !== 'context') newItem[key] = item[key]; }
            newItem.id = item.id || i + 1;
            return newItem;
        }); 
        projects = DEFAULT_PROJECTS; 
        save(); 
    } else {
        items = [];
        projects = DEFAULT_PROJECTS;
    }
    // Ensure projects is always an array
    if (!projects || !Array.isArray(projects)) {
        projects = DEFAULT_PROJECTS;
    }
    populateProjects(); render(); renderProjects(); updateStats(); setupListeners(); updateTokenStatus(); checkTokenWarning();
}

function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify({ items: items, projects: projects, lastModified: new Date().toISOString() })); }

function populateProjects() {
    if (!projects || !Array.isArray(projects)) return;
    var names = projects.map(function(p) { return p.name; }).sort();
    document.getElementById('f-project').innerHTML = '<option value="">None</option>' + names.map(function(n) { return '<option value="' + n + '">' + n + '</option>'; }).join('');
}

function render() {
    var list = document.getElementById('items-list');
    var filtered = items.filter(function(item) {
        if (item.status === 'Completed') return false;
        if (filters.status !== 'all' && item.status !== filters.status) return false;
        if (filters.priority && item.priority !== filters.priority) return false;
        if (filters.search) {
            var searchText = (item.item + ' ' + item.project + ' ' + item.notes).toLowerCase();
            if (searchText.indexOf(filters.search.toLowerCase()) === -1) return false;
        }
        return true;
    });
    var order = { Critical: 0, High: 1, Medium: 2, Low: 3 };
    filtered.sort(function(a, b) { return (order[a.priority] || 4) - (order[b.priority] || 4); });
    
    if (filtered.length) {
        var html = '';
        for (var i = 0; i < filtered.length; i++) {
            var item = filtered[i];
            html += '<div class="item" onclick="showDetail(' + item.id + ')">';
            html += '<div class="item-row"><div class="item-title">' + item.item + '</div><div class="item-priority ' + (item.priority || '').toLowerCase() + '"></div></div>';
            html += '<div class="item-meta">';
            if (item.project) html += '<span>' + item.project + '</span>';
            if (item.dueDate) html += '<span>Due: ' + formatDate(item.dueDate) + '</span>';
            if (item.waiting_for) html += '<span>Waiting: ' + item.waiting_for + '</span>';
            html += '</div></div>';
        }
        list.innerHTML = html;
    } else {
        list.innerHTML = '<p style="text-align:center;color:var(--text3);padding:40px;">No items</p>';
    }
}

function formatDate(d) { if (!d) return ''; return new Date(d).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }); }

function renderProjects() {
    var list = document.getElementById('projects-list');
    var activeProjects = projects.filter(function(p) { return p.status !== 'Completed'; });
    
    if (activeProjects.length === 0) {
        list.innerHTML = '<p style="text-align:center;color:var(--text3);padding:40px;">No projects</p>';
        return;
    }
    
    var html = '';
    for (var i = 0; i < activeProjects.length; i++) {
        var p = activeProjects[i];
        var tasks = items.filter(function(t) { return t.project === p.name && t.status !== 'Completed'; });
        var total = items.filter(function(t) { return t.project === p.name; }).length;
        var done = items.filter(function(t) { return t.project === p.name && t.status === 'Completed'; }).length;
        var progress = total > 0 ? Math.round((done / total) * 100) : 0;
        var daysLeft = p.deadline ? Math.ceil((new Date(p.deadline) - new Date()) / 86400000) : null;
        
        html += '<div class="proj-card" onclick="showProjectDetail(\'' + p.id + '\')">';
        html += '<div class="proj-header"><div class="proj-name">' + p.name + '</div><span class="proj-status ' + p.status.toLowerCase().replace(' ','-') + '">' + p.status + '</span></div>';
        html += '<div class="proj-body"><div class="proj-meta">';
        if (p.deadline) {
            html += '<div><span class="proj-meta-label">Deadline</span><br><span class="proj-meta-value' + (daysLeft < 14 ? ' danger' : '') + '">' + formatDate(p.deadline) + ' (' + daysLeft + 'd)</span></div>';
        }
        html += '<div><span class="proj-meta-label">Tasks</span><br><span class="proj-meta-value">' + tasks.length + ' active</span></div></div>';
        if (total > 0) {
            html += '<div class="proj-progress"><div class="proj-progress-bar" style="width:' + progress + '%"></div></div><div class="proj-tasks">' + progress + '% (' + done + '/' + total + ')</div>';
        }
        html += '</div></div>';
    }
    list.innerHTML = html;
}

function showProjectDetail(id) {
    var p = null;
    for (var i = 0; i < projects.length; i++) { if (projects[i].id === id) { p = projects[i]; break; } }
    if (!p) return;
    var tasks = items.filter(function(t) { return t.project === p.name && t.status !== 'Completed'; });
    
    var html = '<div class="modal-header"><div class="modal-title">' + p.name + '</div><button class="close-btn" onclick="closeProjectModal()">x</button></div>';
    html += '<div class="form">';
    html += '<div class="form-row"><div class="form-group"><label class="form-label">Status</label><select class="form-select" onchange="updateProject(\'' + id + '\',\'status\',this.value)">';
    html += '<option ' + (p.status==='Planning'?'selected':'') + '>Planning</option>';
    html += '<option ' + (p.status==='Active'?'selected':'') + '>Active</option>';
    html += '<option ' + (p.status==='On Hold'?'selected':'') + '>On Hold</option>';
    html += '<option ' + (p.status==='Completed'?'selected':'') + '>Completed</option></select></div>';
    html += '<div class="form-group"><label class="form-label">Category</label><select class="form-select" onchange="updateProject(\'' + id + '\',\'category\',this.value)">';
    html += '<option ' + (p.category==='Professional'?'selected':'') + '>Professional</option>';
    html += '<option ' + (p.category==='Personal'?'selected':'') + '>Personal</option></select></div></div>';
    html += '<div class="form-row"><div class="form-group"><label class="form-label">Start</label><input type="date" class="form-input" value="' + (p.startDate||'') + '" onchange="updateProject(\'' + id + '\',\'startDate\',this.value)"></div>';
    html += '<div class="form-group"><label class="form-label">Deadline</label><input type="date" class="form-input" value="' + (p.deadline||'') + '" onchange="updateProject(\'' + id + '\',\'deadline\',this.value)"></div></div>';
    html += '<div class="form-group"><label class="form-label">Owner</label><input class="form-input" value="' + (p.owner||'') + '" onchange="updateProject(\'' + id + '\',\'owner\',this.value)"></div>';
    html += '<div class="form-group"><label class="form-label">Stakeholders</label><input class="form-input" value="' + (p.stakeholders||'') + '" onchange="updateProject(\'' + id + '\',\'stakeholders\',this.value)"></div>';
    html += '<div class="form-group"><label class="form-label">Notes</label><input class="form-input" value="' + (p.notes||'') + '" onchange="updateProject(\'' + id + '\',\'notes\',this.value)"></div>';
    html += '<div class="section-title" style="margin-top:16px">Tasks (' + tasks.length + ')</div>';
    if (tasks.length) {
        for (var j = 0; j < tasks.length; j++) {
            var t = tasks[j];
            html += '<div class="item" onclick="showDetail(' + t.id + ');closeProjectModal()"><div class="item-row"><div class="item-title">' + t.item + '</div><div class="item-priority ' + (t.priority||'').toLowerCase() + '"></div></div></div>';
        }
    } else {
        html += '<p style="color:var(--text3)">No tasks</p>';
    }
    html += '<button class="btn btn-secondary danger" style="margin-top:20px" onclick="if(confirm(\'Delete?\')){deleteProject(\'' + id + '\')}">Delete Project</button>';
    html += '</div>';
    document.getElementById('project-content').innerHTML = html;
    document.getElementById('modal-project').classList.add('open');
}

function closeProjectModal() { document.getElementById('modal-project').classList.remove('open'); }
function updateProject(id, field, value) { 
    var p = null;
    for (var i = 0; i < projects.length; i++) { if (projects[i].id === id) { p = projects[i]; break; } }
    if (p) { p[field] = value; save(); renderProjects(); } 
}
function deleteProject(id) { projects = projects.filter(function(p) { return p.id !== id; }); save(); renderProjects(); closeProjectModal(); toast('Deleted'); }

function showAddProject() {
    var today = new Date().toISOString().split('T')[0];
    var html = '<div class="modal-header"><div class="modal-title">New Project</div><button class="close-btn" onclick="closeProjectModal()">x</button></div>';
    html += '<div class="form">';
    html += '<div class="form-group"><label class="form-label">Name</label><input class="form-input" id="np-name"></div>';
    html += '<div class="form-row"><div class="form-group"><label class="form-label">Status</label><select class="form-select" id="np-status"><option>Planning</option><option selected>Active</option></select></div>';
    html += '<div class="form-group"><label class="form-label">Category</label><select class="form-select" id="np-cat"><option>Professional</option><option>Personal</option></select></div></div>';
    html += '<div class="form-row"><div class="form-group"><label class="form-label">Start</label><input type="date" class="form-input" id="np-start" value="' + today + '"></div>';
    html += '<div class="form-group"><label class="form-label">Deadline</label><input type="date" class="form-input" id="np-deadline"></div></div>';
    html += '<div class="form-group"><label class="form-label">Owner</label><input class="form-input" id="np-owner" value="Shreyas"></div>';
    html += '<button class="btn btn-primary" style="width:100%" onclick="addProject()">Create</button>';
    html += '</div>';
    document.getElementById('project-content').innerHTML = html;
    document.getElementById('modal-project').classList.add('open');
}

function addProject() {
    var name = document.getElementById('np-name').value.trim(); if (!name) { toast('Enter name'); return; }
    projects.push({ id: 'p' + Date.now(), name: name, status: document.getElementById('np-status').value, category: document.getElementById('np-cat').value, startDate: document.getElementById('np-start').value || null, deadline: document.getElementById('np-deadline').value || null, owner: document.getElementById('np-owner').value });
    save(); renderProjects(); populateProjects(); closeProjectModal(); toast('Created');
}

function updateStats() {
    var active = items.filter(function(i) { return i.status !== 'Completed'; });
    document.getElementById('s-total').textContent = active.length;
    document.getElementById('s-critical').textContent = active.filter(function(i) { return i.priority === 'Critical'; }).length;
    document.getElementById('s-high').textContent = active.filter(function(i) { return i.priority === 'High'; }).length;
}

function showDetail(id) {
    var item = null;
    for (var i = 0; i < items.length; i++) { if (items[i].id === id) { item = items[i]; break; } }
    if (!item) return;
    var html = '<div class="modal-header"><div class="modal-title">Details</div><button class="close-btn" onclick="closeModal()">x</button></div>';
    html += '<div style="margin-bottom:20px"><div style="font-size:15px;line-height:1.5;margin-bottom:12px">' + item.item + '</div>';
    html += '<div style="font-size:13px;color:var(--text2)">' + item.priority + ' / ' + item.status + ' / ' + item.category + '</div></div>';
    html += '<div style="font-size:13px;color:var(--text2);line-height:1.8;margin-bottom:24px">';
    if (item.project) html += '<div>Project: ' + item.project + '</div>';
    if (item.dueDate) html += '<div>Due: ' + formatDate(item.dueDate) + '</div>';
    if (item.waiting_for) html += '<div>Waiting: ' + item.waiting_for + '</div>';
    if (item.notes) html += '<div>Notes: ' + item.notes + '</div>';
    html += '</div>';
    html += '<div class="btn-row"><button class="btn btn-primary" style="flex:1" onclick="complete(' + item.id + ')">Complete</button><button class="btn btn-secondary danger" onclick="deleteItem(' + item.id + ')">Delete</button></div>';
    document.getElementById('detail-content').innerHTML = html;
    document.getElementById('modal-detail').classList.add('open');
}

function closeModal() { document.getElementById('modal-detail').classList.remove('open'); }
function complete(id) { 
    var item = null;
    for (var i = 0; i < items.length; i++) { if (items[i].id === id) { item = items[i]; break; } }
    if (item) { item.status = 'Completed'; save(); render(); renderProjects(); updateStats(); closeModal(); toast('Done'); } 
}
function deleteItem(id) { if (confirm('Delete?')) { items = items.filter(function(i) { return i.id !== id; }); save(); render(); renderProjects(); updateStats(); closeModal(); toast('Deleted'); } }

function addItem() {
    var item = { id: Date.now(), item: document.getElementById('f-item').value.trim(), priority: document.getElementById('f-priority').value, status: document.getElementById('f-status').value, category: document.getElementById('f-category').value, project: document.getElementById('f-project').value, dueDate: document.getElementById('f-due').value || null, notes: document.getElementById('f-notes').value };
    if (!item.item) { toast('Enter task'); return; }
    items.unshift(item); save(); render(); renderProjects(); updateStats(); populateProjects();
    document.getElementById('f-item').value = ''; document.getElementById('f-notes').value = ''; document.getElementById('f-due').value = '';
    toast('Added');
}

function switchView(name) {
    var views = document.querySelectorAll('.view');
    for (var i = 0; i < views.length; i++) { views[i].classList.remove('active'); }
    var navBtns = document.querySelectorAll('.nav-btn');
    for (var j = 0; j < navBtns.length; j++) { navBtns[j].classList.remove('active'); }
    document.getElementById('v-' + name).classList.add('active');
    var targetBtn = document.querySelector('[data-v="' + name + '"]');
    if (targetBtn) targetBtn.classList.add('active');
}

// ========== AI VOICE CAPTURE ==========
var SR = window.SpeechRecognition || window.webkitSpeechRecognition;
var recognition = null, isRecording = false, recordingTime = 0, recordingTimer = null, transcript = '';

if (SR) {
    recognition = new SR(); 
    recognition.continuous = true; 
    recognition.interimResults = true;
    recognition.onresult = function(e) { 
        for (var i = e.resultIndex; i < e.results.length; i++) {
            if (e.results[i].isFinal) transcript += e.results[i][0].transcript + ' '; 
        }
        // Show live transcript
        if (transcript.trim()) {
            document.getElementById('mic-status').textContent = 'Listening: "' + transcript.slice(-50) + (transcript.length > 50 ? '...' : '') + '"';
        }
    };
    recognition.onend = function() { if (isRecording) recognition.start(); };
    recognition.onerror = function(e) { 
        console.error('Speech error:', e.error);
        if (e.error === 'not-allowed') {
            document.getElementById('mic-status').textContent = 'Microphone access denied';
        }
    };
}

// Check for token on page load
function checkTokenWarning() {
    var warning = document.getElementById('token-warning');
    if (warning) {
        warning.style.display = getGitHubToken() ? 'none' : 'block';
    }
}

document.getElementById('mic-btn').onclick = function() { 
    if (!recognition) { toast('Speech not supported in this browser'); return; } 
    if (isRecording) stopRecording(); else startRecording(); 
};

function startRecording() {
    isRecording = true; recordingTime = 0; transcript = '';
    var micArea = document.getElementById('mic-area');
    var micBtn = document.getElementById('mic-btn');
    
    micArea.classList.add('recording');
    micBtn.classList.add('recording'); 
    micBtn.textContent = 'Stop';
    document.getElementById('mic-status').textContent = 'Listening...'; 
    document.getElementById('mic-time').textContent = '0:00';
    document.getElementById('result-box').style.display = 'none';
    
    recognition.start();
    recordingTimer = setInterval(function() { 
        recordingTime++; 
        var mins = Math.floor(recordingTime/60);
        var secs = recordingTime % 60;
        document.getElementById('mic-time').textContent = mins + ':' + (secs < 10 ? '0' : '') + secs;
    }, 1000);
}

function stopRecording() {
    isRecording = false; 
    recognition.stop(); 
    clearInterval(recordingTimer);
    
    var micArea = document.getElementById('mic-area');
    var micBtn = document.getElementById('mic-btn');
    
    micArea.classList.remove('recording');
    micBtn.classList.remove('recording'); 
    micBtn.textContent = 'Start';
    
    if (!transcript.trim()) { 
        document.getElementById('mic-status').textContent = 'No speech detected. Tap to try again.'; 
        return; 
    }
    
    micArea.classList.add('processing');
    document.getElementById('mic-status').textContent = 'Processing with AI...';
    document.getElementById('result-box').style.display = 'block';
    document.getElementById('result-content').innerHTML = '<div style="text-align:center;padding:20px;color:var(--text2)">Analyzing your recording...</div>';
    
    processWithAI(transcript);
}

function processWithAI(text) {
    var token = getGitHubToken();
    var micArea = document.getElementById('mic-area');
    
    if (!token) {
        micArea.classList.remove('processing');
        document.getElementById('mic-status').textContent = 'Tap to start recording';
        document.getElementById('result-content').innerHTML = '<div style="color:var(--critical);text-align:center;padding:20px;"><div style="font-weight:600;margin-bottom:8px;">AI not configured</div><div style="font-size:13px;">Go to Settings → GitHub Token to enable smart capture.<br><br>Using basic mode for now...</div></div>';
        setTimeout(function() { fallbackProcess(text); }, 1500);
        return;
    }
    
    console.log('Voice transcript:', text);
    
    var projectList = projects.map(function(p) { return p.name; }).join(', ');
    var existingTasks = items.filter(function(i) { return i.status !== 'Completed'; }).slice(0, 20).map(function(i) { return '"' + i.item.substring(0, 40) + '"'; }).join(', ');
    
    var prompt = 'You are a GTD task assistant. Extract actions from natural voice recordings.\n\n' +
        'USER CAN:\n' +
        '1. ADD tasks: "I need to...", "Remind me to...", "Add...", "Want to...", any action mentioned\n' +
        '2. COMPLETE tasks: "I finished...", "Done with...", "Completed...", "Already did..."\n' +
        '3. DELETE tasks: "Remove...", "Delete...", "Cancel...", "Nevermind about..."\n' +
        '4. UPDATE priority: "Make X urgent", "X is high priority"\n\n' +
        'RULES:\n' +
        '- Extract EVERY action as a separate item\n' +
        '- Split compound statements: "call X and email Y" = 2 actions\n' +
        '- Clean up filler words but keep meaning\n' +
        '- Match projects when mentioned: ' + projectList + '\n' +
        '- Match completions/deletions to these existing tasks: ' + existingTasks + '\n\n' +
        'PRIORITY: Critical (urgent/ASAP), High (important), Medium (default), Low (someday)\n\n' +
        'RESPOND WITH ONLY THIS JSON:\n' +
        '{"actions":[...],"summary":"Brief description"}\n\n' +
        'Action types:\n' +
        '{"type":"add","task":"clean task text","project":"project name or null","priority":"Medium"}\n' +
        '{"type":"complete","match":"keywords to find the task"}\n' +
        '{"type":"delete","match":"keywords to find the task"}\n' +
        '{"type":"priority","match":"keywords","priority":"High"}';

    fetch(GITHUB_MODELS_URL, {
        method: 'POST',
        headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            model: MODEL,
            messages: [
                { role: 'system', content: prompt },
                { role: 'user', content: 'Voice recording:\n\n"' + text + '"\n\nExtract all actions (add, complete, delete, priority changes):' }
            ],
            temperature: 0.1,
            max_tokens: 2000
        })
    })
    .then(function(response) {
        if (!response.ok) {
            return response.text().then(function(errText) {
                console.error('API Error:', response.status, errText);
                throw new Error('API error ' + response.status + '. Check your GitHub token in Settings.');
            });
        }
        return response.json();
    })
    .then(function(data) {
        var content = data.choices[0].message.content;
        console.log('AI Response:', content);
        
        var json;
        try {
            var codeBlock = content.match(/```json\s*([\s\S]*?)\s*```/) || content.match(/```\s*([\s\S]*?)\s*```/);
            json = JSON.parse(codeBlock ? codeBlock[1] : content);
        } catch (e) {
            var objMatch = content.match(/\{[\s\S]*\}/);
            if (objMatch) json = JSON.parse(objMatch[0]);
            else throw new Error('Could not parse AI response');
        }
        
        executeActions(json.actions || [], text, json.summary || '');
    })
    .catch(function(error) {
        console.error('AI Error:', error);
        document.getElementById('result-content').innerHTML = '<div style="color:var(--critical)">AI error: ' + error.message + '</div><div style="margin-top:8px">Trying basic mode...</div>';
        setTimeout(function() { fallbackProcess(text); }, 1000);
    });
}

function executeActions(actions, transcript, interpretation) {
    transcript = transcript || '';
    interpretation = interpretation || '';
    var added = 0, completed = 0, deleted = 0, updated = 0;
    var actionLog = [];
    
    actions.forEach(function(action) {
        if (action.type === 'add' && action.task) {
            var proj = null;
            if (action.project) {
                proj = projects.find(function(p) { return p.name.toLowerCase().indexOf(action.project.toLowerCase()) > -1; });
            }
            items.unshift({
                id: Date.now() + Math.random(),
                item: action.task,
                priority: action.priority || 'Medium',
                status: action.waiting_for ? 'Waiting For' : 'Next Action',
                category: proj ? proj.category : 'Personal',
                project: proj ? proj.name : '',
                waiting_for: action.waiting_for || '',
                notes: ''
            });
            added++;
            var priColor = action.priority === 'Critical' ? 'var(--critical)' : action.priority === 'High' ? 'var(--high)' : 'var(--accent)';
            actionLog.push('<span style="color:' + priColor + '">+</span> ' + action.task + (proj ? ' <span style="color:var(--text3)">→ ' + proj.name + '</span>' : ''));
        }
        else if (action.type === 'complete' && action.match) {
            var matchItem = items.find(function(i) { return i.status !== 'Completed' && i.item.toLowerCase().indexOf(action.match.toLowerCase()) > -1; });
            if (matchItem) { 
                matchItem.status = 'Completed'; 
                completed++; 
                actionLog.push('<span style="color:var(--low)">✓</span> Completed: ' + matchItem.item); 
            } else {
                actionLog.push('<span style="color:var(--text3)">?</span> Could not find: "' + action.match + '"');
            }
        }
        else if (action.type === 'delete' && action.match) {
            var idx = -1;
            for (var i = 0; i < items.length; i++) {
                if (items[i].item.toLowerCase().indexOf(action.match.toLowerCase()) > -1) { idx = i; break; }
            }
            if (idx > -1) { 
                var removed = items.splice(idx, 1)[0]; 
                deleted++; 
                actionLog.push('<span style="color:var(--critical)">✗</span> Deleted: ' + removed.item); 
            } else {
                actionLog.push('<span style="color:var(--text3)">?</span> Could not find: "' + action.match + '"');
            }
        }
        else if (action.type === 'priority' && action.match) {
            var prioItem = items.find(function(i) { return i.status !== 'Completed' && i.item.toLowerCase().indexOf(action.match.toLowerCase()) > -1; });
            if (prioItem && action.priority) { 
                prioItem.priority = action.priority; 
                updated++; 
                actionLog.push('<span style="color:var(--high)">↑</span> Priority → ' + action.priority + ': ' + prioItem.item); 
            }
        }
    });
    
    save(); render(); renderProjects(); updateStats(); populateProjects();
    
    // Reset mic area
    var micArea = document.getElementById('mic-area');
    micArea.classList.remove('processing');
    document.getElementById('mic-status').textContent = 'Tap to start recording';
    
    // Build result display
    var html = '';
    if (actionLog.length) {
        var totalActions = added + completed + deleted + updated;
        var summary = [];
        if (added) summary.push(added + ' added');
        if (completed) summary.push(completed + ' completed');
        if (deleted) summary.push(deleted + ' deleted');
        if (updated) summary.push(updated + ' updated');
        
        html = '<div class="result-count">' + totalActions + '</div>';
        html += '<div class="result-label">' + summary.join(', ') + '</div>';
        html += '<div class="result-actions">';
        for (var i = 0; i < actionLog.length; i++) {
            html += '<div>' + actionLog[i] + '</div>';
        }
        html += '</div>';
    } else {
        html = '<div style="text-align:center;padding:20px;"><div style="font-size:18px;margin-bottom:8px;">No actions found</div><div style="color:var(--text3);font-size:13px;">Try being more specific, like "Add call John" or "I finished the report"</div></div>';
    }
    
    // Show transcript for reference
    if (transcript) {
        html += '<div class="result-transcript"><b>You said:</b> "' + transcript + '"</div>';
    }
    if (interpretation) {
        html += '<div style="font-size:11px;color:var(--text3);margin-top:4px">' + interpretation + '</div>';
    }
    
    document.getElementById('result-content').innerHTML = html;
}

function fallbackProcess(text) {
    var chunks = text.split(/[.!?]+/).filter(function(s) { return s.trim().length > 5; });
    var added = 0;
    
    chunks.forEach(function(chunk) {
        var lower = chunk.toLowerCase();
        if (/finished|completed|done|checked off/.test(lower)) return;
        
        var taskText = chunk.trim().replace(/^(i need to|have to|should|must|want to)\s*/i, '');
        taskText = taskText.charAt(0).toUpperCase() + taskText.slice(1);
        
        var task = { 
            id: Date.now() + Math.random(), 
            item: taskText, 
            priority: 'Medium', 
            status: 'Next Action', 
            category: 'Personal', 
            project: '', 
            notes: '' 
        };
        
        if (/urgent|critical|asap/.test(lower)) task.priority = 'Critical';
        else if (/important|priority/.test(lower)) task.priority = 'High';
        
        if (/work|office|client|project/.test(lower)) task.category = 'Professional';
        
        for (var i = 0; i < projects.length; i++) {
            var p = projects[i];
            if (lower.indexOf(p.name.toLowerCase().split(' ')[0].toLowerCase()) > -1) { 
                task.project = p.name; 
                task.category = p.category; 
                break; 
            }
        }
        
        if (task.item.length > 5) { items.unshift(task); added++; }
    });
    
    save(); render(); updateStats();
    document.getElementById('mic-status').textContent = 'Tap to start';
    document.getElementById('result-content').innerHTML = '<div class="result-count">' + added + '</div><div class="result-label">tasks added (basic mode)</div>';
}

// ========== EXPORT/IMPORT ==========
function exportJSON() { 
    var blob = new Blob([JSON.stringify({ items: items, projects: projects }, null, 2)], { type: 'application/json' }); 
    var a = document.createElement('a'); 
    a.href = URL.createObjectURL(blob); 
    a.download = 'gtd-backup.json'; 
    a.click(); 
    toast('Downloaded'); 
}
function importJSON(file) { 
    if (!file) return; 
    var reader = new FileReader(); 
    reader.onload = function(e) { 
        try { 
            var data = JSON.parse(e.target.result); 
            if (data.items) items = data.items; 
            if (data.projects) projects = data.projects; 
            save(); render(); renderProjects(); updateStats(); populateProjects(); 
            toast('Imported'); 
        } catch (err) { 
            toast('Invalid file'); 
        } 
    }; 
    reader.readAsText(file); 
}
function clearCompleted() { if (confirm('Clear completed?')) { items = items.filter(function(i) { return i.status !== 'Completed'; }); save(); render(); updateStats(); toast('Cleared'); } }
function reloadSampleData() { 
    if (confirm('Reload all 101 sample items? This will replace your current data.')) { 
        if (typeof GTD_INITIAL_DATA !== 'undefined') {
            items = GTD_INITIAL_DATA.map(function(item, i) { 
                var newItem = {};
                for (var key in item) { if (key !== 'context') newItem[key] = item[key]; }
                newItem.id = item.id || i + 1;
                return newItem;
            });
            projects = DEFAULT_PROJECTS;
            save(); render(); renderProjects(); updateStats(); populateProjects();
            toast('Loaded 101 items');
        } else {
            toast('Sample data not available');
        }
    } 
}
function resetAll() { if (confirm('Reset all?')) { localStorage.removeItem(STORAGE_KEY); location.reload(); } }
function toast(msg) { var t = document.getElementById('toast'); t.textContent = msg; t.classList.add('show'); setTimeout(function() { t.classList.remove('show'); }, 2000); }

function setupListeners() {
    var tabs = document.querySelectorAll('.tab');
    for (var i = 0; i < tabs.length; i++) {
        (function(tab) {
            tab.onclick = function() {
                var allTabs = document.querySelectorAll('.tab');
                for (var j = 0; j < allTabs.length; j++) { allTabs[j].classList.remove('active'); }
                tab.classList.add('active');
                filters.status = tab.dataset.status;
                render();
            };
        })(tabs[i]);
    }
    
    var filterBtns = document.querySelectorAll('.filter[data-p]');
    for (var k = 0; k < filterBtns.length; k++) {
        (function(btn) {
            btn.onclick = function() {
                var wasActive = btn.classList.contains('active');
                var allFilters = document.querySelectorAll('.filter[data-p]');
                for (var m = 0; m < allFilters.length; m++) { allFilters[m].classList.remove('active'); }
                filters.priority = wasActive ? null : btn.dataset.p;
                if (!wasActive) btn.classList.add('active');
                render();
            };
        })(filterBtns[k]);
    }
    
    document.getElementById('search').oninput = function(e) { filters.search = e.target.value; render(); };
    
    var navBtns = document.querySelectorAll('.nav-btn');
    for (var n = 0; n < navBtns.length; n++) {
        (function(btn) {
            btn.onclick = function() { switchView(btn.dataset.v); };
        })(navBtns[n]);
    }
    
    document.getElementById('modal-detail').onclick = function(e) { if (e.target.id === 'modal-detail') closeModal(); };
    document.getElementById('modal-project').onclick = function(e) { if (e.target.id === 'modal-project') closeProjectModal(); };
}
</script>
</body>
</html>
